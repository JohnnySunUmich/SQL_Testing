(SELECT sub.username, sub.activity, sub.startDate, sub.endDate FROM (SELECT a.*, RANK() OVER (PARTITION BY a.username ORDER BY a.startDate DESC) AS rank_date FROM UserActivity a) sub WHERE sub.rank_date = 2) UNION ALL (SELECT * FROM UserActivity GROUP BY username HAVING COUNT(username) = 1)
(select username, activity, startDate, endDate from (select *, rank() over(partition by username order by enddate desc) as myrank from useractivity) cte where myrank=2) union (select * from UserActivity group by 1 having count(username)=1)
SELECT * FROM UserActivity GROUP BY username HAVING COUNT(*) = 1 UNION ALL SELECT u1.* FROM UserActivity u1 LEFT JOIN UserActivity u2 ON u1.username = u2.username AND u1.endDate < u2.endDate GROUP BY u1.username, u1.endDate HAVING COUNT(u2.endDate) = 1
SELECT * FROM UserActivity GROUP BY username HAVING COUNT(*) = 1 UNION SELECT u1.* FROM UserActivity u1 LEFT JOIN UserActivity u2 ON u1.username = u2.username AND u1.endDate < u2.endDate GROUP BY u1.username, u1.endDate HAVING COUNT(u2.endDate) = 1
SELECT Username, activity, startDate, endDate FROM (SELECT (SELECT COUNT(DISTINCT a.startdate)+1 FROM UserActivity a WHERE a.username=b.username and a.startdate>b.startdate) rno, (SELECT COUNT(DISTINCT c.activity,c.startDate,c.endDate) FROM UserActivity c WHERE b.username=c.username) useractivitycount, Username, activity, startDate, endDate FROM UserActivity b)t WHERE (rno=2 and useractivitycount>=2) OR (rno=1 and useractivitycount=1)
SELECT a.username, a.activity, a.startDate, a.endDate FROM UserActivity a JOIN ( SELECT a.username, COALESCE(MAX(b.startDate), a.startDate) as startDate, COALESCE(MAX(b.endDate), a.endDate) as endDate FROM UserActivity a LEFT JOIN UserActivity b ON a.username=b.username AND a.startDate > b.startDate GROUP BY 1 ) b ON a.username=b.username AND a.startDate=b.startDate
SELECT username ,activity ,startDate ,endDate FROM ( SELECT username ,activity ,startDate ,endDate ,RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS ranks ,COUNT(activity) OVER(PARTITION BY username) AS counts FROM UserActivity ) t WHERE counts = 1 OR ranks = 2
SELECT username USERNAME, activity ACTIVITY, startDate STARTDATE, endDate ENDDATE FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY username ORDER BY startDate desc) AS recent_rank, COUNT(activity) OVER (PARTITION BY username) AS cnt FROM UserActivity ) ranked WHERE recent_rank = 2 OR cnt < 2
SELECT username, activity, startDate, endDate FROM ( SELECT *,COUNT(startDate) AS cnt FROM UserActivity GROUP BY username ) Users_with_activity_counts WHERE cnt=1 UNION SELECT username, activity, startDate, endDate FROM ( SELECT *, row_number()OVER(PARTITION BY username ORDER BY startDate DESC) AS rn FROM UserActivity ) Users_with_row_number WHERE rn=2
SELECT username, activity, startDate, endDate FROM ( SELECT *,COUNT(startDate) AS cnt FROM UserActivity GROUP BY username ) Users_with_one_activity WHERE cnt=1 UNION SELECT username, activity, startDate, endDate FROM ( SELECT *, row_number()OVER(PARTITION BY username ORDER BY startDate DESC) AS rn FROM UserActivity ) Users_with_row_number WHERE rn=2
SELECT username, activity, startDate, endDate FROM ( SELECT username, activity, startDate, endDate, RANK() OVER (PARTITION BY username ORDER BY endDate ASC) AS activityOrderASC FROM ( SELECT username, activity, startDate, endDate, RANK() OVER (PARTITION BY username ORDER BY endDate DESC) AS activityOrderDesc FROM UserActivity) temp WHERE activityOrderDesc <= 2) temp2 WHERE activityOrderASC = 1
SELECT username, activity, startDate, endDate FROM ( SELECT username, activity, startDate, endDate, RANK() OVER(PARTITION BY username ORDER BY endDate DESC) AS date_rank FROM UserActivity ) sub WHERE date_rank = 2 UNION SELECT username, activity, startDate, endDate FROM UserActivity WHERE username IN (SELECT username FROM UserActivity GROUP BY 1 HAVING COUNT(*) = 1)
SELECT username, activity, startDate, endDate FROM ( SELECT username, activity, startDate, endDate, RANK() OVER(PARTITION BY username ORDER BY endDate DESC) AS rank_recent, COUNT(activity) OVER(PARTITION BY username) AS count_activity FROM UserActivity ) activity_rank WHERE rank_recent = 2 OR count_activity = 1
SELECT username, activity, startDate, endDate FROM ( SELECT username, activity, startDate, endDate, ROW_NUMBER() OVER (PARTITION BY username ORDER BY startDate DESC) rnk FROM UserActivity ) tmp WHERE rnk = 2 GROUP BY username UNION SELECT * FROM UserActivity GROUP BY username HAVING COUNT(*) = 1
SELECT username, activity, startDate, endDate FROM (SELECT *, COUNT(activity) OVER(PARTITION BY username) AS cnt, ROW_NUMBER() OVER(PARTITION BY username ORDER BY startDate DESC) AS n FROM UserActivity) temp WHERE n=2 OR cnt<2
SELECT username, activity, startDate, endDate FROM (SELECT *, DENSE_RANK() OVER (PARTITION BY username ORDER BY startDate DESC) AS rk FROM UserActivity) temp WHERE rk = 2 UNION SELECT username, activity, startDate, endDate FROM UserActivity WHERE username IN (SELECT username FROM UserActivity GROUP BY username HAVING COUNT(*) < 2 )
SELECT username, activity, startDate, endDate FROM (SELECT *, RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS rnk FROM UserActivity) T WHERE rnk = 2 UNION SELECT * FROM UserActivity GROUP BY username HAVING COUNT(activity) = 1
SELECT username, activity, startDate, endDate FROM (SELECT *, RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS rnk_desc, RANK() OVER(PARTITION BY username ORDER BY startDate) AS rnk_asc FROM UserActivity) t WHERE rnk_desc=2 OR (rnk_desc=1 AND rnk_asc=1)
SELECT username, activity, startDate, endDate FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY username ORDER BY startDate DESC) AS rk, COUNT(*) OVER (PARTITION BY username) AS tot FROM UserActivity ) sub WHERE (tot > 1 AND rk = 2) OR tot=1
SELECT username, activity, startDate, endDate FROM (SELECT username, activity, startDate, endDate, row_number() OVER(PARTITION BY username ORDER BY startDate DESC) rownum, COUNT(*) OVER(PARTITION BY username) cnt FROM UserActivity) AS temp WHERE IF(cnt=1, rownum=1, rownum=2)
SELECT username,activity,startDate,endDate FROM (SELECT username,activity,startDate,endDate, DENSE_RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS ranking_desc, DENSE_RANK() OVER(PARTITION BY username ORDER BY startDate ASC) AS ranking_asc FROM UserActivity) sub WHERE ranking_desc = 2 OR (ranking_desc = ranking_asc AND ranking_asc = 1) ORDER BY username
Select username, activity, startDate, endDate from ( Select *, row_number() Over(partition by username order by startDate Desc) AS rnk, Count(username) Over(partition by username) as total from UserActivity ) a where rnk = (Case when total = 1 Then 1 else 2 end)
WITH ActivityRanking AS (SELECT username ,activity ,startDate ,endDate ,RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS Rk ,(SELECT COUNT(*) FROM UserActivity I WHERE I.username = O.username) AS Counter FROM UserActivity O ) SELECT username ,activity ,startDate ,endDate FROM ActivityRanking WHERE Rk = IF(Counter>1,2,1)
WITH CTE AS( SELECT *, COUNT(activity) OVER(PARTITION BY username) AS cnt, RANK()OVER(PARTITION BY username ORDER BY startDate DESC) as rk FROM UserActivity ) SELECT username, activity, startDate, endDate FROM CTE WHERE rk = 2 OR cnt <2
WITH CTE_1 AS ( SELECT USERNAME, COUNT(*) USER_COUNT FROM USERACTIVITY GROUP BY USERNAME ) ,CTE_2 AS ( SELECT U.USERNAME, MAX(U.STARTDATE) SEC_MOST_REC_DATE FROM USERACTIVITY U, CTE_1 C WHERE U.USERNAME = C.USERNAME AND C.USER_COUNT > 1 AND U.STARTDATE < ( SELECT MAX(STARTDATE) FROM USERACTIVITY UU WHERE UU.USERNAME = U.USERNAME ) GROUP BY U.USERNAME ) SELECT U.* FROM USERACTIVITY U, CTE_2 C2 WHERE U.USERNAME = C2.USERNAME AND U.STARTDATE = C2.SEC_MOST_REC_DATE UNION SELECT U.* FROM USERACTIVITY U, CTE_1 C1 WHERE U.USERNAME = C1.USERNAME AND C1.USER_COUNT = 1
WITH Cte AS ( SELECT UserActivity.*, COUNT(username) OVER (PARTITION BY username) AS CountUserActivity, RANK() OVER (PARTITION BY username ORDER BY startDate DESC) AS RankUserActivity FROM UserActivity ) SELECT Cte.username AS "USERNAME", Cte.activity AS "ACTIVITY", Cte.startDate AS "STARTDATE", Cte.endDate AS"ENDDATE" FROM Cte WHERE CountUserActivity = 1 UNION SELECT Cte.username AS "USERNAME", Cte.activity AS "ACTIVITY", Cte.startDate AS "STARTDATE", Cte.endDate AS"ENDDATE" FROM Cte WHERE CountUserActivity > 1 AND RankUserActivity = 2
WITH RankedActivity AS ( SELECT username, startDate, RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS activityRank FROM UserActivity ), Results AS ( SELECT username, MIN(startDate) AS activityDate FROM RankedActivity WHERE activityRank <= 2 GROUP BY username ) SELECT UserActivity.username, UserActivity.activity, UserActivity.startDate, UserActivity.endDate FROM Results INNER JOIN UserActivity ON UserActivity.username = Results.username AND UserActivity.startDate = Results.activityDate
WITH S0 AS (SELECT username, activity, startDate, endDate FROM UserActivity GROUP BY username HAVING COUNT(activity) = 1), S1 AS (SELECT username, activity, startDate, endDate FROM UserActivity WHERE username NOT IN (SELECT DISTINCT(username) FROM S0)), S2 AS (SELECT DISTINCT username, NTH_VALUE(startDate, 2) OVER (PARTITION BY username ORDER BY startDate DESC) AS startDate FROM S1) SELECT S2.username, activity, S2.startDate, endDate FROM S2 INNER JOIN UserActivity ON S2.username = UserActivity.username AND s2.startDate = UserActivity.startDate UNION SELECT username, activity, startDate, endDate FROM S0
WITH T AS ( SELECT username, activity, startDate, endDate, RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS ranking FROM UserActivity ) SELECT * FROM UserActivity WHERE username IN ( SELECT username FROM UserActivity GROUP BY username HAVING COUNT(*)=1 ) UNION SELECT username, activity, startDate, endDate FROM T WHERE ranking=2
WITH TEMP AS ( SELECT *, RANK() OVER (PARTITION BY username ORDER BY startDate DESC) AS rnk, COUNT(*) OVER (PARTITION BY username) AS cnt FROM UserActivity ) SELECT username, activity, startDate, endDate FROM TEMP WHERE rnk = 2 OR cnt = 1
WITH UARanking AS (SELECT UA.* ,RANK() OVER(PARTITION BY UA.username ORDER BY UA.startDate DESC) AS Rk ,(SELECT COUNT(*) FROM UserActivity I WHERE I.username = UA.username) AS counter FROM UserActivity UA) SELECT username ,activity ,startDate ,endDate FROM UARanking WHERE Rk = IF(Counter = 1,1,2)
WITH UserActivity2 AS (SELECT *, RANK() OVER(PARTITION BY username ORDER BY startDate DESC) RNK FROM UserActivity) SELECT username, activity, startDate, endDate FROM UserActivity2 WHERE RNK = 2 UNION (SELECT * FROM UserActivity GROUP BY username HAVING COUNT(username) = 1)
WITH a AS ( SELECT *, RANK() OVER (PARTITION BY username ORDER BY endDate ASC) rnk FROM UserActivity ), b AS ( SELECT username, IF(MAX(rnk)=1,2,MAX(rnk)) rnk FROM a GROUP BY username ) SELECT a.username, a.activity, a.startDate, a.endDate FROM a JOIN b ON a.rnk = b.rnk-1 AND a.username = b.username
WITH abc as (SELECT * FROM UserActivity t Join (SELECT t.username,max(t.startDate) startDate from UserActivity t join (Select username,max(startDate) startDate from UserActivity group by username) u ON u.username = t.username AND u.startDate <> t.startDate Group by t.username) u USING (username,startDate)) SELECT * FROM abc UNION SELECT u.username,u.activity,u.startDate,u.endDate FROM UserActivity u left join abc a ON a.username=u.username where a.username is NULL
WITH activities_by_recency AS (SELECT username, activity, startDate, endDate, RANK() OVER (PARTITION BY username ORDER BY endDate DESC) AS recency FROM UserActivity ua), num_activites_by_user AS (SELECT username, COUNT(*) num_activities FROM UserActivity ua GROUP BY username HAVING num_activities = 1 ) SELECT username, activity, startDate, endDate FROM activities_by_recency WHERE recency = 2 UNION SELECT n.username, ua.activity, ua.startDate, ua.endDate FROM num_activites_by_user n INNER JOIN UserActivity ua ON n.username = ua.username
WITH activity_order AS ( SELECT *, ROW_NUMBER() OVER(PARTITION BY username ORDER BY endDate DESC) AS row_num FROM UserActivity), second AS( SELECT * FROM activity_order WHERE row_num = 2 ) SELECT * FROM UserActivity WHERE username NOT IN( SELECT DISTINCT username FROM second ) UNION SELECT username, activity, startDate, endDate FROM second
WITH activity_w_rank AS ( SELECT *, ROW_NUMBER() OVER(PARTITION BY username ORDER BY startDate DESC) AS order_id, COUNT(activity) OVER(PARTITION BY username) AS activity_cnt FROM UserActivity ) SELECT username, activity, startdate, enddate FROM activity_w_rank WHERE order_id = 2 OR activity_cnt = 1
WITH agg as (SELECT *, RANK() OVER (PARTITION BY username ORDER BY startDate desc) as rk FROM UserActivity) SELECT a.username, b.activity, b.startDate, b.endDate FROM (SELECT username, max(rk) as selected_rk FROM agg WHERE rk <= 2 GROUP BY username) a LEFT JOIN (SELECT username, activity, startDate, endDate, rk FROM agg) b ON a.username = b.username AND a.selected_rk = b.rk
WITH cte AS ( SELECT username, activity, startDate, endDate, rank() over (partition by username order by startdate DESC)as rk, count(username) over (partition by username) as cnt FROM useractivity ) SELECT username, activity, startDate, endDate FROM cte WHERE rk = CASE WHEN cnt >=2 THEN 2 WHEN cnt <2 THEN 1 END
WITH cte AS ( SELECT username, activity, startDate, endDate, rnk FROM (SELECT username, activity, startDate, endDate, RANK() OVER (PARTITION BY username ORDER BY startDate DESC) AS rnk FROM UserActivity) t1 WHERE t1.rnk <= 2) SELECT username, activity, startDate, endDate FROM cte WHERE (username, rnk) IN (SELECT username, MAX(rnk) FROM cte GROUP BY username)
WITH cte AS (SELECT *, DENSE_RANK() OVER (PARTITION BY username ORDER BY startDate DESC) AS rk, COUNT(*) OVER(PARTITION BY username) AS cnt FROM UserActivity) SELECT username , activity , startDate , endDate FROM cte WHERE rk = 2 OR cnt = 1
WITH cte AS( SELECT username,activity,startDate,endDate,dense_rank()over(partition by username order by endDate DESC) as ranks FROM UserActivity ), cte1 AS( SELECT username,count(*) as counts FROM UserActivity GROUP BY username) SELECT username,activity,startDate,endDate FROM(SELECT cte.username,activity,startDate,endDate,ranks,counts FROM cte LEFT JOIN cte1 ON cte1.username = cte.username)a WHERE ranks = 2 AND counts >=2 UNION ALL SELECT username,activity,startDate,endDate FROM(SELECT cte.username,activity,startDate,endDate,ranks,counts FROM cte LEFT JOIN cte1 ON cte1.username = cte.username)a WHERE counts =1
WITH cte AS( SELECT username,activity,startDate,endDate,dense_rank()over(partition by username order by endDate DESC) as ranks FROM UserActivity ), cte1 AS( SELECT username,count(*) as counts FROM UserActivity GROUP BY username) SELECT username,activity,startDate,endDate FROM(SELECT cte.username,activity,startDate,endDate,ranks,counts FROM cte LEFT JOIN cte1 ON cte1.username = cte.username)a WHERE ranks = 2 AND counts >=2 UNION ALL SELECT username,activity,startDate,endDate FROM(SELECT cte.username,activity,startDate,endDate,ranks,counts FROM cte LEFT JOIN cte1 ON cte1.username = cte.username)a WHERE ranks = 1 AND counts =1
WITH filter_table AS ( SELECT * FROM (SELECT * , DENSE_RANK() OVER(PARTITION BY username ORDER BY endDate DESC) AS activity_rank FROM UserActivity ) a WHERE activity_rank <=2) SELECT username , activity , startDate , endDate FROM filter_table WHERE (username, activity_rank) IN( SELECT username, MAX(activity_rank) FROM filter_table GROUP BY username )
WITH firstTable as ( SELECT username, activity, startDate, endDate, rank() over(PARTITION BY username ORDER BY startDate DESC) as ranking FROM UserActivity ), secondTable as ( SELECT username, activity, startDate, endDate FROM firstTable WHERE ranking=2 ), thirdTable as ( SELECT UserActivity.username, UserActivity.activity, UserActivity.startDate, UserActivity.endDate FROM UserActivity Left Outer JOIN secondTable ON UserActivity.username=secondTable.username WHERE secondTable.username IS NULL ) SELECT * FROM secondTable UNION SELECT * FROM thirdTable
WITH one_activity AS ( SELECT username FROM UserActivity GROUP BY username HAVING COUNT(*) = 1), Ranked AS ( SELECT username, activity, startDate, endDate, RANK() OVER(PARTITION BY username ORDER BY startDate DESC) recency FROM UserActivity) SElECT username,activity,startDate,endDate FROM Ranked WHERE recency = 2 UNION SELECT username,activity,startDate,endDate FROM Ranked WHERE username IN (SELECT username FROM one_activity)
WITH rnk AS ( SELECT *, RANK() OVER(PARTITION BY username ORDER BY endDate DESC) rk FROM UserActivity ) , cnt AS ( SELECT username, COUNT(username) num FROM UserActivity GROUP BY username) SELECT rnk.username, activity, startDate, endDate FROM rnk JOIN cnt c ON c.username = rnk.username WHERE (num=1 AND rk=1) OR (num>1 AND rk=2)
WITH t AS ( SELECT *, ROW_NUMBER() OVER(PARTITION BY username ORDER BY startDate DESC) AS r, COUNT(*) OVER(PARTITION BY username) AS c FROM UserActivity ) SELECT username, activity, startDate, endDate FROM t WHERE c = 1 OR r = 2
WITH t AS ( SELECT username,activity,startDate, endDate, ROW_NUMBER() OVER (PARTITION BY username ORDER BY startDate desc) rn, COUNT(username) OVER (PARTITION BY username ) num_activity FROM UserActivity ) SELECT username,activity,startDate, endDate FROM t WHERE CASE WHEN num_activity=1 THEN rn=1 ELSE rn=2 END
WITH table1 AS( SELECT username, activity, startDate, endDate, DENSE_RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS rnk, COUNT(*) OVER(PARTITION BY username) AS cnt FROM UserActivity ) SELECT username, activity, startDate, endDate FROM table1 WHERE (cnt=1 AND rnk=1) OR (cnt>1 AND rnk=2)
WITH table1 AS( SELECT username, activity, startDate, endDate, DENSE_RANK() OVER(PARTITION BY username ORDER BY startDate DESC) AS rnk, COUNT(*) OVER(PARTITION BY username) AS cnt FROM UserActivity ) SELECT username, activity, startDate, endDate FROM table1 WHERE CASE WHEN cnt<2 THEN rnk=1 ELSE rnk=2 END
WITH tb1 AS (SELECT username, activity, startDate, endDate, COUNT(username) OVER(PARTITION BY username) AS ct, ROW_NUMBER() OVER(PARTITION BY username ORDER BY endDate DESC) AS rn FROM UserActivity) SELECT username, activity, startDate, endDate FROM tb1 WHERE (ct>1 AND rn=2) OR (ct=1)
WITH total_activities AS ( SELECT username, COUNT(*) as cnt FROM UserActivity GROUP BY username ), figure_max_end_date AS ( SELECT *, MAX(endDate) OVER(PARTITION BY username) as max_end_date FROM UserActivity ), figure_Second_most_recent_prep AS ( SELECT *, MAX(endDate) OVER(PARTITION BY username) as second_max_end_date FROM figure_max_end_date WHERE endDate <> max_end_date ), figure_Second_most_recent AS ( SELECT username, activity, startDate, endDate FROM figure_Second_most_recent_prep WHERE endDate = second_max_end_date ) SELECT U.* FROM UserActivity U INNER JOIN total_activities T ON U.username=T.username WHERE T.cnt = 1 UNION ALL SELECT * FROM figure_Second_most_recent
WITH win AS ( SELECT username, activity, startdate, enddate, RANK() OVER (PARTITION BY username ORDER BY enddate DESC) AS rk, MIN(enddate) OVER (PARTITION BY username) AS final_date FROM useractivity ) SELECT username, activity, startDate, endDate FROM win WHERE rk = 2 OR (rk = 1 AND enddate = final_date)
With cte as (Select *,dense_rank() over (partition by username order by startdate desc) as r, Count(activity) OVER (partition by username) as cnt from UserActivity ) Select username,activity,startDate,endDate from cte where cnt = 1 OR r=2
select * from UserActivity group by 1 having count(*) = 1 union select username, activity, startDate,endDate from (select *,dense_rank() over (partition by username order by startDate desc)as rk from UserActivity)as a where rk = 2
select * from UserActivity group by username having count(*) = 1 union all select u1.username, u1.activity, u1.startDate, u1.endDate from UserActivity u1 inner join UserActivity u2 on u1.username = u2.username and u1.endDate < u2.startDate group by u1.username, u1.endDate having count(*) = 1
select * from UserActivity group by username having count(0)=1 union select username, activity, startDate, endDate from (select *,rank()over(partition by username order by startDate desc) as rk from UserActivity) t where rk=2
select * from UserActivity group by username having count(username) = 1 union all select username, activity, startDate, endDate from (select *, dense_rank() over (partition by username order by startDate desc) as ranking from UserActivity) a where ranking = 2
select * from UserActivity where (username, startDate) in ( select username, min(startDate) as startDate from ( select *, row_number() over(partition by username order by startDate desc) as nrow from UserActivity ) sub where nrow <= 2 group by username )
select * from UserActivity where (username,endDate) in ( select username, max(endDate) as endDate from UserActivity where (username,endDate) not in ( select username,max(endDate) as endDate from UserActivity group by username) group by username ) or username in( select username from UserActivity group by username having count(1)=1)
select * from userActivity group by username having count(*) = 1 union all select u1.* from userActivity u1 join userActivity u2 on u1.username = u2.username and u1.endDate<u2.endDate group by u1.username, u1.endDate having count(u2.endDate)=1
select * from useractivity group by username having count(*) =1 union all select username,activity,startdate,enddate from ( select *, row_number() over (partition by username order by startdate desc) as rn from useractivity ) as tab1 where rn =2 order by username desc
select * from useractivity where username in ( select username from useractivity group by 1 having count(*)=1) union select username, activity, startdate, enddate from ( select *, rank() over(partition by username order by startdate desc) as rnk from useractivity) as a where rnk=2
select a.username, a.activity, a.startDate, a.endDate from UserActivity as a join UserActivity as b on a.username = b.username where a.startDate < b.startDate group by a.username, a.activity, a.startDate, a.endDate having count(b.activity) = 1 union select * from UserActivity group by username having count(*) = 1
select a.username, activity, startDate, endDate from (select username, activity, startDate, endDate, rank() over(partition by username order by endDate desc) rnk from UserActivity) a join (select username, count(*) cnt from UserActivity group by username) b on a.username = b.username where (cnt > 1 and rnk = 2) or (cnt = 1 and rnk = 1)
select distinct username, activity, startDate, endDate from (select u.*, rank() over (partition by username order by startDate desc) as rnk, count(activity) over (partition by username) as num from UserActivity u) t where (num <> 1 and rnk = 2) or (num = 1 and rnk = 1)
select distinct username, activity, startdate, enddate from ( select *, dense_rank() over (partition by username order by startdate desc) dk, count(activity) over (partition by username) cnt from UserActivity ) sub where dk = 2 or cnt = 1
select u1.username, u1.activity, u1.startDate, u1.endDate from useractivity u1 join ( select username, startDate, row_number() over(partition by username order by startDate desc) as rk from useractivity ) tmp on tmp.username = u1.username and tmp.startDate = u1.startDate and tmp.rk = 2 union select u2.username, u2.activity, u2.startdate, u2.endDate from useractivity u2 group by u2.username having count(*) = 1
select u1.username, u1.activity, u1.startDate, u1.endDate from useractivity u1 join ( select username, startDate, row_number() over(partition by username order by startDate desc) as rk from useractivity ) tmp on tmp.username = u1.username and tmp.startDate = u1.startDate and tmp.rk = 2 union select u2.username, u2.activity, u2.startdate, u2.endDate from useractivity u2 join( select username, count(*) as cnt from useractivity group by username ) tmp2 on tmp2.username = u2.username and tmp2.cnt = 1
select username , activity , startDate ,endDate from (select username , activity , startDate ,endDate, rank() over(partition by username order by startDate desc)as rowNum from UserActivity) a where rowNum = 2 union all select username , activity , startDate ,endDate from UserActivity group by username having count(username) = 1
select username , activity , startdate , enddate from( select * , row_number() over (partition by username order by startdate desc) as rk , count(startdate) over (partition by username) as num_a from useractivity) as temp where rk=2 or (rk=1 and num_a=1)
select username , activity , startdate,enddate from (select username , activity , startdate,enddate ,rank() over (partition by username order by startdate) as rnk , count(*) over (partition by username) as act_freq from useractivity ) a where case when act_freq > 1 then rnk = act_freq - 1 else rnk = 1 end
select username , activity , startdate,enddate from (select username , activity , startdate,enddate ,rank() over (partition by username order by startdate) as rnk , count(username) over (partition by username) as act_freq from useractivity ) a where case when act_freq > 1 then rnk = act_freq - 1 else rnk = 1 end
select username as USERNAME, activity as ACTIVITY, startDate as STARTDATE, endDate AS ENDDATE from (select *, max(rn) over (partition by username) as max_rn from (select *, row_number() over (partition by username order by startDate desc) as rn from userActivity) a where rn <=2) b where rn = max_rn
select username, activity , startDate, endDate from (select username, activity , startDate, endDate, dense_rank() over(partition by username order by startDate DESC) as date_rank from UserActivity ) tb1 where date_rank = 2 UNION ALL SELECT * FROM UserActivity GROUP BY username HAVING COUNT(*) = 1
select username, activity, startDate, endDate from ( select *, count(activity) over(partition by username)cnt, ROW_NUMBER() over(partition by username order by startdate desc) n from UserActivity) tbl where n=2 or cnt<2
select username, activity, startDate, endDate from ( select *, count(activity) over(partition by username)cnt, ROW_NUMBER() over(partition by username order by startdate desc) n from UserActivity) tbl where n=2 or cnt=1
select username, activity, startDate, endDate from ( select *, dense_rank()over(partition by username order by endDate desc) as rnk from useractivity)a where rnk=2 union select username, activity, startDate,endDate from useractivity group by username having count(*) = 1
select username, activity, startDate, endDate from ( select *, rank() over (partition by username order by startDate desc) as rnk, count(username) over (partition by username) as cnt from UserActivity )t where cnt = 1 or (cnt>1 and rnk=2)
select username, activity, startDate, endDate from ( select *, rank() over(partition by username order by startDate desc) as rank_Num from useractivity ) as cte where rank_num = 2 union all select * from useractivity where username in (select username from useractivity group by 1 having count(username) =1 )
select username, activity, startDate, endDate from ( select username, activity, startDate, endDate, dense_rank() over(partition by username order by startDate desc) as 'rnk', count(activity) over(partition by username) as cnt from useractivity ) as tab where case when tab.cnt<2 then tab.rnk=1 else tab.rnk=2 end
select username, activity, startDate, endDate from ( select username, activity, startDate, endDate, rank() over(partition by username order by endDate desc, startDate desc) as r_num, sum(1) over(partition by username) as s_num from useractivity) t where (s_num > 1 and r_num = 2) OR s_num = 1
select username, activity, startDate, endDate from ( select username, activity, startDate, endDate, row_number() over (partition by username order by startDate desc) as ranks, count(username) over (partition by username) as counts from UserActivity) as t where counts = 1 or ranks = 2
select username, activity, startDate, endDate from (select *, count(activity) over (partition by username) as cnt, rank() over (partition by username order by startDate desc) as rk from UserActivity) a where cnt < 2 or rk = 2
select username, activity, startDate, endDate from (select *, count(username) over(partition by username) cnt, rank() over(partition by username order by endDate desc) ranked from UserActivity) temp where ranked = 2 or cnt = 1
select username, activity, startDate, endDate from (select *, max(rk) over (partition by username) as max_rk from (select *, rank() over (partition by username order by startDate desc) as rk from useractivity) as t) as temp where rk=2 or (rk=1 and max_rk=1)
select username, activity, startDate, endDate from (select *, rank() over(partition by username order by endDate desc) ranked from UserActivity) temp where ranked = 2 union select * from UserActivity group by username having count(*) = 1
select username, activity, startDate, endDate from (select *, row_number() over(partition by username order by startDate desc) rank_u, count(*)over(partition by username) cnt_u from UserActivity) ua where rank_u = case when cnt_u > 1 then 2 else 1 end
select username, activity, startDate, endDate from (select u1.*, rank() over(partition by username order by startDate asc) as act_rank, user_ct from UserActivity u1 join (select username, count(*) as user_ct from UserActivity group by username) u2 on u1.username=u2.username) t where act_rank=(user_ct-1) or user_ct=1
select username, activity, startDate, endDate from (select username, activity, startDate, endDate, row_number() over (partition by username order by startDate desc) as activity_rank, count(username) over (partition by username) as counts from UserActivity) activity_tmp where activity_rank = 2 or counts = 1
select username, activity, startDate, endDate from( select *, rank() over(partition by username order by endDate asc) as asc_rank, rank() over(partition by username order by endDate desc) as desc_rank from UserActivity ) UA where UA.desc_rank = 2 or UA.asc_rank+UA.desc_rank=2
select username, activity, startDate, endDate from( select username, activity, rank() over(partition by username order by startDate desc) as rnk, startDate, endDate from UserActivity )t where rnk = 2 union all select username, activity, startDate, endDate from UserActivity where username in ( select username from UserActivity group by username having count(*) = 1 )
select username, activity, startDate, endDate from( select username, activity, startDate, endDate, dense_rank()over(partition by username order by endDate desc) as actrank, count(activity)over(partition by username) as actcnt from UserActivity )a where actrank=2 or actcnt=1
select username, activity, startdate, enddate from ( select *, rank() over (partition by username order by startdate desc) rnk, count(*) over (partition by username) cnt from useractivity ) t where rnk = 2 or cnt =1
select username, activity, startdate, enddate from ( select a.*, row_number() over (partition by username order by startdate desc) as rn from useractivity as a ) as b where (username,rn) in (select username, case when count(activity)>=2 then 2 else 1 end as rn from useractivity group by 1)
select username, activity, startdate, enddate from ( select username, activity, startdate, enddate, row_number() over(partition by username order by startdate desc) rn, count(*) over(partition by username) cnt from useractivity ua) f1 where if(cnt = 1, rn = 1, rn = 2)
select username, activity, startdate, enddate from (select *, rank() over(partition by username order by enddate desc) r, count(activity) over(partition by username) c from useractivity) lookup where r = 2 or c = 1
select username, activity, startdate, enddate from (select *, row_number() over (partition by username order by startDate desc) as rowNum, count(*) over (partition by username) as actCount from UserActivity) as rnked where (actCount > 1 and rowNum = 2) or (actCount = 1 and rowNum = 1)
select username, activity, startdate, enddate from (select *, row_number() over (partition by username order by startDate desc) as rowNum, count(*) over (partition by username) as actCount from UserActivity) as rnked where rowNum = 2 or actCount = 1
select username, activity, startdate, enddate from useractivity where (username, startdate) in (select username, min(t.startdate) from (select username, activity, startdate, row_number() over (partition by username order by startdate desc) as rnk from useractivity) t where rnk <=2 group by username)
select username, activity, startdate, enddate from( select *, rank() over(partition by username order by startdate desc) as rnk, count(*) over(partition by username) as cnt from UserActivity) t where cnt=1 or rnk=2
select username, activity,startDate, EndDate from (select username, activity,startDate, EndDate, activity_rank, MAX(activity_rank) over (partition by username) as latest_rank from (select username, activity, startDate, EndDate, activity_rank from (select username, activity, startDate, EndDate, rank() over (partition by username order by startDate desc) as activity_rank from UserActivity ) sub where activity_rank <= 2) sub2 ) sub3 where activity_rank = latest_rank
select username, activity,startdate, enddate from ( select username, activity,startdate, enddate, count(*) over(partition by username) as activity_cnt, rank() over(partition by username order by extract(year from startdate) desc,extract(month from startdate) desc,extract(day from startdate) desc) as rnk from useractivity )a where (activity_cnt = 1) or (activity_cnt >1 and rnk = 2)
select username, activity,startdate,enddate from (select username, activity,startdate,enddate, case when rnk = max(rnk) over (partition by username) then true else false end as chk from ( select username, activity, startdate, row_number() over (partition by username order by startdate desc) as rnk, enddate from useractivity ) t where rnk<=2) final where chk=1
select username,activity, startdate,enddate from (select username, activity, startdate, enddate, rank() over(partition by username order by startdate desc) as rnk from useractivity) as a where rnk=2 union select * from useractivity group by username having count(*)=1
select username,activity,startDate,endDate from ( select *, rank()over(partition by username order by endDate desc) as rkt, rank()over(partition by username order by endDate asc) as rkt_asc from UserActivity ) cte where rkt = 2 or (rkt = 1 and rkt_asc=1)
select username,activity,startDate,endDate from ( select *, row_number() over(partition by username order by startDate desc) as rn from UserActivity) sub where rn=(select case when count(1)>1 then 2 else 1 end from UserActivity u where u.username=sub.username)
select username,activity,startDate,endDate from ( select username,activity,startDate,endDate, row_number() over(partition by username order by startDate desc,endDate desc) as rw_num from UserActivity where username in (select username from UserActivity group by username having count(username)>1) ) Mult where rw_num=2 UNION ALL select username,activity,startDate,endDate from UserActivity group by username having count(username)=1
select username,activity,startDate,endDate from (select a.*, row_number()over(partition by username order by startDate desc) as row_n, count(*) over( partition by username) as cnt from UserActivity a) t where t.row_n=2 or cnt<2
select username,activity,startDate,enddate from( select *, rank()over(partition by username order by enddate desc) as rk from useractivity)a where rk =2 or username in (select username from useractivity group by username having count(*)=1)
select username,activity,startdate,enddate from (select username, activity,startdate,enddate,rank()over(partition by username order by enddate desc) as date_rk from useractivity)t1 where date_rk = 2 or username in (select username from useractivity group by 1 having count(*)=1)
select username,activity,startdate,enddate from(select username,activity,startdate,enddate,count(*) over (partition by username) as ct, rank() over (partition by username order by startdate desc) as rn from useractivity)A where A.rn=2 or A.ct=1
select x.username,x.activity,x.startdate,x.enddate from ( select a.*, rank() over(partition by username order by startdate desc) rk,b.rk rk_1 from UserActivity a left join ( select username,rank() over(partition by username order by startdate desc) rk from UserActivity ) b on b.username = a.username and b.rk=2) x where x.rk=2 or x.rk_1 is null
with CTE as (select username, activity, startdate, enddate, dense_rank() over(partition by username order by startdate desc) as ranking_by_date, count(username) over(partition by username) as counting from userActivity) select username,activity,startdate,enddate from CTE as cte1 where ranking_by_date=2 or counting=1
with U1 as ( select username, activity, startDate, endDate, row_number() over(partition by username order by startDate desc) as rn1 from UserActivity ), U2 as ( select username, activity, startDate, endDate, row_number() over(partition by username order by startDate asc) as rn2 from U1 where rn1<=2 ) select username, activity, startDate, endDate from U2 where rn2=1
with a as ( select *, rank () over (partition by username order by startdate desc) as activity_rank from useractivity ) select username,activity,startdate,enddate from a where activity_rank = 2 or username in (select username from useractivity group by username having count(distinct activity)=1)
with a as (select *, row_number() over (partition by username order by startDate desc) as rk from UserActivity), b as (select username, activity, startDate, endDate from a where rk =2 ) select * from b union all select username, activity, startDate, endDate from a where username not in (select username from b)
with a as (select username , activity ,startDate,endDate, rank()over(partition by username order by startDate desc) rn, count(username)over(partition by username ) cn from UserActivity) , b as ( select username , activity ,startDate,endDate from a where rn =2 ) select username , activity ,startDate,endDate from b union all select username , activity ,startDate,endDate from a where cn=1
with a as (select username, activity, startdate, enddate, rank() over(partition by username order by enddate desc) as 'rank' from useractivity) select username, activity, startdate, enddate from a where a.rank = 2 union select * from useractivity where username not in (select username from a where a.rank = 2)
with cte AS( SELECT * FROM UserActivity GROUP BY username HAVING count(*) = 1) SELECT username, activity,startDate, endDate FROM (SELECT t1.username, t1.activity, t1.startDate, t1.endDate FROM (SELECT username, activity, startDate, endDate, RANK() OVER (PARTITION BY username ORDER BY endDate DESC) as ranking FROM UserActivity) t1 WHERE ranking = 2) a UNION SELECT * FROM cte
with cte as ( SELECT *, rank() over(partition by username order by startDate DESC) as rnk FROM UserActivity) SELECT username, activity, startDate, endDate FROM ( SELECT * FROM cte JOIN ( SELECT username, max(rnk) as max_rnk FROM cte GROUP BY 1)y using (username))t WHERE rnk = (CASE WHEN max_rnk = 1 THEN 1 ELSE 2 END)
with cte as ( SELECT username, activity, startDate, endDate, RANK() OVER(PARTITION BY username ORDER BY endDate DESC) as recency FROM UserActivity ), inactive_users as ( SELECT username, count(activity) as num_activities FROM UserActivity GROUP BY username ) SELECT c.username, c.activity, c.startDate, c.endDate FROM cte c LEFT JOIN inactive_users i ON i.username = c.username WHERE CASE WHEN i.num_activities = 1 THEN c.recency = 1 ELSE c.recency = 2 END
with cte as ( select *, rank() over(partition by username order by startdate desc) as rk from useractivity ), cte1 as ( select username, activity, startdate, enddate, count(*) as cnt from cte group by username ) select cte.username, cte.activity, cte.startdate, cte.enddate from cte left join cte1 on cte.username=cte1.username where cte.rk=2 or cte1.cnt=1
with cte as ( select *, rank() over(partition by username order by startdate desc) as rk, count(*) over(partition by username) as cnt from useractivity ) select username, activity, startdate, enddate from cte where rk=2 or cnt=1
with cte as ( select *, rank()over(partition by username order by enddate desc) as ranks , count(username)over(partition by username) as cnt from useractivity) select username, activity, startdate, enddate from cte where cnt = 1 or ranks = 2
with cte as ( select a.*, rank() over(partition by username order by enddate desc) as r from useractivity a ) ,second_highest as ( select username, max(r) as max_r from cte where r<=2 group by username) select cte.username, cte.activity, cte.startDate, cte.endDate from cte inner join second_highest s on cte.username=s.username and cte.r=s.max_r
with cte as ( select dense_rank() over(partition by username order by startdate desc) as rnk, username,activity,startDate,endDate from userActivity ), cte2 as (select *, count(username) as cnt from useractivity group by username) select username as USERNAME,activity as ACTIVITY, startdate as STARTDATE, enddate as ENDDATE from cte where rnk = 2 union all select username as USERNAME,activity as ACTIVITY, startdate as STARTDATE, enddate as ENDDATE from cte2 where cnt =1
with cte as ( select u.*, row_number() over (partition by username order by endDate desc) as idx from userActivity as u ), cte2 as ( select c.* , max(c.idx) over (partition by c.username) as midx from cte c ) select c.username, c.activity, c.startDate, c.endDate from cte2 c where (c.idx=2 and c.midx>=2) or (c.idx=1 and c.midx<2)
with cte as ( select username, activity, startDate, endDate, rank() over (partition by username order by startDate desc) as rnk from UserActivity ), cte1 as ( select username, case when count(*) = 1 then 1 else 2 end as rnk from UserActivity group by 1 ) select cte.username, activity, startDate, endDate from cte inner join cte1 on cte.username = cte1.username and cte.rnk = cte1.rnk
with cte as ( select username, activity, startDate, endDate, rank() over (partition by username order by startDate desc) as rnk, count(username) over(partition by username) as cnt from UserActivity ) select username, activity, startDate, endDate from cte where rnk = 2 or cnt =1
with cte as ( select username, activity, startDate, endDate, rank() over(partition by username order by endDate desc) as rnk from UserActivity), cte1 as ( select username from UserActivity group by 1 having count(*) = 1) select username, activity, startDate, endDate from cte where rnk = 2 union all select username, activity, startDate, endDate from UserActivity where username in (select * from cte1)
with cte as ( select username, activity, startDate, endDate, rank() over(partition by username order by startDate desc) as rk from UserActivity ), cte2 as ( select username, activity, startDate, endDate from cte where rk = 2 ) select * from cte2 union all select username, activity,startDate, endDate from cte where rk =1 and username not in (select username from cte2)
with cte as ( select username, activity, startDate, endDate, rank() over(partition by username order by startDate desc) as rk, count(*) over(partition by username) as cnt from UserActivity) select username, activity, startDate, endDate from cte where rk = 2 union select username, activity, startDate, endDate from cte where cnt = 1
with cte as ( select username,activity,startDate,endDate,rank()over(partition by username order by startDate desc) as r, count(activity)over(partition by username) as c from useractivity) select username,activity,startDate,endDate from ( select username,activity,startDate,endDate, case when c=1 and r=1 then 1 when c>=2 and r=2 then 1 else 0 end as test from cte) a where a.test=1
with cte as ( select username,activity,startdate,enddate,rank() over (partition by username order by startdate desc) as rn from UserActivity ) select username,activity,startdate,enddate from cte where rn = 2 union select username,activity,startdate,enddate from cte where rn = 1 and cte.username not in (select username from cte where rn = 2)
with cte as (Select *, RANK() OVER(PARTITION BY username ORDER BY startDate desc) as rnk,COUNT(activity) OVER (PARTITION BY username) AS cnt from UserActivity) Select USERNAME,ACTIVITY,STARTDATE,ENDDATE from cte where rnk=2 or cnt=1 order by username desc
with cte as (select * from( select *, rank() over (partition by username order by startDate desc) as rk from UserActivity) tb1 where rk <=2) select username, activity, startDate, endDate from cte where (username, rk) in (select username, max(rk) from cte group by 1)
with cte as (select *, rank() over(partition by username order by enddate desc) rnk, count(*) over(partition by username) cnt from useractivity) select username, activity, startDate, endDate from cte where if(cnt=1, rnk=1, rnk=2)
with cte as (select username, activity, startdate, enddate, dense_rank() over (partition by username order by startdate desc) as rk, count(activity) over(partition by username) as count from useractivity) select username, activity, startdate, enddate from cte where rk = case when count = 1 then 1 else 2 end
with cte as( select *, row_number() over(partition by username order by startdate desc) as rnk from useractivity ), cte2 as( select username as USERNAME, activity as ACTIVITY, startdate as STARTDATE, enddate as ENDDATE from cte where rnk = 2) select * from cte2 UNION select username as USERNAME, activity as ACTIVITY, startdate as STARTDATE, enddate as ENDDATE from cte where rnk < 2 and username not in (select username from cte2)
with cte1 as (select *, rank() over (partition by username order by startDate desc) as rn from useractivity), cte2 as (select username, count(activity) as activities_count from useractivity group by username) select a.username, a.activity, a.startDate, a.endDate from cte1 as a join cte2 as b on a.username = b.username where if(b.activities_count > 1, rn = 2, rn = 1)
with cte_2 as ( select *, dense_rank() over (partition by username order by startdate desc) as rk from UserActivity ) select username,activity,startDate,endDate from cte_2 where rk=2 union select username,activity,startDate,endDate from cte_2 where rk=1 and username not in (select username from cte_2 group by 1 having count(rk)>1)
with cte_latest_activities as ( select username, activity, max(startDate) as last_activity_startDate, max(endDate) as last_activity_endDate from UserActivity group by 1, 2 ), cte_window as ( select username, activity, last_activity_startDate, last_activity_endDate, rank() over ( partition by username order by last_activity_startDate desc ) as activity_order, count(*) over ( partition by username ) as num_activities from cte_latest_activities ), cte_final as ( select username, activity, last_activity_startDate as startDate, last_activity_endDate as endDate from cte_window where case when num_activities > 1 then activity_order = 2 when num_activities = 1 then activity_order = 1 end ) select * from cte_final
with detail as ( select username , activity ,startDate ,enddate ,rank()over(partition by username order by startdate desc) rk ,count(*)over(partition by username) ct from useractivity ) select username , activity ,startDate ,enddate from detail where case when ct<2 then ct=rk else rk=2 end
with labeled as ( select *, row_number() over( partition by username order by startDate desc ) as num from useractivity ) select username, activity, startDate, endDate from labeled where num=2 union select * from useractivity where username in ( select username from useractivity group by username having count(activity)=1 )
with prep as ( select *, row_number()over(partition by username order by endDate desc)rn, count(username)over(partition by username) TotalActivityPerUser from useractivity ) select username, activity, startdate, enddate from prep where case when totalactivityperuser>1 then rn=2 else rn=1 end
with ranked as ( select username, activity, startDate, endDate, dense_rank() over (partition by username order by startDate desc) as rg, count(1) over (partition by username) as cnt from useractivity ) select username, activity, startDate, endDate from ranked where (cnt > 1 and rg = 2) or cnt = 1
with recent as (select *, count(activity) over(partition by username) cnt, dense_rank()over(partition by username order by startdate desc) as ranking from UserActivity) select username, activity, startDate, endDate from recent where ranking=2 or cnt<2
with recent as (select *, count(activity) over(partition by username) cnt, dense_rank()over(partition by username order by startdate desc) as ranking from UserActivity) select username, activity, startDate, endDate from recent where ranking=2 or cnt=1
with recent as (select *, count(activity) over(partition by username) cnt, row_number()over(partition by username order by startdate desc) as ranking from UserActivity) select username, activity, startDate, endDate from recent where ranking=2 or cnt<2
with recent as (select *, dense_rank()over(partition by username order by startdate desc) as ranking from UserActivity), final as (select username, min(startDate) as startDate, min(endDate) as endDate from recent where ranking <=2 group by username ) select * from final join UserActivity using (username,startDate,endDate)
with rnker as (select username, startDate, rank() over (partition by username order by startDate desc) as rnk from UserActivity ), count_act as (select username, count(1) as act_count from UserActivity group by username having count(1) = 1) select ua.username, ua.activity, ua.startDate, ua.endDate from UserActivity ua join rnker r on ua.username = r.username and ua.startDate = r.startDate where r.rnk = 2 union select ua.username, ua.activity, ua.startDate, ua.endDate from UserActivity ua join count_act c on ua.username = c.username
with rnks as ( select *, rank() over (partition by username order by startDate desc) as 'turns' from UserActivity ) select username, activity, startDate, endDate from rnks where turns = 2 union select * from UserActivity group by username having count(*) = 1
with second_act as ( select username, activity, startdate, enddate, rank() over (partition by username order by startdate desc) "date_rank" from useractivity ), first_act as ( select username from useractivity group by 1 having count(*) = 1 ) select u.* from useractivity u join (select * from second_act where date_rank = 2) s on s.username = u.username and s.startdate = u.startdate union select * from useractivity where username in (select * from first_act)
with secondmostrecent as (select username,activity,startDate,endDate from (select *, rank() over(partition by username order by startDate Desc) as "rank" from UserActivity) temp where temp.rank = 2) select * from secondmostrecent union select * from UserActivity where username not in (select username from secondmostrecent)
with t as ( select *, dense_rank() over(partition by username order by startDate desc) ranking from UserActivity ) select t.username,t.activity,t.startDate,t.endDate from t where t.ranking=2 union select t.username,t.activity,t.startDate,t.endDate from t where t.ranking=1 and t.username not in (select t.username from t group by 1 having count(ranking)>1)
with t as ( select *, rank() over (partition by username order by startDate desc) as rk from useractivity ) select username, activity, startDate, endDate from (select *, max(rk) over (partition by username) as max_rk from t) as temp where rk=2 or (rk=1 and max_rk=1)
with t as (select username, activity, startDate, endDate from (select *, rank() over (partition by username order by startDate desc) as rnk from UserActivity) t where rnk = 2) select username, activity, min(startDate) as startDate, min(endDate) as endDate from UserActivity where username not in (select username from t) group by username, activity having count(startDate) = 1 union all select * from t
with t as(select username,activity,startDate,endDate, dense_rank()over(partition by username order by startDate desc) rk from UserActivity group by 1,2,3,4), t2 as(select t.username from t group by 1 having count(*)=1), t3 as (select t.username from t group by 1 having count(t.username)>1) select t.username,t.activity,t.startDate,t.endDate from t where t.username in (select t.username from t group by 1 having count(*)=1) or (t.username in (select t.username from t group by 1 having count(t.username)>1) and t.rk=2)
with t1 as (select * from useractivity group by username having count(*) = 1), t2 as (select useractivity.*, rank() over (partition by username order by startdate desc) as rnk from useractivity) select t1.* from t1 union all select username, activity, startdate, enddate from t2 where rnk = 2
with t1 as (select useractivity.*, rank() over (partition by username order by startdate desc) as rnk from useractivity) select username, activity, startdate, enddate from t1 where rnk = 2 union all select username, activity, startdate, enddate from useractivity group by 1 having count(*) = 1
with t1 as( select *, rank() over(partition by username order by startDate desc) as rk from UserActivity ), t2 as( select username, count(*) as n from UserActivity group by 1 ) select t1.username, t1.activity, t1.startDate, t1.endDate from t1 join t2 on t1.username = t2.username where n < 2 or rk = 2
with tbl1 as ( select u.*, rank() over (partition by username order by startDate desc) rnk from UserActivity u order by 1), tbl2 as ( select tbl1.*, max(rnk) over (partition by username) maxrnk from tbl1), tbl3 as ( select tbl2.* from tbl2 where tbl2.rnk = 1 or tbl2.rnk = 2) select tbl3.username, tbl3.activity, tbl3.startDate, tbl3.endDate from tbl3 where (username, rnk, maxrnk) in ( select tbl3.username, max(tbl3.rnk), max(tbl3.maxrnk) from tbl3 group by tbl3.username)
with tem1 as( select username, activity, startDate, endDate, row_number() over(partition by username order by enddate desc) as recent_rk from useractivity), tem2 as ( select username, count(activity) as cnt_act from useractivity group by username ) select username, activity, startDate, endDate from ( select a.*, b.cnt_act from tem1 a inner join tem2 b on a.username = b.username) c where cnt_act >=2 and recent_rk = 2 or cnt_act = 1
with temp as (select *,DENSE_RANK() over (partition by username order by startdate DESC) as rank_num from UserActivity) select username,activity,startDate,endDate from UserActivity where username in (select username from temp group by username having max(rank_num) = 1) Union select username,activity,startDate,endDate from temp where rank_num = 2
with temp as (select username, activity, startDate, endDate, rank() over (partition by username order by startDate desc) as ranking from UserActivity), temp1 as ( select username, activity, startDate, endDate from temp where ranking = 2 ) select * from temp1 union select * from UserActivity where username not in (select username from temp1)
with temp as (select username, activity, startDate, endDate, rank()over(partition by username order by startDate DESC) as rankno from UserActivity), temp2 as (select *, max(temp.rankno)over(partition by temp.username ) as maxrankno2 from temp where rankno<=2) select temp2.username, temp2.activity, temp2.startDate, temp2.endDate from temp2 where temp2.rankno=maxrankno2
with tmp as ( select *, rank() over (partition by username order by startdate desc) as rnk from useractivity ) ,tmp2 as ( select username, count(rnk) as cnt from tmp group by 1 ) select username, activity, startdate, enddate from tmp where rnk = 2 or username in (select username from tmp2 where cnt = 1)
with tmp as ( select *, row_number() over(partition by username order by startdate desc) as rn, count(*) over(partition by username) as ct from useractivity ) select username, activity, startdate, enddate from tmp where rn = 2 or ct = 1
with tmp as ( select username, max(startDate) as startDate from useractivity group by username ), tmp2 as(select u1.username, max(u1.startDate) as startDate, max(u1.endDate) as endDate from useractivity u1 inner join tmp on tmp.username = u1.username and u1.startDate < tmp.startDate group by u1.username UNION ( select u2.username, max(u2.startDate) as startDate, max(u2.endDate) as endDate from useractivity u2 group by u2.username having count(*) = 1 )) select tmp2.username, a.activity, tmp2.startDate, tmp2.endDate from tmp2 inner join useractivity a on a.username = tmp2.username and a.startDate = tmp2.startDate
with x as ( select username, activity, startdate, enddate from ( select username , activity , startDate , endDate , row_number() over(partition by username order by startDate desc) as seq from UserActivity ) p where seq = 2 union all select * from useractivity where username in (select username from ( select username, count(*) from UserActivity group by 1 having count(distinct activity) = 1)q ) ) select distinct * from x
