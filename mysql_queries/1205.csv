SELECT * FROM (SELECT LEFT(trans_date,7) AS month, country, SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state='chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT c.trans_id, t.country, 'chargeback' AS state, t.amount, c.trans_date FROM Chargebacks c JOIN Transactions t ON c.trans_id=t.id UNION ALL SELECT * FROM Transactions) temp GROUP BY month,country) temp1 WHERE (approved_count,approved_amount,chargeback_count,chargeback_amount) != (0,0,0,0)
SELECT DATE_FORMAT(a.trans_date,"%Y-%m") AS month, a.country, sum(case when a.state="approved" then 1 else 0 end) AS approved_count, sum(case when a.state="approved" then a.amount else 0 end) AS approved_amount, sum(case when a.state="Chargeback" then 1 else 0 end) AS chargeback_count, sum(case when a.state="Chargeback" then a.amount else 0 end) AS chargeback_amount FROM (select T.id, T.country, T.trans_date, T.state, T.amount from Transactions T where T.state = "approved" union select C.trans_id AS id, T.country, C.trans_date, "Chargeback" AS state, T.amount from Transactions T right join Chargebacks C on T.id = C.trans_id) a GROUP BY DATE_FORMAT(a.trans_date,"%Y-%m"), a.country
SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country AS country, SUM(IF(state = 'approved', 1, 0)) AS approved_count, SUM(IF(state = 'approved', amount, 0)) AS approved_amount, SUM(IF(state = 'chargeback', 1, 0)) AS chargeback_count, SUM(IF(state = 'chargeback', amount, 0)) AS chargeback_amount FROM ( SELECT c.trans_id, c.trans_date, t.country, 'chargeback' AS state, t.amount FROM Transactions t JOIN Chargebacks c ON t.id = c.trans_id UNION ALL SELECT id, trans_date, country, state, amount FROM Transactions WHERE state = 'approved' ) lv1 GROUP BY DATE_FORMAT(trans_date, '%Y-%m'), country
SELECT DATE_FORMAT(trans_date, '%Y-%m') as month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END)AS approved_amount, SUM(CASE WHEN state = 'chargeback' THEN 1 ELSE 0 END ) AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM( SELECT c.trans_id, t.country, 'chargeback' as state, t.amount, c.trans_date from Chargebacks as c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT * FROM Transactions) as t1 group by country, month HAVING approved_amount>0 OR chargeback_amount>0
SELECT DATE_FORMAT(trans_date,"%Y-%m") AS month, country, SUM( state='approved') AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(state='chargeback') AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT * FROM Transactions where state = 'approved' UNION ALL SELECT DISTINCT C.trans_id AS id,T.country,'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id=T.id ) final GROUP BY month,country
SELECT DATE_FORMAT(trans_date,"%Y-%m") AS month, country, SUM(state='approved') AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(state='chargeback') AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT * FROM Transactions where state = 'approved' UNION ALL SELECT C.trans_id AS id,T.country,'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id=T.id ) final GROUP BY month,country
SELECT DATE_FORMAT(trans_date,"%Y-%m") AS month, country, SUM(state='approved') AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(state='chargeback') AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT * FROM Transactions where state = 'approved' UNION ALL SELECT DISTINCT C.trans_id AS id,T.country,'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id=T.id ) final GROUP BY month,country
SELECT DATE_FORMAT(trans_date,"%Y-%m") AS month, country, SUM(state='approved') AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(state='chargeback') AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT DISTINCT * FROM Transactions where state = 'approved' UNION ALL SELECT DISTINCT C.trans_id AS id,T.country,'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id=T.id ) final GROUP BY month,country
SELECT DATE_FORMAT(trans_date,'%Y-%m') AS month,country,SUM(IF(state='approved',1,0)) AS approved_count, SUM(IF(state='approved',amount,0)) AS approved_amount, SUM(IF(state='back',1,0)) AS chargeback_count, SUM(IF(state='back',amount,0)) AS chargeback_amount FROM ( SELECT C.trans_date,country,'back' AS state,amount FROM Chargebacks AS C JOIN Transactions AS T ON C.trans_id=T.id UNION SELECT trans_date,country,state,amount FROM Transactions AS T WHERE state='approved') AS new GROUP BY month,country
SELECT DATE_FORMAT(trans_date,'%Y-%m') month, country, COALESCE(COUNT(CASE WHEN state='approved' THEN id ELSE NULL END),0) AS approved_count, COALESCE(SUM(CASE WHEN state='approved' THEN amount ELSE 0 END), 0) AS approved_amount, COALESCE(COUNT(CASE WHEN state='chargeback' THEN id ELSE NULL END),0) AS chargeback_count, COALESCE(SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END), 0) AS chargeback_amount FROM (SELECT a.id, country, 'chargeback' state, amount, b.trans_date FROM Transactions a INNER JOIN Chargebacks b ON a.id=b.trans_id UNION ALL SELECT * FROM Transactions ) t GROUP BY DATE_FORMAT(trans_date,'%Y-%m'), country HAVING approved_count> 0 OR chargeback_count>0 ORDER BY DATE_FORMAT(trans_date,'%Y-%m'), country
SELECT DISTINCT t_all.* FROM (SELECT cb_agg.month, cb_agg.country, IFNULL(tr_agg.approved_count, 0) AS 'approved_count', IFNULL(tr_agg.approved_amount, 0) AS 'approved_amount', cb_agg.chargeback_count, cb_agg.chargeback_amount FROM (SELECT t1.month, t1.country, COUNT(*) AS 'chargeback_count', SUM(t1.amount) AS 'chargeback_amount' FROM (SELECT CONCAT(CAST(YEAR(cb.trans_date) AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(MONTH(cb.trans_date) AS CHAR(2))), 2)) AS 'month', tr.country, tr.amount FROM Transactions tr, Chargebacks cb WHERE tr.id = cb.trans_id) t1 GROUP BY t1.month, t1.country) cb_agg LEFT JOIN (SELECT t2.month, t2.country, COUNT(*) AS 'approved_count', SUM(t2.amount) AS 'approved_amount' FROM (SELECT CONCAT(CAST(YEAR(trans_date) AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(MONTH(trans_date) AS CHAR(2))), 2)) AS 'month', country, amount FROM Transactions WHERE state = 'approved') t2 GROUP BY t2.month, t2.country ) tr_agg ON cb_agg.month = tr_agg.month AND cb_agg.country = tr_agg.country UNION SELECT tr_agg.month, tr_agg.country, tr_agg.approved_count, tr_agg.approved_amount, IFNULL(cb_agg.chargeback_count, 0) AS 'chargeback_count', IFNULL(cb_agg.chargeback_amount, 0) AS 'chargeback_amount' FROM (SELECT t1.month, t1.country, COUNT(*) AS 'chargeback_count', SUM(t1.amount) AS 'chargeback_amount' FROM (SELECT CONCAT(CAST(YEAR(cb.trans_date) AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(MONTH(cb.trans_date) AS CHAR(2))), 2)) AS 'month', tr.country, tr.amount FROM Transactions tr, Chargebacks cb WHERE tr.id = cb.trans_id) t1 GROUP BY t1.month, t1.country) cb_agg RIGHT JOIN (SELECT t2.month, t2.country, COUNT(*) AS 'approved_count', SUM(t2.amount) AS 'approved_amount' FROM (SELECT CONCAT(CAST(YEAR(trans_date) AS CHAR(4)), '-', RIGHT(CONCAT('0', CAST(MONTH(trans_date) AS CHAR(2))), 2)) AS 'month', country, amount FROM Transactions WHERE state = 'approved') t2 GROUP BY t2.month, t2.country ) tr_agg ON cb_agg.month = tr_agg.month AND cb_agg.country = tr_agg.country) t_all ORDER BY t_all.month ASC, t_all.country DESC
SELECT LEFT(trans_date, 7) AS month, country, SUM(state = "approved") AS approved_count, SUM(IF(state = "approved", amount, 0)) AS approved_amount, SUM(state = "chargebacks") AS chargeback_count, SUM(IF(state = "chargebacks", amount, 0)) AS chargeback_amount FROM ((SELECT * FROM Transactions WHERE state = "approved") UNION ALL (SELECT a.id, country, "chargebacks" AS state, amount, b.trans_date FROM Transactions a RIGHT JOIN Chargebacks b ON a.id = b.trans_id)) c GROUP BY 1,2
SELECT LEFT(trans_date, 7) AS month, country, SUM(state = "approved") AS approved_count, SUM(IF(state = "approved", amount, 0)) AS approved_amount, SUM(state = "chargebacks") AS chargeback_count, SUM(IF(state = "chargebacks", amount, 0)) AS chargeback_amount FROM ((SELECT * FROM Transactions WHERE state = "approved") UNION ALL (SELECT a.id, country, "chargebacks" AS state, amount, b.trans_date FROM Transactions a RIGHT JOIN Chargebacks b ON a.id = b.trans_id)) c GROUP BY LEFT(trans_date, 7), country
SELECT LEFT(trans_date,7) AS month , country, SUM(state = 'approved') AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(state = 'chargeback') AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT t.id, country, state, amount, t.trans_date FROM Transactions AS t LEFT JOIN ChargeBacks AS c ON t.id = c.trans_id UNION SELECT c.trans_id, country,'chargeback' ,amount , c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id ) temp GROUP BY month,country having approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
SELECT LEFT(trans_date,7) AS month, country, SUM(state='approved') AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(state='chargeback') AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT DISTINCT * FROM Transactions WHERE state = 'approved' UNION ALL SELECT DISTINCT C.trans_id AS id,T.country,'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id=T.id ) final GROUP BY 1,2
SELECT MONTH,COUNTRY, SUM(CASE WHEN state='approved' then 1 else 0 end) as approved_count, SUM(CASE WHEN state = 'approved' then amount else 0 end) as approved_amount, SUM(CASE WHEN state='back' then 1 else 0 end) as chargeback_count, SUM(CASE WHEN state = 'back' then amount else 0 end) as chargeback_amount FROM ( SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved") X group by month,COUNTRY
SELECT SUBSTR(trans_date,1,7) AS month ,country ,SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) AS approved_count ,SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount ,SUM(CASE WHEN state='chargeback' THEN 1 ELSE 0 END) AS chargeback_count ,SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT c.trans_id AS id ,t.country ,'chargeback' AS state ,t.amount ,c.trans_date FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT * FROM Transactions) a GROUP BY 1,2 HAVING approved_count > 0 OR chargeback_count > 0
SELECT SUBSTRING(trans_date,1,7) AS month,country,SUM(state="approved") AS approved_count, IFNULL(SUM(CASE state WHEN "approved" THEN amount END),0) AS approved_amount,SUM(state="chargeback") AS chargeback_count, IFNULL(SUM(CASE state WHEN "chargeback" THEN amount END),0) AS chargeback_amount FROM (SELECT * FROM Transactions UNION (SELECT id,country, "chargeback" AS state,amount,c.trans_date AS trans_date FROM Chargebacks c JOIN Transactions t ON c.trans_id=t.id )) AS combine GROUP BY month,country HAVING (SUM(state="approved")+SUM(state="chargeback"))>0
SELECT SUBSTRING(trans_date,1,7) AS month,country,SUM(state="approved") AS approved_count, SUM(CASE state WHEN "approved" THEN amount ELSE 0 END) AS approved_amount,SUM(state="chargeback") AS chargeback_count, SUM(CASE state WHEN "chargeback" THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT * FROM Transactions UNION (SELECT id,country, "chargeback" AS state,amount,c.trans_date AS trans_date FROM Chargebacks c JOIN Transactions t ON c.trans_id=t.id )) AS combine GROUP BY month,country HAVING (SUM(state="approved")+SUM(state="chargeback"))>0
SELECT T1.month, T1.country, SUM(approved_count) AS approved_count, SUM(approved_amount) AS approved_amount, SUM(chargeback_count) chargeback_count, SUM(chargeback_amount) AS chargeback_amount FROM (SELECT LEFT(C.trans_date, 7) AS month, country, 0 AS approved_count, 0 AS approved_amount, COUNT(amount) AS chargeback_count, SUM(amount) AS chargeback_amount FROM Transactions T RIGHT JOIN Chargebacks C ON T.id = C.trans_id GROUP BY 1, 2 UNION ALL SELECT LEFT(trans_date, 7) AS month, country, COUNT(amount), SUM(amount), 0, 0 FROM Transactions WHERE state = 'approved' GROUP BY 1, 2) T1 GROUP BY 1, 2
SELECT a.month, a.country, COUNT(IF(a.state = 'approved', 1, NULL)) AS approved_count, SUM(IF(a.state = 'approved', a.amount, 0)) AS approved_amount, COUNT(IF(a.state = 'chargeback', 1, NULL)) AS chargeback_count, SUM(IF(a.state = 'chargeback', a.amount, 0)) AS chargeback_amount FROM ( SELECT DATE_FORMAT(c.trans_date, '%Y-%m') AS month, t.country, t.amount, 'chargeback' AS state FROM Transactions t JOIN Chargebacks c ON t.id = c.trans_id UNION ALL SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, amount, state FROM Transactions WHERE state = 'approved') a GROUP BY 1, 2
SELECT date_format(trans_date,'%Y-%m') as month,country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount FROM ( SELECT c.trans_id,t.country,'chargeback' as state,t.amount,c.trans_date FROM Transactions as t JOIN Chargebacks as c ON t.id=c.trans_id UNION SELECT * FROM Transactions) as a GROUP BY date_format(trans_date,'%Y-%m'),country having approved_count+approved_amount+chargeback_count+chargeback_amount != 0 ORDER BY date_format(trans_date,'%Y-%m')
SELECT day AS month, country, SUM(CASE WHEN type='trans' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN type='trans' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN type='charge' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN type='charge' THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT C.trans_id AS id, LEFT(C.trans_date, 7) AS day, T.amount, T.country, 'charge' AS type FROM Chargebacks C JOIN Transactions T ON C.trans_id = T.id UNION ALL SELECT id, LEFT(trans_date, 7) AS day, amount, country, 'trans' AS type FROM Transactions WHERE state = 'approved' ) AS T GROUP BY day, country ORDER BY day
SELECT g.month as month,c.country, SUM(CASE WHEN c.state="approved" AND SUBSTR(c.trans_date,1,7)=g.month THEN 1 ELSE 0 END) as approved_count, SUM(CASE WHEN c.state="approved" AND SUBSTR(c.trans_date,1,7)=g.month THEN amount ELSE 0 END) as approved_amount, SUM(CASE WHEN SUBSTR(d.trans_date,1,7)=g.month THEN 1 ELSE 0 END) as chargeback_count, SUM(CASE WHEN SUBSTR(d.trans_date,1,7)=g.month THEN c.amount ELSE 0 END) as chargeback_amount FROM Transactions as c LEFT JOIN Chargebacks as d ON c.id=d.trans_id JOIN ( SELECT SUBSTR(a.trans_date,1,7) as month FROM Transactions as a UNION SELECT SUBSTR(b.trans_date,1,7) FROM Chargebacks as b ) as g GROUP BY g.month,c.country having approved_count != 0 or approved_amount != 0 or chargeback_count != 0 or chargeback_amount != 0
SELECT month , country , SUM(IF(state = "approved", 1, 0)) AS approved_count , SUM(IF(state = "approved", amount, 0)) AS approved_amount , SUM(IF(state = "back", 1, 0)) AS chargeback_count , SUM(IF(state = "back", amount, 0)) AS chargeback_amount FROM( SELECT SUBSTR(trans_date, 1, 7) AS month , country , "approved" AS state , amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT SUBSTR(c.trans_date, 1, 7) AS month , t.country , "back" AS state , t.amount FROM Chargebacks c JOIN Transactions t ON t.id = c.trans_id ) tc GROUP BY 1, 2
SELECT month, country , SUM(state = "approved" ) AS approved_count , SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) AS approved_amount , SUM(state = "back") AS chargeback_count , SUM(CASE WHEN state = "back" THEN amount ELSE 0 END) AS chargeback_amount FROM( SELECT DATE_FORMAT(t1.trans_date, '%Y-%m') AS month, country, "back" AS state, amount FROM chargebacks AS t1 INNER JOIN transactions AS t2 ON t1.trans_id = t2.id UNION ALL SELECT DATE_FORMAT(t3.trans_date, '%Y-%m') AS month, country, state, amount FROM transactions AS t3 WHERE state = "approved" ) AS t4 GROUP BY month, country
SELECT month, country, COUNT(if(state='approved', 1, null)) AS approved_count, SUM(if(state='approved', amount, 0)) AS approved_amount, COUNT(if(state='back', 1, null)) AS chargeback_count, SUM(if(state='back', amount, 0)) AS chargeback_amount FROM ( SELECT LEFT(c.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks c JOIN transactions t ON c.trans_id = t.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved" ) backs_and_approvs GROUP BY 1, 2
SELECT month, country, IFNULL(COUNT(CASE WHEN state = 'approved' THEN 1 ELSE null END),0) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, IFNULL(COUNT(CASE WHEN state = 'cback' THEN 1 ELSE null END),0) AS chargeback_count, SUM(CASE WHEN state = 'cback' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT trans_id, country, "cback" AS state,amount, LEFT(Chargebacks.trans_date,7) AS month FROM Chargebacks JOIN Transactions ON Chargebacks.trans_id = Transactions.id UNION ALL SELECT id, country, state, amount, LEFT(trans_date,7) AS month FROM Transactions WHERE state = 'approved') temp1 GROUP BY month, country
SELECT month, country, SUM(CASE WHEN state = "approved" THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = "back" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = "back" THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(Chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM Chargebacks JOIN Transactions ON Chargebacks.trans_id = Transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM Transactions WHERE state = "approved" ) t GROUP BY month, country
SELECT month, country, SUM(CASE WHEN state = "approved" THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = "back" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = "back" THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved" ) s GROUP BY month, country
SELECT month, country, SUM(CASE WHEN state = "approved" THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = "declined" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = "declined" THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "declined" AS state, amount FROM chargebacks JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved") s GROUP BY month, country
SELECT month, country, SUM(CASE WHEN state = "approved" THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = "back" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT LEFT(Chargebacks.trans_date,7) AS month, country, "back" AS state, amount FROM Chargebacks JOIN Transactions ON Chargebacks.trans_id = Transactions.id UNION ALL SELECT LEFT(trans_date,7) AS month, country,state, amount FROM Transactions WHERE state = "approved") temp1 GROUP BY month, country
SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'back' THEN 1 ELSE 0 END) AS chargeback_count , SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(trans_date,7) AS month, country, "approved" AS state, amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT LEFT(c.trans_date,7) AS month, t.country, "back" AS state, t.amount FROM Transactions t JOIN Chargebacks c ON t.id = c.trans_id) t GROUP BY 1,2
SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'back' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = 'approved' ) s GROUP BY month, country
SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'back' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT LEFT(c.trans_date,7) AS month, 'back' AS state, amount, country FROM Chargebacks c JOIN Transactions t ON t.id = c.trans_id UNION ALL SELECT LEFT(trans_date,7) AS month, state, amount, country FROM Transactions WHERE state = 'approved' ) t GROUP BY 1,2
SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(c.trans_date, 7) AS month, country, amount, 'chargeback' AS state FROM Chargebacks c JOIN Transactions t ON t.id = c.trans_id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, amount, state FROM Transactions WHERE state = 'approved' ) a GROUP BY 1, 2
SELECT month, country, SUM(CASE WHEN state="approved" THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state="approved" THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state IS NULL THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state IS NULL THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(trans_date,7) AS month, country, state, amount FROM Transactions UNION ALL SELECT LEFT(a.trans_date,7) AS month, b.country, NULL AS state, b.amount FROM Chargebacks a JOIN Transactions b ON a.trans_id = b.id ) sub GROUP BY month, country HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
SELECT month, country, SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) approved_amount, SUM(CASE WHEN state='chargeback' THEN 1 ELSE 0 END) chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) chargeback_amount FROM (SELECT DATE_FORMAT(c.trans_date, '%Y-%m') month, country, "chargeback" AS state, amount FROM Chargebacks c JOIN Transactions t ON t.id=c.trans_id UNION ALL SELECT DATE_FORMAT(trans_date, '%Y-%m') month, country, state, amount FROM Transactions WHERE state='approved' ) a GROUP BY month, country
SELECT month, country, SUM(IF(state = 'approved', 1, 0)) AS approved_count, SUM(IF(state = 'approved', amount, 0)) AS approved_amount, SUM(IF(state = 'chargeback', 1, 0)) AS chargeback_count, SUM(IF(state = 'chargeback', amount, 0)) AS chargeback_amount FROM ( SELECT LEFT(a.trans_date, 7) AS month, country, 'chargeback' AS state, amount FROM Chargebacks a JOIN Transactions b ON a.trans_id = b.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM Transactions WHERE state = 'approved') CTE GROUP BY month, country
SELECT month, country, SUM(IF(state='approved', 1, 0)) AS approved_count, SUM(IF(state='approved', amount, 0)) AS approved_amount, SUM(CASE WHEN state = "back" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = "back" THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved" ) s GROUP BY month, country
SELECT month, country, SUM(IF(state='approved', 1, 0)) AS approved_count, SUM(IF(state='approved', amount, 0)) AS approved_amount, SUM(CASE WHEN state = "back" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = "back" THEN amount ELSE 0 END) AS chargeback_amount FROM ( SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks LEFT JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved" ) s GROUP BY month, country
SELECT month, country, SUM(approved_count) approved_count, SUM(approved_amount) approved_amount, SUM(chargeback_count) chargeback_count, SUM(chargeback_amount) chargeback_amount FROM( SELECT DATE_FORMAT(c.trans_date, "%Y-%m") month, t.country, 0 approved_count, 0 approved_amount, count(c.trans_id) chargeback_count, SUM(t.amount) chargeback_amount FROM Transactions t JOIN chargebacks c ON t.id=c.trans_id GROUP BY 1, 2 UNION SELECT DATE_FORMAT(t.trans_date, "%Y-%m") month, country, IFNULL(COUNT(DISTINCT CASE WHEN state='approved' THEN t.id END), 0) approved_count, IFNULL(SUM(CASE WHEN state='approved' THEN amount END),0) approved_amount, 0 chargeback_count, 0 chargeback_amount FROM Transactions t LEFT JOIN chargebacks c ON t.id=c.trans_id GROUP BY 1, 2 ) a GROUP BY 1,2 HAVING (approved_count + approved_amount + chargeback_count + chargeback_amount) >0
SELECT month, country, SUM(state = "approved") AS approved_count, SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) AS approved_amount, SUM(state = "back") AS chargeback_count, SUM(CASE WHEN state = "back" THEN amount ELSE 0 END) AS chargeback_amount FROM (SELECT LEFT(chargebacks.trans_date, 7) AS month, country, "back" AS state, amount FROM chargebacks JOIN transactions ON chargebacks.trans_id = transactions.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions WHERE state = "approved" ) s GROUP BY month, country
SELECT month, country, SUM(state='approved') as approved_count, sum(IF(state='approved', amount, 0)) as approved_amount, SUM(state='back') as chargeback_count, sum(IF(state='back', amount, 0)) as chargeback_amount FROM (SELECT LEFT(c.trans_date, 7) as month, country, 'back' as state, amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT LEFT(trans_date, 7) as month, country, state, amount FROM Transactions Where state = 'approved') as a GROUP BY month, country
SELECT t1.month, t1.country, IFNULL(t1.approved_count,0) AS approved_count, IFNULL(t1.approved_amount,0) AS approved_amount, IFNULL(t2.chargeback_count,0) AS chargeback_count, IFNULL(t2.chargeback_amount,0) AS chargeback_amount FROM ( SELECT LEFT(trans_date,7) AS month, country, COUNT(id) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state = "approved" GROUP BY month, country ) t1 LEFT JOIN ( SELECT LEFT(a.trans_date,7) AS month, b.country, COUNT(a.trans_id) AS chargeback_count, SUM(b.amount) AS chargeback_amount FROM Chargebacks a LEFT JOIN Transactions b ON a.trans_id = b.id GROUP BY month, country ) t2 ON t1.month = t2.month AND t1.country = t2.country UNION SELECT t2.month, t2.country, IFNULL(t1.approved_count,0) AS approved_count, IFNULL(t1.approved_amount,0) AS approved_amount, IFNULL(t2.chargeback_count,0) AS chargeback_count, IFNULL(t2.chargeback_amount,0) AS chargeback_amount FROM ( SELECT LEFT(trans_date,7) AS month, country, COUNT(id) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state = "approved" GROUP BY month, country ) t1 RIGHT JOIN ( SELECT LEFT(a.trans_date,7) AS month, b.country, COUNT(a.trans_id) AS chargeback_count, SUM(b.amount) AS chargeback_amount FROM Chargebacks a LEFT JOIN Transactions b ON a.trans_id = b.id GROUP BY month, country ) t2 ON t1.month = t2.month AND t1.country = t2.country
Select month, country, ifnull(sum(case when state = 'approved' then approved_count end),0) as approved_count, ifnull(sum(case when state = 'approved' then approved_amount end),0) as approved_amount, ifnull(sum(case when state = 'chargeback' then approved_count end),0) as chargeback_count, ifnull(sum(case when state = 'chargeback' then approved_amount end),0) as chargeback_amount from ( Select left(trans_date,7) as month, country, count(state) as approved_count, sum(amount) as approved_amount, 'approved' as state from Transactions where state = 'approved' group by left(trans_date,7), country Union Select left(c.trans_date,7) as month, country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount, 'chargeback' as state from Chargebacks c Join Transactions t on t.id = c.trans_id group by left(c.trans_date,7), country ) tc group by month, country
Select month, country, sum(if(state="approved",1,0)) as approved_count, sum(if(state="approved",amount,0)) as approved_amount, sum(if(state="chargebacks",1,0)) as chargeback_count, sum(if(state="chargebacks",amount,0)) as chargeback_amount from (Select date_format(trans_date, "%Y-%m") as month, country, state, amount, id from Transactions union all Select date_format(c.trans_date, "%Y-%m") as month, t.country, "chargebacks" as state, t.amount, c.trans_id from chargebacks c left join transactions t on t.id = c.trans_id) b group by 1,2 having sum(if(state="approved",1,0))!=0 or sum(if(state="approved",amount,0))!=0 or sum(if(state="chargebacks",1,0))!=0 or sum(if(state="chargebacks",amount,0))!=0
WITH AGG_TRANSACTION AS ( SELECT DATE_FORMAT(TRANS_DATE, '%Y-%m') AS MONTH, COUNTRY, SUM(CASE WHEN STATE='APPROVED' THEN 1 ELSE 0 END) AS APPROVED_COUNT, SUM(CASE WHEN STATE='APPROVED' THEN AMOUNT ELSE 0 END) AS APPROVED_AMOUNT FROM TRANSACTIONS GROUP BY DATE_FORMAT(TRANS_DATE, '%Y-%m'), COUNTRY ) , AGG_CHARGEBACKS AS ( SELECT DATE_FORMAT(C.TRANS_DATE, '%Y-%m') AS MONTH, T.COUNTRY, COUNT(TRANS_ID) AS chargeback_count, SUM(AMOUNT) AS chargeback_amount FROM CHARGEBACKS C JOIN TRANSACTIONS T ON C.TRANS_ID=T.ID GROUP BY DATE_FORMAT(C.TRANS_DATE, '%Y-%m'), T.COUNTRY ) SELECT T.*, IFNULL(chargeback_count ,0) AS chargeback_count , IFNULL(chargeback_amount ,0) AS chargeback_amount FROM AGG_TRANSACTION T LEFT JOIN AGG_CHARGEBACKS C USING(MONTH, COUNTRY) WHERE APPROVED_COUNT!=0 UNION SELECT C.MONTH, C.COUNTRY, IFNULL(APPROVED_COUNT ,0) AS APPROVED_COUNT , IFNULL(APPROVED_AMOUNT ,0) AS APPROVED_AMOUNT, chargeback_count, chargeback_amount FROM AGG_TRANSACTION T RIGHT JOIN AGG_CHARGEBACKS C USING(MONTH, COUNTRY)
WITH ALLTxns AS (SELECT LEFT(trans_date,7) AS month ,country ,state ,amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT LEFT(C.trans_date,7) AS month ,T.country ,"chargeback" AS state ,T.amount FROM Chargebacks C INNER JOIN Transactions T ON T.id = C.trans_id) SELECT month ,country ,SUM(IF(state = 'approved',1,0)) AS approved_count ,SUM(IF(state = 'approved',amount,0)) AS approved_amount ,SUM(IF(state = 'chargeback',1,0)) AS chargeback_count ,SUM(IF(state = 'chargeback',amount,0)) AS chargeback_amount FROM AllTxns GROUP BY month,country
WITH AllTxns AS (SELECT LEFT(trans_date,7) AS month ,country ,state ,amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT LEFT(C.trans_date,7) AS month ,T.country ,'chargeback' AS state ,T.amount FROM Chargebacks C INNER JOIN Transactions T ON T.id = C.trans_id) SELECT month ,country ,SUM(IF(state = 'approved',1,0)) AS approved_count ,SUM(IF(state = 'approved',amount,0)) AS approved_amount ,SUM(IF(state = 'chargeback',1,0)) AS chargeback_count ,SUM(IF(state = 'chargeback',amount,0)) AS chargeback_amount FROM AllTxns GROUP BY month,country
WITH Approved AS (SELECT country, DATE_FORMAT(trans_date, "%Y-%m") AS month, COUNT(*) AS cnt, SUM(amount) AS amnt FROM Transactions WHERE state = 'approved' GROUP BY country, month), Charged AS (SELECT t.country, DATE_FORMAT(c.trans_date, "%Y-%m") AS month, COUNT(*) AS cnt, SUM(t.amount) AS amnt FROM Chargebacks AS c LEFT JOIN Transactions AS t ON c.trans_id = t.id GROUP BY t.country, month) SELECT a1.month, a1.country, a1.cnt AS approved_count, a1.amnt AS approved_amount, ifnull(c1.cnt,0) AS chargeback_count, ifnull(c1.amnt,0) AS chargeback_amount FROM Approved AS a1 LEFT JOIN Charged AS c1 ON a1.month = c1.month AND a1.country = c1.country UNION ALL SELECT c2.month, c2.country, ifnull(a2.cnt,0) AS approved_count, ifnull(a2.amnt,0) AS approved_amount, c2.cnt AS chargeback_count, c2.amnt AS chargeback_amount FROM Charged AS c2 LEFT JOIN Approved AS a2 ON c2.month = a2.month AND c2.country = a2.country WHERE ifnull(a2.cnt,0) = 0
WITH CTE AS ( SELECT * FROM Transactions UNION SELECT C.trans_id AS id, T.country, 'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id = T.id ) SELECT LEFT(trans_date, 7) AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM CTE WHERE state IN ('approved', 'chargeback') GROUP BY 1, 2
WITH CTE AS ( SELECT country, "back" as state, amount, date_format(c.trans_date, '%Y-%m') as month FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT country, state, amount , date_format(t.trans_date, '%Y-%m') as month FROM Transactions t where t.state = 'approved' ) select month, country, Sum(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) as approved_count, Sum(CASE WHEN state = 'approved' THEN amount ELSE 0 END) as approved_amount, Sum(CASE WHEN state = 'back' THEN 1 ELSE 0 END) as chargeback_count, Sum(CASE WHEN state = 'back' THEN amount ELSE 0 END) as chargeback_amount FROM cte GROUP BY month, country
WITH CTE AS ( SELECT id, state, amount, trans_date, country FROM transactions t WHERE state = 'approved' UNION ALL SELECT trans_id, 'chargebacks' state, amount, c.trans_date, country FROM chargebacks c JOIN transactions t ON c.trans_id = t.id) SELECT DATE_FORMAT(trans_date, '%Y-%m') month, country, IFNULL(SUM(CASE WHEN state = 'approved' THEN 1 END), 0) approved_count, IFNULL(SUM(CASE WHEN state = 'approved' THEN amount END), 0) approved_amount, IFNULL(SUM(CASE WHEN state = 'chargebacks' THEN 1 END), 0) chargeback_count, IFNULL(SUM(CASE WHEN state = 'chargebacks' THEN amount END), 0) chargeback_amount FROM CTE GROUP BY 1, 2 ORDER BY 1
WITH CTE AS ( SELECT trans_id AS id, country, 'chargebacks' AS state, amount, Chargebacks.trans_date FROM Transactions JOIN Chargebacks ON id=trans_id UNION ALL SELECT * FROM Transactions ) SELECT LEFT(trans_date,7) AS month, country, SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state='chargebacks' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state='chargebacks' THEN amount ELSE 0 END) AS chargeback_amount FROM CTE GROUP BY 1,2 HAVING approved_count+approved_amount+chargeback_count+chargeback_amount<>0 ORDER BY 1,2
WITH CTE AS ((SELECT id, country, "chargeback" AS state, amount, LEFT(C.trans_date,7) AS trans_date FROM Chargebacks C JOIN Transactions T ON C.trans_id = T.id) UNION ALL SELECT * FROM Transactions) SELECT LEFT(trans_date,7) AS month, country, SUM(state='approved') AS approved_count, SUM(IF(state='approved',amount,0)) AS approved_amount, SUM(state='chargeback') AS chargeback_count, SUM(IF(state='chargeback',amount,0)) AS chargeback_amount FROM CTE GROUP BY 1,2 HAVING approved_count > 0 OR approved_amount > 0 OR chargeback_count > 0 OR chargeback_amount > 0
WITH CTE AS (SELECT trans_id, country, 'Chargebacks' state, amount, C1.trans_date FROM Chargebacks C1 LEFT JOIN Transactions T1 ON C1.trans_id = T1.id WHERE C1.trans_id IS NOT NULL UNION ALL SELECT * FROM Transactions WHERE state <> 'declined') SELECT LEFT(trans_date,7) month, country, SUM(state = 'approved') approved_count, SUM(IF(state = 'approved',amount,0)) approved_amount, SUM(state = 'Chargebacks') chargeback_count, SUM(IF(state = 'Chargebacks',amount,0)) chargeback_amount FROM CTE GROUP BY 1,2 ORDER BY 1,2
WITH CTE1 AS ( SELECT SUBSTR(trans_date, 1, 7) AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount FROM Transactions GROUP BY SUBSTR(trans_date, 1, 7), country), CTE2 AS ( SELECT country, amount, SUBSTR(Chargebacks.trans_date, 1, 7) AS month FROM Transactions JOIN Chargebacks ON Transactions.id = Chargebacks.trans_id), CTE3 AS ( SELECT month, country, COUNT(*) AS chargeback_count, SUM(amount) AS chargeback_amount FROM CTE2 GROUP BY month, country), mt AS ( SELECT month, country FROM CTE1 UNION SELECT month, country FROM CTE3 ), F AS ( SELECT mt.month, mt.country, IFNULL(CTE1.approved_count, 0) AS approved_count, IFNULL(CTE1.approved_amount, 0) AS approved_amount FROM mt LEFT JOIN CTE1 ON mt.month = CTE1.month AND mt.country = CTE1.COUNTRY), G AS ( SELECT F.*, IFNULL(chargeback_count, 0) AS chargeback_count, IFNULL(chargeback_amount, 0) AS chargeback_amount FROM F LEFT JOIN CTE3 ON F.month = CTE3.month AND F.country = CTE3.country) SELECT * FROM G WHERE approved_amount != 0 OR chargeback_amount != 0
WITH ChargeDet as ( select t.id, t.country, t.amount, DATE_FORMAT(c.trans_date, '%Y-%m') as month from Transactions as t join Chargebacks as c on t.id = c.trans_id ), ApproveTransDet as ( select id, country, amount, DATE_FORMAT(trans_date, '%Y-%m') as month from Transactions where state = 'approved' ), Summary as ( select month, country, count(*) as approved_count, sum(amount) as approved_amount, 'approved' as type from ApproveTransDet group by month, country union all Select month, country, count(*) as chargeback_count, sum(amount) as chargeback_amount, 'chargebacks' as type from ChargeDet group by month, country ) Select month, country, sum(case when type = 'approved' then approved_count else 0 end) as approved_count, sum(case when type = 'approved' then approved_amount else 0 end) as approved_amount, sum(case when type = 'chargebacks' then approved_count else 0 end) as chargeback_count, sum(case when type = 'chargebacks' then approved_amount else 0 end) as chargeback_amount from summary group by month, country order by month
WITH ChargebackGroup AS (SELECT T.country, LEFT(C.trans_date,7) AS month, COUNT(T.amount) as chargeback_count, SUM(T.amount) AS chargeback_amount FROM Chargebacks C JOIN Transactions T ON C.trans_id = T.id GROUP BY month, country) , ApprovedGroup AS (SELECT LEFT(T.trans_date, 7) AS month, country, SUM(state='approved') AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount FROM Transactions AS T GROUP BY month, country) SELECT A.month, A.country, IFNULL(approved_count, 0) approved_count, IFNULL(approved_amount, 0) approved_amount, IFNULL(chargeback_count, 0) chargeback_count, IFNULL(chargeback_amount, 0) chargeback_amount FROM ApprovedGroup A LEFT JOIN ChargebackGroup C ON A.month = C.month AND A.country = C.country WHERE approved_count>0 UNION SELECT C.month, C.country, IFNULL(approved_count, 0) approved_count, IFNULL(approved_amount, 0) approved_amount, IFNULL(chargeback_count, 0) chargeback_count, IFNULL(chargeback_amount, 0) chargeback_amount FROM ApprovedGroup A RIGHT JOIN ChargebackGroup C ON A.month = C.month AND A.country = C.country
WITH Chargebacks_merged AS ( SELECT c.trans_date, t.country, NULL state, t.amount, 'chargebacks' cat FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id ), total AS ( SELECT trans_date, country, state, amount, 'transactions' cat FROM Transactions UNION ALL SELECT trans_date, country, state, amount, cat FROM Chargebacks_merged ) SELECT DATE_FORMAT(trans_date, "%Y-%m") month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) approved_amount, SUM(CASE WHEN cat = 'chargebacks' THEN 1 ELSE 0 END) chargeback_count, SUM(CASE WHEN cat = 'chargebacks' THEN amount ELSE 0 END) chargeback_amount FROM total WHERE state = 'approved' OR cat = 'chargebacks' GROUP BY month, country
WITH MergeTrans as ( select t.id, t.country, t.state, t.amount, t.trans_date from Transactions as t where t.state = 'approved' UNION all select t.id, t.country, 'chargeback' as state, t.amount, c.trans_date from Transactions as t join Chargebacks as c on t.id = c.trans_id ) select DATE_FORMAT(trans_date, '%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from MergeTrans Group by DATE_FORMAT(trans_date, '%Y-%m'), country order by 1
WITH RECURSIVE a as (select date_format(trans_date, '%Y-%m') as month, country, sum(case when state='approved' then 1 else 0 end) as approved_acount,sum(case when state='approved' then amount else 0 end) as approved_amount from Transactions group by date_format(trans_date, '%Y-%m'), country), b as (select date_format(b.trans_date, '%Y-%m') cb_month,a.country cb_country,count(b.trans_id) as chargeback_count,sum(a.amount) as chargeback_amount from Chargebacks b left join Transactions a on b.trans_id=a.id group by date_format(b.trans_date, '%Y-%m'),a.country) select m.month, m.country, ifnull(a.approved_acount,0) approved_count,ifnull(a.approved_amount,0) approved_amount,ifnull(b.chargeback_count,0) chargeback_count,ifnull(b.chargeback_amount,0) chargeback_amount from (select month,country from a union select cb_month,cb_country from b) m left join a on m.month=a.month and m.country=a.country left join b on m.month=b.cb_month and m.country=b.cb_country where ifnull(a.approved_acount,0)!=0 or ifnull(b.chargeback_count,0)!=0
WITH T1 AS( SELECT LEFT(trans_date,7) AS month,country, COUNT(*) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state = 'approved' GROUP BY LEFT(trans_date,7),country), T2 AS ( SELECT LEFT(C.trans_date,7) AS month,country,COUNT(C.trans_id) AS chargeback_count ,SUM(amount) as chargeback_amount FROM Transactions T INNER JOIN Chargebacks C ON T.id = C.trans_id GROUP BY LEFT(C.trans_date,7),country), T3 AS ( SELECT LEFT(trans_date,7) AS month,country FROM Transactions UNION SELECT LEFT(CB.trans_date,7) AS month,country FROM Chargebacks CB INNER JOIN Transactions TR ON CB.trans_id = TR.id) SELECT T3.month,T3.country,COALESCE(approved_count,0) AS approved_count, COALESCE(approved_amount,0) AS approved_amount, COALESCE(chargeback_count,0) AS chargeback_count, COALESCE(chargeback_amount,0) AS chargeback_amount FROM T3 LEFT JOIN T1 ON T1.month = T3.month AND T1.country = T3.country LEFT JOIN T2 ON T2.month = T3.month AND T2.country = T3.country GROUP BY T3.month,T3.country HAVING approved_count+approved_amount+chargeback_count+chargeback_amount != 0
WITH all_trans AS ( SELECT * FROM Transactions UNION ALL SELECT t.id, t.country, 'chargeback' as state, t.amount, c.trans_date FROM Transactions t JOIN Chargebacks c ON t.id = c.trans_id ) SELECT DATE_FORMAT(trans_date,"%Y-%m") AS month, country, SUM(state = 'approved') as approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) as approved_amount, SUM(state = 'chargeback') as chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) as chargeback_amount FROM all_trans WHERE state <> 'declined' GROUP BY 1,2
WITH all_transactions AS ( SELECT DATE_FORMAT(c.trans_date, "%Y-%m") AS month, t.country, "chargeback" AS state, t.amount AS amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT DATE_FORMAT(trans_date, "%Y-%m") AS month, country, state, amount FROM Transactions ) SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM all_transactions GROUP BY 1, 2 HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0 ORDER BY month
WITH ap AS ( SELECT DATE_FORMAT(trans_date,"%Y-%m") month, country, COUNT(*) approved_count, SUM(amount) approved_amount FROM transactions WHERE state='approved' GROUP BY DATE_FORMAT(trans_date,"%Y-%m"), country ), cb AS ( SELECT DATE_FORMAT(c.trans_date,"%Y-%m") month, country, COUNT(*) chargeback_count, SUM(amount) chargeback_amount FROM chargebacks c JOIN transactions t ON c.trans_id=t.id GROUP BY DATE_FORMAT(c.trans_date,"%Y-%m"), country ) SELECT ap.month month, ap.country country, approved_count, approved_amount, IFNULL(chargeback_count,0) chargeback_count, IFNULL(chargeback_amount,0) chargeback_amount FROM ap LEFT JOIN cb ON ap.month=cb.month AND ap.country=cb.country UNION SELECT cb.month month, cb.country country, IFNULL(approved_count,0) approved_count, IFNULL(approved_amount,0) approved_amount, chargeback_count, chargeback_amount FROM ap RIGHT JOIN cb ON ap.month=cb.month AND ap.country=cb.country
WITH app as ( SELECT date_format(trans_date, '%Y-%m') as trans_date, country, SUM(amount) as amount, COUNT(amount) as approved_count FROM Transactions WHERE state = 'approved' GROUP BY date_format(trans_date, '%Y-%m'), country ), chargeback as ( SELECT date_format(c.trans_date, '%Y-%m') as trans_date, country, SUM(amount) as amount, COUNT(amount) as chargeback_count FROM Transactions t JOIN Chargebacks c ON c.trans_id = t.id GROUP BY date_format(c.trans_date, '%Y-%m'), country ) SELECT COALESCE(a.trans_date, c.trans_date) as month, COALESCE(a.country, c.country) as country, COALESCE(a.approved_count, 0) as approved_count, COALESCE(a.amount, 0) as approved_amount, COALESCE(c.chargeback_count, 0) as chargeback_count, COALESCE(c.amount, 0) as chargeback_amount FROM app a LEFT JOIN chargeback c ON a.trans_date = c.trans_date and c.country = a.country UNION DISTINCT SELECT COALESCE(a.trans_date, c.trans_date) as month, COALESCE(a.country, c.country) as country, COALESCE(a.approved_count, 0) as approved_count, COALESCE(a.amount, 0) as approved_amount, COALESCE(c.chargeback_count, 0) as chargeback_count, COALESCE(c.amount, 0) as chargeback_amount FROM app a RIGHT JOIN chargeback c ON a.trans_date = c.trans_date and c.country = a.country
WITH approve as (SELECT country, date_format(trans_date, '%Y-%m') as month, SUM(CASE WHEN state = 'approved' THEN 1 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount END) AS approved_amount FROM Transactions T GROUP BY country, month), chargeback as (SELECT T.country, date_format(C.trans_date, '%Y-%m')as month, count(C.trans_id) AS chargeback_count, SUM(T.amount) AS chargeback_amount FROM Transactions T, Chargebacks C WHERE T.id = C.trans_id GROUP BY country, month) (SELECT A1.month, A1.country, A1.approved_count, A1.approved_amount, IFNULL(C1.chargeback_count,0) as chargeback_count, IFNULL(C1.chargeback_amount,0) as chargeback_amount FROM approve A1 LEFT JOIN chargeback C1 ON (A1.country = C1.country AND A1.month = C1.month) WHERE A1.approved_count != 0) UNION (SELECT C1.month, C1.country, IFNULL(A1.approved_count,0) as approved_count, IFNULL(A1.approved_amount,0) as approved_amount, C1.chargeback_count, C1.chargeback_amount FROM approve A1 RIGHT JOIN chargeback C1 ON (A1.country = C1.country AND A1.month = C1.month)) ORDER BY month, country
WITH approved AS ( SELECT DATE_FORMAT(A.trans_date, '%Y-%m') AS month, country, COUNT(*) AS approved_count, SUM(amount) AS approved_amount FROM Transactions A WHERE state = 'approved' GROUP BY 1, 2 ), chargeback AS ( SELECT DATE_FORMAT(B.trans_date, '%Y-%m') AS month, country, COUNT(*) AS chargeback_count, SUM(amount) AS chargeback_amount FROM Transactions A RIGHT JOIN Chargebacks B ON A.id = B.trans_id GROUP BY 1, 2 ) SELECT A.month, A.country, COALESCE(approved_count, 0) AS approved_count, COALESCE(approved_amount, 0) AS approved_amount, COALESCE(chargeback_count, 0) AS chargeback_count, COALESCE(chargeback_amount,0) AS chargeback_amount FROM approved A LEFT JOIN chargeback B ON A.month = B.month and A.country = B.country UNION SELECT B.month, B.country, COALESCE(approved_count, 0) AS approved_count, COALESCE(approved_amount, 0) AS approved_amount, COALESCE(chargeback_count, 0) AS chargeback_count, COALESCE(chargeback_amount,0) AS chargeback_amount FROM approved A RIGHT JOIN chargeback B ON A.month = B.month and A.country = B.country
WITH approved AS ( SELECT DATE_FORMAT(A.trans_date, '%Y-%m') AS month, country, COUNT(*) AS approved_count, SUM(amount) AS approved_amount FROM Transactions A WHERE state = 'approved' GROUP BY 1, 2 ), chargeback AS ( SELECT DATE_FORMAT(B.trans_date, '%Y-%m') AS month, country, COUNT(*) AS chargeback_count, SUM(amount) AS chargeback_amount FROM Transactions A RIGHT JOIN Chargebacks B ON A.id = B.trans_id GROUP BY 1, 2 ) SELECT A.month, A.country, COALESCE(approved_count, 0) AS approved_count, COALESCE(approved_amount, 0) AS approved_amount, COALESCE(chargeback_count, 0) AS chargeback_count, COALESCE(chargeback_amount,0) AS chargeback_amount FROM approved A LEFT OUTER JOIN chargeback B ON A.month = B.month and A.country = B.country UNION SELECT B.month, B.country, COALESCE(approved_count, 0) AS approved_count, COALESCE(approved_amount, 0) AS approved_amount, COALESCE(chargeback_count, 0) AS chargeback_count, COALESCE(chargeback_amount,0) AS chargeback_amount FROM approved A RIGHT OUTER JOIN chargeback B ON A.month = B.month and A.country = B.country
WITH approved AS( SELECT DATE_FORMAT(trans_date, "%Y-%m") as month, country, COUNT(DISTINCT id) as approved_count, SUM(amount) as approved_amount FROM transactions GROUP BY country, month, state HAVING state = "approved" ), charged AS( SELECT month, country, COUNT(DISTINCT id) as chargeback_count, SUM(amount) as chargeback_amount FROM( SELECT t.id, DATE_FORMAT(c.trans_date, "%Y-%m") as month, t.country, t.amount FROM chargebacks c JOIN transactions t ON c.trans_id = t.id ) sub GROUP BY month, country ) SELECT a.month, a.country, a.approved_count, a.approved_amount, IFNULL(c.chargeback_count,0) as chargeback_count, IFNULL(c.chargeback_amount,0) as chargeback_amount FROM approved a LEFT JOIN charged c ON a.month = c.month AND a.country = c.country UNION SELECT c.month, c.country, IFNULL(a.approved_count,0) as approved_count, IFNULL(a.approved_amount,0) as approved_amount, c.chargeback_count, c.chargeback_amount FROM approved a RIGHT JOIN charged c ON a.month = c.month AND a.country = c.country
WITH approved_chargbacked_TABLE AS( SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country , state , amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT DATE_FORMAT(C.trans_date, '%Y-%m') AS month, country , "chargbacked" AS state , amount FROM Chargebacks C JOIN Transactions T ON C.trans_id = T.id ) SELECT month, country, SUM(IF(state = 'approved', 1, 0)) AS approved_count , SUM(IF(state = 'approved', amount, 0)) AS approved_amount , SUM(IF(state = 'chargbacked', 1, 0)) AS chargeback_count , SUM(IF(state = 'chargbacked', amount, 0)) AS chargeback_amount FROM approved_chargbacked_TABLE GROUP BY 1, 2
WITH approved_table AS ( SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, SUM(IF(state='approved', 1, 0)) AS approved_count, SUM(IF(state='approved', amount, 0)) AS approved_amount FROM transactions GROUP BY month, country), charge_back AS ( SELECT DATE_FORMAT(chargebacks.trans_date, '%Y-%m') AS month, country, COUNT(*) AS chargeback_count, SUM(amount) AS chargeback_amount FROM transactions JOIN chargebacks ON transactions.id = chargebacks.trans_id GROUP BY month, country) SELECT * FROM ( SELECT approved_table.month, approved_table.country, approved_count, approved_amount, IFNULL(chargeback_count, 0) AS chargeback_count, IFNULL(chargeback_amount, 0) AS chargeback_amount FROM approved_table LEFT JOIN charge_back ON charge_back.month = approved_table.month AND charge_back.country = approved_table.country UNION ALL SELECT charge_back.month, charge_back.country, IFNULL(approved_count, 0), IFNULL(approved_amount, 0), chargeback_count, chargeback_amount FROM approved_table RIGHT JOIN charge_back ON charge_back.month = approved_table.month AND charge_back.country = approved_table.country WHERE approved_count IS NULL) temp WHERE approved_count != 0 OR chargeback_count != 0
WITH approved_trans AS ( SELECT DATE_FORMAT(trans_date, "%Y-%m") AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount FROM Transactions GROUP BY 1, 2 ), chargeback_trans AS ( SELECT DATE_FORMAT(c.trans_date, "%Y-%m") AS month, t.country, COUNT(c.trans_id) AS chargeback_count, SUM(t.amount) AS chargeback_amount FROM Chargebacks c LEFT JOIN Transactions t ON c.trans_id = t.id GROUP BY 1, 2 ) SELECT * FROM (SELECT a.month, a.country, COALESCE(a.approved_count, 0) AS approved_count, COALESCE(a.approved_amount, 0) AS approved_amount, COALESCE(b.chargeback_count, 0) AS chargeback_count, COALESCE(b.chargeback_amount, 0) AS chargeback_amount FROM approved_trans a LEFT JOIN chargeback_trans b ON a.month = b.month AND a.country = b.country UNION SELECT b.month, b.country, COALESCE(a.approved_count, 0) AS approved_count, COALESCE(a.approved_amount, 0) AS approved_amount, COALESCE(b.chargeback_count, 0) AS chargeback_count, COALESCE(b.chargeback_amount, 0) AS chargeback_amount FROM approved_trans a RIGHT JOIN chargeback_trans b ON a.month = b.month AND a.country = b.country) sub WHERE approved_count+chargeback_count>0
WITH approved_transactions AS( SELECT DATE_FORMAT(trans_date, "%Y-%m") AS month, country, amount, 'approved' AS type FROM Transactions WHERE state = 'approved' ), chargebacks_and_transactions AS( SELECT DATE_FORMAT(c.trans_date, "%Y-%m") AS month, t.country AS country, t.amount AS amount, 'chargeback' AS type FROM Chargebacks c INNER JOIN Transactions t ON c.trans_id = t.id ) SELECT temp.month AS month, temp.country AS country, SUM(CASE WHEN type = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN type = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN type = 'chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN type = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM( SELECT * FROM approved_transactions UNION ALL SELECT * FROM chargebacks_and_transactions )temp GROUP BY 1,2 ORDER BY 2, 1
WITH chargebacks_new AS(SELECT c.trans_id id, t.country, 'chargeback' state, t.amount,c.trans_date FROM Chargebacks c JOIN Transactions t ON c.trans_id=t.id UNION ALL SELECT * FROM Transactions) SELECT DATE_FORMAT(trans_date,'%Y-%m') month, country, coalesce(SUM(CASE WHEN state='approved' THEN 1 END),0) approved_count, coalesce(SUM(CASE WHEN state='approved' THEN amount END),0) approved_amount, COALESCE(SUM(CASE WHEN state='chargeback' THEN 1 END),0) chargeback_count, COALESCE(SUM(CASE WHEN state='chargeback' THEN amount END),0) chargeback_amount FROM chargebacks_new GROUP BY 1,2 HAVING(approved_amount+chargeback_amount)<>0
WITH cte AS ( SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM Transactions a WHERE state='approved' UNION ALL SELECT LEFT(a.trans_date, 7) AS month, b.country, "back" AS state, b.amount FROM Chargebacks a LEFT JOIN Transactions b ON a.trans_id = b.id ) SELECT month, country, SUM(state='approved') as approved_count, SUM(case when state='approved' then amount else 0 end) as approved_amount, SUM(state='back') as chargeback_count, SUM(case when state='back' then amount else 0 end) as chargeback_amount FROM cte GROUP BY month, country
WITH cte AS ( SELECT date_format(c.trans_date, '%Y-%m') as month, t.country, 0 as state, 0 as amountstate, t.amount as amount FROM transactions t JOIN chargebacks c ON t.id = c.trans_id UNION ALL SELECT date_format(trans_date, '%Y-%m')as month, country, 1 as state, amount as amountstate, 0 as amount FROM transactions WHERE state = 'approved' ) SELECT month, country, sum(state) as approved_count, sum(amountstate) as approved_amount, count(state)-sum(state) as chargeback_count, sum(amount) as chargeback_amount FROM cte GROUP BY 1, 2 ORDER BY month
WITH cte AS ( SELECT date_format(c.trans_date, '%Y-%m') as month, t.country, 0 as state, t.amount FROM transactions t JOIN chargebacks c ON t.id = c.trans_id UNION ALL SELECT date_format(trans_date, '%Y-%m')as month, country, 1 as state, amount FROM transactions WHERE state = 'approved' ) SELECT month, country, sum(state) as approved_count, sum(amount*state) as approved_amount, count(state)-sum(state) as chargeback_count, sum(amount)-sum(amount*state) as chargeback_amount FROM cte GROUP BY 1, 2 ORDER BY month
WITH cte AS ((SELECT * FROM Transactions WHERE state = "approved") UNION ALL SELECT t.id, country,"chargebacks" AS state, amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id=c.trans_id ) SELECT DATE_FORMAT(trans_date,'%Y-%m') AS month, country , SUM(CASE WHEN state='approved'THEN 1 ELSE 0 END)approved_count, SUM(CASE WHEN state='approved'THEN amount ELSE 0 END) approved_amount, COUNT(CASE WHEN state='chargebacks' THEN 1 ELSE null END) AS chargeback_count, SUM(CASE WHEN state='chargebacks' THEN amount ELSE 0 END) AS chargeback_amount FROM cte GROUP BY 1,2
WITH cte AS (SELECT LEFT(trans_date,7) AS month, country, 'approved' AS state,amount FROM Transactions WHERE state='approved' UNION ALL SELECT LEFT(c.trans_date,7) AS month, country, 'back' AS state,amount FROM Chargebacks c JOIN Transactions t ON c.trans_id=t.id ) SELECT month, country, SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state='back' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state='back' THEN amount ELSE 0 END) AS chargeback_amount FROM cte GROUP BY 1,2 ORDER BY 1
WITH cte AS (SELECT id, country, "chargebacks" AS state, amount, c.trans_date FROM Transactions AS t RIGHT JOIN Chargebacks AS c ON c.trans_id = t.id UNION SELECT * FROM Transactions WHERE state = "approved") SELECT LEFT(trans_date, 7) AS month, country, SUM(IF(state = "approved", 1, 0)) AS approved_count, SUM(IF(state = "approved", amount, 0)) AS approved_amount, SUM(IF(state = "chargebacks", 1, 0)) AS chargeback_count, SUM(IF(state = "chargebacks", amount, 0)) AS chargeback_amount FROM cte GROUP BY LEFT(trans_date, 7), country
WITH cte1 AS( SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, COUNT(state) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state = 'approved' GROUP BY month, country ), cte2 AS( SELECT DATE_FORMAT(c.trans_date, '%Y-%m') AS month, country, COUNT(trans_id) AS chargeback_count, SUM(amount) AS chargeback_amount FROM Transactions t RIGHT JOIN Chargebacks c ON trans_id = id GROUP BY month, country ) SELECT cte1.month, cte1.country, CASE WHEN cte1.approved_count IS NULL THEN 0 ELSE cte1.approved_count END AS approved_count, CASE WHEN cte1.approved_amount IS NULL THEN 0 ELSE cte1.approved_amount END AS approved_amount, CASE WHEN cte2.chargeback_count IS NULL THEN 0 ELSE cte2.chargeback_count END AS chargeback_count, CASE WHEN cte2.chargeback_amount IS NULL THEN 0 ELSE cte2.chargeback_amount END AS chargeback_amount FROM cte1 LEFT JOIN cte2 ON cte1.month = cte2.month and cte1.country = cte2.country UNION SELECT cte2.month, cte2.country, CASE WHEN cte1.approved_count IS NULL THEN 0 ELSE cte1.approved_count END AS approved_count, CASE WHEN cte1.approved_amount IS NULL THEN 0 ELSE cte1.approved_amount END AS approved_amount, CASE WHEN cte2.chargeback_count IS NULL THEN 0 ELSE cte2.chargeback_count END AS chargeback_count, CASE WHEN cte2.chargeback_amount IS NULL THEN 0 ELSE cte2.chargeback_amount END AS chargeback_amount FROM cte1 RIGHT JOIN cte2 ON cte1.month = cte2.month and cte1.country = cte2.country
WITH cte_all AS ( SELECT id, country, state, amount, trans_date FROM Transactions WHERE state = 'approved' UNION SELECT t.id, t.country, 'chargeback' AS state, amount, c.trans_date FROM Transactions t INNER JOIN Chargebacks c ON t.id = c.trans_id ) SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM cte_all GROUP BY DATE_FORMAT(trans_date, '%Y-%m'), country
WITH getApproved AS ( SELECT DATE_FORMAT(trans_date,'%Y-%m') AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount FROM Transactions GROUP BY 1,2 ), getCharge AS ( SELECT DATE_FORMAT(c.trans_date, "%Y-%m") AS month, t.country, COUNT(*) AS chargeback_count, SUM(t.amount) AS chargeback_amount FROM Chargebacks c INNER JOIN Transactions t ON c.trans_id = t.id GROUP BY 1,2 ), getUnion AS ( SELECT COALESCE(getApproved.month, getCharge.month) AS month, COALESCE(getApproved.country, getCharge.country) AS country, COALESCE(getApproved.approved_count, 0) AS approved_count, COALESCE(getApproved.approved_amount, 0) AS approved_amount, COALESCE(getCharge.chargeback_count, 0) AS chargeback_count, COALESCE(getCharge.chargeback_amount, 0) AS chargeback_amount FROM getApproved LEFT OUTER JOIN getCharge ON getApproved.month = getCharge.month AND getApproved.country = getCharge.country UNION SELECT COALESCE(getApproved.month, getCharge.month) AS month, COALESCE(getApproved.country, getCharge.country) AS country, COALESCE(getApproved.approved_count, 0) AS approved_count, COALESCE(getApproved.approved_amount, 0) AS approved_amount, COALESCE(getCharge.chargeback_count, 0) AS chargeback_count, COALESCE(getCharge.chargeback_amount, 0) AS chargeback_amount FROM getApproved RIGHT OUTER JOIN getCharge ON getApproved.month = getCharge.month AND getApproved.country = getCharge.country ) SELECT * FROM getUnion WHERE approved_count + approved_amount + chargeback_count + chargeback_amount > 0
WITH income AS ( SELECT country, LEFT(Transactions.trans_date, 7) month, COUNT(Transactions.id) AS approved_count, SUM(Transactions.amount) AS approved_amount FROM Transactions WHERE state = 'approved' GROUP BY country, LEFT(Transactions.trans_date, 7) ), chargeback AS ( SELECT LEFT(C.trans_date, 7) AS month, country, COUNT(Transactions.id) AS chargeback_count, SUM(Transactions.amount) AS chargeback_amount FROM Transactions INNER JOIN Chargebacks C ON Transactions.id = C.trans_id GROUP BY country, LEFT(C.trans_date, 7) ) SELECT month, country, ifnull(approved_count, 0) AS approved_count, ifnull(approved_amount, 0) AS approved_amount, ifnull(chargeback_count, 0) AS chargeback_count, ifnull(chargeback_amount, 0) AS chargeback_amount FROM income LEFT OUTER JOIN chargeback USING (country, month) UNION SELECT month, country, ifnull(approved_count, 0) AS approved_count, ifnull(approved_amount, 0) AS approved_amount, ifnull(chargeback_count, 0) AS chargeback_count, ifnull(chargeback_amount, 0) AS chargeback_amount FROM income RIGHT OUTER JOIN chargeback USING (country, month)
WITH income AS ( SELECT country, date_format(trans_date, '%Y-%m') as month, COUNT(id) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state = 'approved' GROUP BY 1,2 ), chargeback AS ( SELECT date_format(c.trans_date, '%Y-%m') AS month, country, COUNT(t.id) AS chargeback_count, SUM(t.amount) AS chargeback_amount FROM Transactions t INNER JOIN Chargebacks c ON t.id = c.trans_id GROUP BY 2,1 ) SELECT month, country, ifnull(approved_count, 0) AS approved_count, ifnull(approved_amount, 0) AS approved_amount, ifnull(chargeback_count, 0) AS chargeback_count, ifnull(chargeback_amount, 0) AS chargeback_amount FROM income left JOIN chargeback USING (country, month) UNION SELECT month, country, ifnull(approved_count, 0) AS approved_count, ifnull(approved_amount, 0) AS approved_amount, ifnull(chargeback_count, 0) AS chargeback_count, ifnull(chargeback_amount, 0) AS chargeback_amount FROM income RIGHT JOIN chargeback USING (country, month)
WITH m AS ( SELECT DISTINCT LEFT(trans_date, 7) AS month FROM Transactions UNION SELECT DISTINCT LEFT(trans_date, 7) AS month FROM Chargebacks ), a AS ( SELECT LEFT(trans_date, 7) AS month, country, COUNT(id) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state = 'approved' GROUP BY month, country ), c AS ( SELECT LEFT(c.trans_date, 7) AS month, country, COUNT(trans_id) AS chargeback_count, SUM(amount) AS chargeback_amount FROM Chargebacks c INNER JOIN Transactions t ON c.trans_id = t.id GROUP BY month, country ), d AS ( SELECT DISTINCT month, country FROM a UNION SELECT DISTINCT month, country FROM c ) SELECT d.month, d.country, COALESCE(approved_count, 0) AS approved_count, COALESCE(approved_amount, 0) AS approved_amount, COALESCE(chargeback_count, 0) AS chargeback_count, COALESCE(chargeback_amount, 0) AS chargeback_amount FROM d LEFT JOIN a ON d.month = a.month AND d.country = a.country LEFT JOIN c ON d.month = c.month AND d.country = c.country
WITH main AS ( SELECT LEFT(trans_date,7) AS month, country, COUNT(id) approved_count, SUM(amount) approved_amount, 0 AS chargeback_count, 0 AS chargeback_amount FROM Transactions WHERE state = 'approved' GROUP BY month, country UNION SELECT LEFT(C.trans_date,7) AS month, country, 0 AS approved_count, 0 AS approved_amount, COUNT(trans_id) chargeback_count, SUM(amount) chargeback_amount FROM Chargebacks AS C INNER JOIN Transactions AS T ON C.trans_id = T.id GROUP BY month, country ) SELECT month, country, SUM(approved_count) approved_count, SUM(approved_amount) approved_amount, SUM(chargeback_count) chargeback_count, SUM(chargeback_amount) chargeback_amount FROM main GROUP BY month, country
WITH main AS ( SELECT LEFT(trans_date,7) AS month, country, COUNT(id) approved_count, SUM(amount) approved_amount, 0 AS chargeback_count, 0 AS chargeback_amount FROM Transactions WHERE state = 'approved' GROUP BY month, country UNION SELECT LEFT(C.trans_date,7) AS month, country, 0 AS approved_count, 0 AS approved_amount, COUNT(trans_id) chargeback_count, SUM(amount) chargeback_amount FROM Chargebacks AS C INNER JOIN Transactions AS T ON C.trans_id = T.id GROUP BY month, country ) SELECT month, country, SUM(approved_count) approved_count, SUM(approved_amount) approved_amount, SUM(chargeback_count) chargeback_count, SUM(chargeback_amount) chargeback_amount FROM main GROUP BY month, country HAVING approved_count + chargeback_count > 0
WITH master_table AS ( (SELECT trans_id, country, DATE_FORMAT(c.trans_date, '%Y-%m') AS date, amount AS chargeback_amount, 0 AS approved_amount FROM Chargebacks c LEFT JOIN Transactions t ON t.id = c.trans_id ) UNION ALL ( SELECT id, country, DATE_FORMAT(trans_date, '%Y-%m') AS date, 0 AS chargeback_amount, CASE WHEN state = "approved" THEN amount ELSE 0 END AS approved_amount FROM Transactions ) ) SELECT date AS month, country, COUNT(CASE WHEN approved_amount != 0 THEN approved_amount ELSE NULL END) AS approved_count, SUM(approved_amount) AS approved_amount, COUNT(CASE WHEN chargeback_amount != 0 THEN chargeback_amount ELSE NULL END) AS chargeback_count, SUM(chargeback_amount) AS chargeback_amount FROM master_table GROUP BY 1, 2 HAVING approved_amount != 0 OR chargeback_amount != 0
WITH summary AS ( SELECT DATE_FORMAT(c.trans_date, '%Y-%m') as month, t.country, 0 as approved_count, 0 as approved_amount, COUNT(*) as chargeback_count, SUM(t.amount) as chargeback_amount FROM chargebacks as c INNER JOIN transactions as t ON c.trans_id = t.id GROUP BY month, t.country UNION ALL SELECT DATE_FORMAT(trans_date, '%Y-%m') as month, country, COUNT(*) AS approved_count, SUM(amount) as approved_amount, 0 as chargeback_count, 0 as chargeback_amount FROM transactions WHERE state = 'approved' GROUP BY month, country) SELECT month, country, SUM(approved_count) as approved_count, SUM(approved_amount) as approved_amount, SUM(chargeback_count) as chargeback_count, SUM(chargeback_amount) as chargeback_amount FROM summary GROUP BY month, country
WITH t AS ( SELECT DATE_FORMAT(trans_date,"%Y-%m") month, country, amount, 'ap' ap_cb FROM transactions WHERE state='approved' UNION ALL SELECT DATE_FORMAT(c.trans_date,"%Y-%m") month, country, amount, 'cb' ap_cb FROM chargebacks c JOIN transactions t ON c.trans_id=t.id ) SELECT month, country, COUNT(IF(ap_cb='ap',1,null)) approved_count, SUM(IF(ap_cb='ap',amount,0)) approved_amount, COUNT(IF(ap_cb='cb',1,null)) chargeback_count, SUM(IF(ap_cb='cb',amount,0)) chargeback_amount FROM t GROUP BY month, country
WITH t AS ( SELECT LEFT(c.trans_date, 7) AS month, country, "chargeback" AS state, amount FROM chargebacks c JOIN transactions t ON c.trans_id = t.id UNION ALL SELECT LEFT(trans_date, 7) AS month, country, state, amount FROM transactions t WHERE state = "approved" ) SELECT month, country, SUM(state = "approved") AS approved_count, SUM(IF(state = 'approved', amount, 0)) AS approved_amount, SUM(state = "chargeback") AS chargeback_count, SUM(IF(state = "chargeback", amount, 0)) AS chargeback_amount FROM t GROUP BY month, country
WITH t AS ( SELECT c.trans_id, DATE_FORMAT(c.trans_date, '%Y-%m') AS month, country, 'chargeback' AS state, amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id UNION SELECT t.id, DATE_FORMAT(t.trans_date, '%Y-%m') AS month, country, state, amount FROM Transactions t) SELECT month, country, SUM(state = 'approved') AS approved_count, SUM(IF(state = 'approved', amount, 0)) AS approved_amount, SUM(state = 'chargeback') AS chargeback_count, SUM(IF(state = 'chargeback', amount, 0)) AS chargeback_amount FROM t GROUP BY month, country HAVING approved_count + approved_amount + chargeback_count + chargeback_amount != 0
WITH t as ( SELECT t.id, country, state, amount, t.trans_date FROM Transactions t union SELECT c.trans_id, country, "chargeback", amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id) SELECT date_format(trans_date, "%Y-%m") month, country, SUM(state = "approved") approved_count, SUM(CASE WHEN state = "approved" THEN amount else 0 end) approved_amount, SUM(state = "chargeback") as chargeback_count, SUM(CASE WHEN state = "chargeback" THEN amount else 0 end) chargeback_amount FROM t GROUP BY month, country HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
WITH t1 AS ( SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, COUNT(*) approved_count, SUM(amount) approved_amount FROM Transactions WHERE state = 'approved' GROUP BY month, country ), t2 AS ( SELECT DATE_FORMAT(Chargebacks.trans_date, '%Y-%m') AS month, country, COUNT(*) chargeback_count, SUM(amount) chargeback_amount FROM Transactions RIGHT JOIN Chargebacks ON Transactions.id = Chargebacks.trans_id GROUP BY month, country ) SELECT t1.*, COALESCE(t2.chargeback_count, 0) chargeback_count, COALESCE(t2.chargeback_amount, 0) chargeback_amount FROM t1 LEFT JOIN t2 ON t1.month = t2.month AND t1.country = t2.country UNION SELECT t2.month, t2.country, COALESCE(t1.approved_count, 0) approved_count, COALESCE(t1.approved_amount, 0) approved_amount, COALESCE(t2.chargeback_count, 0) chargeback_count, COALESCE(t2.chargeback_amount, 0) chargeback_amount FROM t1 RIGHT JOIN t2 ON t1.month = t2.month AND t1.country = t2.country
WITH t1 AS ( SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount FROM transactions GROUP BY 1,2 ) , t2 AS ( SELECT DATE_FORMAT(c.trans_date, '%Y-%m') AS month, t.country, COUNT(*) AS chargeback_count, SUM(t.amount) AS chargeback_amount FROM chargebacks c JOIN transactions t ON c.trans_id = t.id GROUP BY 1,2 ) SELECT t1.month, t1.country, t1.approved_count, t1.approved_amount, IFNULL(t2.chargeback_count, 0) AS chargeback_count, IFNULL(t2.chargeback_amount, 0) AS chargeback_amount FROM t1 LEFT JOIN t2 ON t1.month = t2.month AND t1.country = t2.country WHERE approved_count != 0 OR approved_amount != 0 UNION SELECT t2.month, t2.country, IFNULL(t1.approved_count, 0) AS approved_count, IFNULL(t1.approved_amount, 0) AS approved_amount, t2.chargeback_count, t2.chargeback_amount FROM t1 RIGHT JOIN t2 ON t1.month = t2.month AND t1.country = t2.country WHERE chargeback_count != 0 OR chargeback_amount != 0
WITH table1 AS( SELECT country, DATE_FORMAT(trans_date, '%Y-%m') AS month, COUNT(id) AS approved_count, SUM(amount) AS approved_amount FROM Transactions WHERE state='approved' GROUP BY country, month ), table2 AS( SELECT country, DATE_FORMAT(c.trans_date, '%Y-%m') AS month, COUNT(trans_id) AS chargeback_count, SUM(amount) AS chargeback_amount FROM Chargebacks c INNER JOIN Transactions t ON c.trans_id=t.id GROUP BY country, month ), table3 AS( SELECT country, month, approved_count, approved_amount, NULL AS chargeback_count, NULL AS chargeback_amount FROM table1 UNION ALL SELECT country, month, NULL AS approved_count, NULL AS approved_amount, chargeback_count, chargeback_amount FROM table2 ) SELECT country, month, SUM(IFNULL(approved_count,0)) AS approved_count, SUM(IFNULL(approved_amount,0)) AS approved_amount, SUM(IFNULL(chargeback_count,0)) AS chargeback_count, SUM(IFNULL(chargeback_amount,0)) AS chargeback_amount FROM table3 GROUP BY country, month
WITH temp AS ( (SELECT * FROM Transactions WHERE state = "approved") UNION ALL (SELECT t.id, country, "chargebacks" AS state, amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON c.trans_id = t.id )) SELECT LEFT(trans_date, 7) AS month, country, SUM(CASE WHEN state = "approved" THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = "chargebacks" THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = "chargebacks" THEN amount ELSE 0 END) AS chargeback_amount FROM temp GROUP BY 1,2
WITH temp AS ( (SELECT T.id, T.country, 'chargeback' AS state, T.amount, C.trans_date FROM Transactions T INNER JOIN Chargebacks C ON T.id = C.trans_id) UNION ALL (SELECT * FROM Transactions T2 WHERE T2.state = 'approved')) SELECT LEFT(trans_date, 7) AS month, country, SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state='chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM temp GROUP BY month, country
WITH temp AS (SELECT t.id, t.country, "back" AS state, t.amount, DATE_FORMAT(c.trans_date, '%Y-%m') AS month FROM Transactions t JOIN Chargebacks c ON t.id = c.trans_id UNION SELECT id, country, state, amount, DATE_FORMAT(trans_date, '%Y-%m') AS month FROM Transactions WHERE state = 'approved' ) SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'back' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) AS chargeback_amount FROM temp GROUP BY month, country ORDER BY 1
WITH temp AS( SELECT t.id, country, state, amount, t.trans_date FROM Transactions t UNION SELECT c.trans_id, country, "chargebacks", amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id) SELECT date_format(trans_date, "%Y-%m") as month, country, COUNT(CASE WHEN state = "approved" THEN 1 END) as approved_count, SUM(CASE WHEN state = "approved" THEN amount ELSE 0 END) as approved_amount, COUNT(CASE WHEN state = "chargebacks" THEN 1 END) as chargeback_count, SUM(CASE WHEN state = "chargebacks" THEN amount ELSE 0 END) as chargeback_amount FROM temp GROUP BY month, country HAVING approved_count + chargeback_count !=0
WITH temp_chargeback as ( SELECT LEFT(c.trans_date, 7) as month, country, 'back' as state, amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT LEFT(trans_date, 7) as month, country, state, amount FROM Transactions t WHERE state = 'approved' ) SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 else 0 END) as approved_count, SUM(CASE WHEN state = 'approved' THEN amount else 0 END) as approved_amount, SUM(CASE WHEN state = 'back' THEN 1 else 0 END) as chargeback_count, SUM(CASE WHEN state = 'back' THEN amount else 0 END) as chargeback_amount FROM temp_chargeback GROUP BY 1,2 ORDER BY 1
WITH temp_trans as ( SELECT left(trans_date, 7) as month, country, state, amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT left(c.trans_date, 7) as month , country, 'back' as state, amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id) SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) as approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) as approved_amount, SUM(CASE WHEN state = 'back' THEN 1 ELSE 0 END) as chargeback_count, SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) as chargeback_amount FROM temp_trans GROUP BY 1, 2 ORDER BY 1
WITH tmp AS ( SELECT date_format(c.trans_date,'%Y-%m') AS month,country, NULL AS approved_count,NULL AS approved_amount, COUNT(1) AS chargeback_count,SUM(amount) AS chargeback_amount FROM Chargebacks c LEFT JOIN Transactions t ON t.id=c.trans_id GROUP BY month,country UNION ALL SELECT date_format(trans_date,'%Y-%m') AS month,country, SUM(state='approved') AS approved_count, SUM(if(state='approved',amount,0)) AS approved_amount, NULL AS chargeback_count, NULL AS chargeback_amount FROM Transactions GROUP BY month,country) SELECT month,country, COALESCE(SUM(approved_count),0) AS approved_count, COALESCE(SUM(approved_amount),0) AS approved_amount, COALESCE(SUM(chargeback_count),0) AS chargeback_count, COALESCE(SUM(chargeback_amount),0) AS chargeback_amount FROM tmp GROUP BY month,country HAVING coalesce(sum(approved_count), 0) + coalesce(sum(approved_amount), 0) + coalesce(sum(chargeback_count), 0) + coalesce(sum(chargeback_amount), 0) <> 0
WITH tmp AS (SELECT DATE_FORMAT(trans_date, '%Y-%m') AS month, country, state, amount FROM Transactions WHERE state = 'approved' UNION ALL SELECT DATE_FORMAT(c.trans_date, '%Y-%m') AS month, t.country, 'chargeback' AS state, t.amount AS amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id) SELECT month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state = 'chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state = 'chargeback' THEN amount ELSE 0 END) AS chargeback_amount FROM tmp GROUP BY month, country
WITH trans AS( SELECT SUBSTRING(trans_date, 1, 7) as month, country, COUNT(*) as approved_count, SUM(amount) as approved_amount FROM Transactions WHERE state = 'approved' GROUP BY 1, 2), charge as (SELECT SUBSTRING(c.trans_date, 1, 7) as month, country, COUNT(*) as chargeback_count, SUM(amount) as chargeback_amount FROM Chargebacks c JOIN Transactions t ON c.trans_id = t.id GROUP BY 1, 2), all_months as(SELECT month, country FROM trans UNION SELECT month, country FROM charge) SELECT a.month, a.country, COALESCE(t.approved_count, 0) as approved_count, COALESCE(t.approved_amount, 0) as approved_amount, COALESCE(c.chargeback_count, 0) as chargeback_count, COALESCE(c.chargeback_amount, 0) as chargeback_amount FROM all_months a LEFT JOIN trans t ON t.month = a.month AND t.country = a.country LEFT JOIN charge c ON a.month = c.month AND a.country = c.country
WITH trans_table AS (SELECT SUBSTRING(trans_date,1,7) as month, country,COUNT(*) AS approved_count, SUM(amount) as approved_amount FROM Transactions WHERE state='approved' GROUP BY SUBSTRING(trans_date,1,7),country), chargeback_table AS ( SELECT SUBSTRING(c.trans_date,1,7) as month, t.country as country, COUNT(c.trans_id) as chargeback_count, SUM(t.amount) as chargeback_amount FROM Chargebacks c LEFT JOIN Transactions t ON c.trans_id=t.id GROUP BY 1,2) (SELECT tt.month as month,tt.country as country,tt.approved_count as approved_count, tt.approved_amount as approved_amount,COALESCE(ct.chargeback_count,0) as chargeback_count,COALESCE(ct.chargeback_amount,0) as chargeback_amount FROM trans_table tt LEFT JOIN chargeback_table ct ON tt.month=ct.month AND tt.country=ct.country) UNION (SELECT ct.month as month,ct.country as country,COALESCE(tt.approved_count,0) as approved_count, COALESCE(tt.approved_amount,0) as approved_amount,ct.chargeback_count as chargeback_count,ct.chargeback_amount as chargeback_amount FROM trans_table tt RIGHT JOIN chargeback_table ct ON tt.month=ct.month AND tt.country=ct.country)
WITH u AS ((SELECT * FROM Transactions WHERE state = "approved") UNION ALL (SELECT t.id, country, "chargebacks" AS state, amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id)) SELECT LEFT(trans_date,7) month, country, COUNT(CASE WHEN state='approved' THEN 1 ELSE null END)approved_count, SUM(CASE WHEN state='approved'THEN amount ELSE 0 END) approved_amount, COUNT(CASE WHEN state='chargebacks' THEN 1 ELSE null END)chargeback_count, SUM(CASE WHEN state='chargebacks' THEN amount ELSE 0 END)chargeback_amount FROM u GROUP BY 1,2
With trans_table As ((Select date_format(trans_date, "%Y-%m") as month, country, count(id) as approved_count, sum(amount) as approved_amount, null as chargeback_count, null as chargeback_amount From Transactions Where state = "approved" Group By date_format(trans_date, "%Y-%m"), country) Union (Select date_format(a.trans_date, "%Y-%m") as month, b.country as country, null as approved_count, null as approved_amount, count(a.trans_id) as chargeback_count, sum(b.amount) as chargeback_amount From Chargebacks as a Join Transactions as b On a.trans_id = b.id Group By date_format(a.trans_date, "%Y-%m"), b.country )) Select month, country, ifnull(sum(approved_count),0) as approved_count, ifnull(sum(approved_amount),0) as approved_amount, ifnull(sum(chargeback_count),0) as chargeback_count, ifnull(sum(chargeback_amount),0) as chargeback_amount From trans_table Group By month, country
select * from (select b.month, b.country, ifnull(b.approved_count,0) as approved_count, ifnull(b.approved_amount,0) as approved_amount, ifnull(D.chargeback_count,0) as chargeback_count, ifnull(D.chargeback_amount,0) as chargeback_amount from (select trans_month as month, country, sum(approve) as approved_count , sum(amount*approve) as approved_amount from (select *, date_format(trans_date, '%Y-%m') as trans_month, case when state = 'approved' then 1 else 0 end as approve from Transactions ) as a group by trans_month, country) as b left join (select month, country, count(amount) as chargeback_count , sum(amount) as chargeback_amount from (select A.month, B.country, B.amount from (select trans_id , date_format(trans_date, '%Y-%m') as month from Chargebacks ) as A left join Transactions as B on A.trans_id = B.id ) as C group by month, country) as D on b.month=D.month and b.country=D.country union select D.month, D.country, ifnull(b.approved_count,0) as approved_count, ifnull(b.approved_amount,0) as approved_amount, ifnull(D.chargeback_count,0) as chargeback_count, ifnull(D.chargeback_amount,0) as chargeback_amount from (select trans_month as month, country, sum(approve) as approved_count , sum(amount*approve) as approved_amount from (select *, date_format(trans_date, '%Y-%m') as trans_month, case when state = 'approved' then 1 else 0 end as approve from Transactions ) as a group by trans_month, country) as b right join (select month, country, count(amount) as chargeback_count , sum(amount) as chargeback_amount from (select A.month, B.country, B.amount from (select trans_id , date_format(trans_date, '%Y-%m') as month from Chargebacks ) as A left join Transactions as B on A.trans_id = B.id ) as C group by month, country) as D on b.month=D.month and b.country=D.country) as G where approved_count<>0 or approved_amount<>0 or chargeback_count<>0 or chargeback_amount<>0
select C.month, C.country, ifnull(approved_count,0) as 'approved_count', ifnull(approved_amount,0) as 'approved_amount', ifnull(chargeback_count,0) as 'chargeback_count', ifnull(chargeback_amount,0) as 'chargeback_amount' from ( select left(t.trans_date,7) as 'month', t.country from transactions t union select left(c.trans_date,7) as 'month', t.country from transactions t join chargebacks c on t.id = c.trans_id) C left join (select left(trans_date, 7) as 'month', country, sum(case when state = 'approved' then 1 else 0 end) as 'approved_count', sum(case when state = 'approved' then amount else 0 end) as 'approved_amount' from transactions group by left(trans_date, 7),country) as A on A.month= C.month and A.country = C.country left join (select left(c.trans_date,7) as 'month', country, count(trans_id) as 'chargeback_count', sum(amount) as 'chargeback_amount' from transactions t right join chargebacks c on t.id = c.trans_id group by left(c.trans_date,7) ,country) as B on C.month= B.month and C.country = B.country where ifnull(approved_count,0) <> 0 or ifnull(approved_amount,0) <> 0 or ifnull(chargeback_count,0) <> 0 or ifnull(chargeback_amount,0)<> 0
select a.month, a.country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'back' then 1 else 0 end) as chargeback_count, sum(case when state = 'back' then amount else 0 end) as chargeback_amount from ( select distinct id, left(trans_date, 7) as month, country, state, amount from transactions where state = 'approved' union all select b.id, left(a.trans_date, 7) as month, b.country, 'back' as state, b.amount from chargebacks a join transactions b on a.trans_id = b.id ) a group by a.month, a.country
select a.month,a.country, sum(a.approved_count) as approved_count, sum(a.approved_amount) as approved_amount, sum(a.chargeback_count) as chargeback_count, sum(a.chargeback_amount) as chargeback_amount from ( select substring(trans_date,1,7) month, country,count(*) approved_count,sum(amount) approved_amount, 0 as chargeback_count, 0 as chargeback_amount from Transactions t where state='approved' group by month,country union all select substring(c.trans_date,1,7) month, t.country country,0 as approved_count , 0 as approved_amount, count(*) chargeback_count ,sum(t.amount) chargeback_amount from Chargebacks c inner join Transactions t on t.id = c.trans_id group by month,country ) a group by a.month,a.country
select date_format(a.trans_date, '%Y-%m') month, a.country, sum(case when state = 'approved' then 1 else 0 end) approved_count, sum(case when state = 'approved' then amount else 0 end) approved_amount, sum(case when state = 'chargeback' then 1 else 0 end) chargeback_count, sum(case when state = 'chargeback' then amount else 0 end) chargeback_amount from ( select * from transactions union all select t.id,t.country,'chargeback' state, t.amount, c.trans_date from chargebacks c left join transactions t on c.trans_id = t.id ) a group by date_format(a.trans_date, '%Y-%m'), a.country having approved_count or chargeback_count
select date_format(case when trans_date is null then chargeback_date else trans_date end, '%Y-%m') month, country, sum(case when chargeback_date is null then 1 else 0 end) approved_count, sum(case when chargeback_date is null then amount else 0 end) approved_amount, sum(case when trans_date is null then 1 else 0 end) chargeback_count, sum(case when trans_date is null then amount else 0 end) chargeback_amount from ( select a.id, a.country, a.state, a.amount, a.trans_date, null as chargeback_date from transactions a where state = 'approved' union select a.id, a.country, a.state, a.amount, null, b.trans_date chargeback_date from transactions a right join chargebacks b on a.id = b.trans_id) a group by 1, 2
select date_format(trans_date, '%Y-%m') as month , country , sum(if(state='approved', 1, 0)) as approved_count , sum(if(state='approved', amount, 0)) as approved_amount , sum(if(state='chargeback', 1, 0)) as chargeback_count , sum(if(state='chargeback', amount, 0)) as chargeback_amount from ( select * from transactions t union select t.id, t.country, 'chargeback', t.amount, c.trans_date from chargebacks c left join transactions t on t.id=c.trans_id ) tmp group by 1, 2 having approved_count!=0 or approved_amount!=0 or chargeback_count!=0 or chargeback_amount!=0
select date_format(trans_date, '%Y-%m') as month , country , sum(if(state='approved', 1, 0)) as approved_count , sum(if(state='approved', amount, 0)) as approved_amount , sum(if(state='chargeback', 1, 0)) as chargeback_count , sum(if(state='chargeback', amount, 0)) as chargeback_amount from ( select * from transactions t where state='approved' union select t.id, t.country, 'chargeback', t.amount, c.trans_date from chargebacks c left join transactions t on t.id=c.trans_id ) tmp group by 1, 2
select date_format(trans_date, '%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from(select c.trans_id, t.country, 'chargeback' as state, t.amount, c.trans_date from Chargebacks as c join Transactions t on c.trans_id = t.id union all select * from Transactions) as t1 group by country, month having approved_amount > 0 or chargeback_amount > 0
select date_format(trans_date,"%Y-%m") as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from ( select * from transactions union select c.trans_id as id, t.country, 'chargeback' as state, t.amount, c.trans_date from chargebacks as c inner join transactions as t on c.trans_id=t.id) as a group by 1,2 having not (approved_count=0 and approved_amount=0 and chargeback_count=0 and chargeback_amount=0)
select date_format(trans_date,"%Y-%m") as month, country,sum(state='approved') as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(state='chargeback') as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from( (select id, country, state, amount, trans_date from transactions) union all (select t.id, t.country, "chargeback" as state, t.amount, c.trans_date from transactions as t join chargebacks as c on t.id=c.trans_id) )a group by date_format(trans_date,"%Y-%m"), country having sum(state='approved')>0 or sum(state='chargeback')>0
select date_format(trans_date,"%Y-%m") as month,country, SUM(CASE WHEN state='approved' THEN 1 ELSE 0 END) AS approved_count, SUM(CASE WHEN state='approved' THEN amount ELSE 0 END) AS approved_amount, SUM(CASE WHEN state='chargeback' THEN 1 ELSE 0 END) AS chargeback_count, SUM(CASE WHEN state='chargeback' THEN amount ELSE 0 END) AS chargeback_amount from (select a.trans_id as id, b.country as country,"chargeback" as state, b.amount as amount, a.trans_date as trans_date from chargebacks a left join transactions b on a.trans_id=b.id union all select * from transactions) a group by 1,2 having (approved_count,approved_amount,chargeback_count,chargeback_amount) != (0,0,0,0)
select date_format(trans_date,'%Y-%m') AS month, country, count(case when state ='approved' then 1 else null end ) as approved_count, sum(case when state ='approved' then amount else 0 end ) as approved_amount, count(case when state ='chargeback' then 1 else null end ) as chargeback_count, sum(case when state ='chargeback' then amount else 0 end ) as chargeback_amount from (select c.trans_id, t.country, 'chargeback' as state, amount, c.trans_date from Chargebacks c inner join Transactions t on c.trans_id = t.id union all select id, country, state, amount, trans_date from Transactions ) a group by 1,2 having approved_amount <>0 or chargeback_amount <>0 order by 1,2
select date_format(trans_date,'%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) approved_count, sum(case when state = 'approved' then amount else 0 end) approved_amount, sum(case when state = 'CB' then 1 else 0 end) chargeback_count, sum(case when state = 'CB' then amount else 0 end) chargeback_amount from( select id, country, 'CB' as state,amount, c.trans_date from transactions t right join chargebacks c on t.id = c.trans_id union all select * from transactions) a group by 1,2 HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
select date_format(trans_date,'%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state = 'chargebacks' then 1 else 0 end) as chargeback_count, sum(case when state='chargebacks' then amount else 0 end) as chargeback_amount from (select trans_id as id, country, 'chargebacks' as state, amount, Chargebacks.trans_date from Chargebacks join Transactions on Chargebacks.trans_id = Transactions.id UNION select * from Transactions where state = 'approved') t group by month, country
select date_format(trans_date,'%Y-%m') as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state ='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from( SELECT DISTINCT * FROM Transactions where state='approved' UNION ALL SELECT DISTINCT C.trans_id AS id,T.country,'chargeback' AS state, T.amount, C.trans_date FROM Chargebacks C LEFT JOIN Transactions T ON C.trans_id=T.id ) a group by month, country
select date_format(trans_date,'%Y-%m') as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from ( select * from Transactions UNION select C.trans_id as id, T.country, 'chargeback' as state,T.amount,C.trans_date as trans_date from Transactions T, Chargebacks C where C.trans_id=T.id ) temp group by month,country having (approved_count+approved_amount+chargeback_count+chargeback_amount) > 0
select date_format(trans_date,'%Y-%m') as month, country, sum(if(state='approved',1,0)) as approved_count, sum(if(state='approved',amount,0)) as approved_amount, sum(if(state='chargeback',1,0)) as chargeback_count, sum(if(state='chargeback',amount,0)) as chargeback_amount from(select c.trans_id as id, t.country, 'chargeback' as state, t.amount, c.trans_date from transactions t join chargebacks c on t.id=c.trans_id union all select * from Transactions where state='approved') temp group by month, country
select f1.month, f1.country, approved_count, approved_amount, ifnull(chargeback_count,0) chargeback_count, ifnull(chargeback_amount,0) chargeback_amount from ( select left(t.trans_date,7) month, t.country, count(*) approved_count, sum(amount) approved_amount from transactions t where state='approved' group by left(t.trans_date,7),country) f1 left join ( select left(c.trans_date,7) month, country, count(trans_id) chargeback_count, sum(amount) chargeback_amount from chargebacks c join transactions t on c.trans_id = t.id group by left(c.trans_date,7),country) f2 on f1.month = f2.month and f1.country = f2.country union select f4.month, f4.country,ifnull(approved_count,0) approved_count, ifnull(approved_amount,0) approved_amount, chargeback_count, chargeback_amount from ( select left(t.trans_date,7) month, t.country, count(*) approved_count, sum(amount) approved_amount from transactions t where state='approved' group by left(t.trans_date,7),country) f3 right join ( select left(c.trans_date,7) month, country, count(trans_id) chargeback_count, sum(amount) chargeback_amount from chargebacks c join transactions t on c.trans_id = t.id group by left(c.trans_date,7),country) f4 on f3.month = f4.month and f3.country = f4.country order by month, country
select left (trans_date,7) as month, country, count(case when state='approved' then id else null end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, count(case when state='chargeback' then id else null end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from (select id,country,state,amount,trans_date from Transactions where state='approved' union all select a.id,a.country,'chargeback' as state,a.amount,b.trans_date from Transactions a join Chargebacks b on a.id=b.trans_id) a group by month, country
select left(cte.trans_date,7)as month, cte.country, sum(case when state='approved'then 1 else 0 end)as approved_count, sum(case when state='approved'then amount else 0 end)as approved_amount, sum(case when state='chargeback'then 1 else 0 end)as chargeback_count, sum(case when state='chargeback'then amount else 0 end)as chargeback_amount from (SELECT c.trans_id, t.country, 'chargeback' as state, t.amount, c.trans_date from Chargebacks as c JOIN Transactions t ON c.trans_id = t.id UNION ALL SELECT * FROM Transactions)cte group by 1,2 HAVING approved_amount>0 OR chargeback_amount>0 order by 1
select left(temp.trans_date,7) as month, temp.country, sum(temp.state="approved") as approved_count, sum(case when temp.state="approved" then temp.amount else 0 end) as approved_amount, sum(temp.state="chargeback") as chargeback_count, sum(case when temp.state="chargeback" then temp.amount else 0 end) as chargeback_amount from (select * from transactions union all select c.trans_id as id, t.country, "chargeback" as state, t.amount, c.trans_date from chargebacks c left join transactions t on t.id=c.trans_id) as temp group by left(temp.trans_date,7), temp.country having sum(temp.state="approved")+sum(case when temp.state="approved" then temp.amount else 0 end)+ sum(temp.state="chargeback")+ sum(case when temp.state="chargeback" then temp.amount else 0 end)!=0
select left(trans_date, 7) as month, country, ifnull(count(distinct case when state='approved' then id else null end ), 0) as approved_count, ifnull(sum(case when state='approved' then amount else 0 end ), 0) as approved_amount, ifnull(count(distinct case when state='chargeback' then id else null end ), 0) as chargeback_count, ifnull(sum(case when state='chargeback' then amount else 0 end ), 0) as chargeback_amount from ( ( select * from transactions where state='approved' ) union all ( select c.trans_id as id, t.country, 'chargeback' as state, t.amount, c.trans_date from chargebacks c left join Transactions t on c.trans_id = t.id ) )_ group by 1,2
select left(trans_date, 7) as month, country, sum(state = 'approved') as approved_count, sum(case when state = 'approved'then amount else 0 end) as approved_amount, sum(state = 'chargebacks') as chargeback_count, sum(case when state = 'chargebacks'then amount else 0 end) as chargeback_amount from (select * from transactions where state = 'approved' union all select trans_id as id, country, 'chargebacks' as state, amount, c.trans_date from chargebacks c left join transactions t on c.trans_id = t.id) t group by 1,2
select left(trans_date,7) as month , country , sum(state='approved') as approved_count , sum(case when state = 'approved' then amount else 0 end) as approved_amount , sum(state='chargeback') as chargeback_count , sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from (select * from transactions union all (select distinct trans_id as id, country, 'chargeback' as state, amount, charge.trans_date from chargebacks as charge left join transactions trans on charge.trans_id = trans.id)) temp1 where state in ('approved', 'chargeback') group by country ,month
select left(trans_date,7) as month, country, count(case when state = 'approved' then trans_id else null end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, count(case when state = 'chargeback' then trans_id else null end) as chargeback_count, sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from ( select trans_id, country, 'chargeback' as state, amount, chargebacks.trans_date from chargebacks join transactions on chargebacks.trans_id = transactions.id union select id, country, state, amount, trans_date from transactions) as t where state in ('approved', 'chargeback') group by 1, 2 order by 1,2
select left(trans_date,7) as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='back' then 1 else 0 end) as chargeback_count, sum(case when state='back' then amount else 0 end) as chargeback_amount from ( select id, country, "back" as state, amount,C.trans_date from Transactions T join Chargebacks C on T.id = C.trans_id union all select id, country, state, amount, trans_date from Transactions where state = 'approved' ) tbl group by 1,2 order by 1,2
select left(trans_date,7) as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargedback' then 1 else 0 end) as chargeback_count, sum(case when state='chargedback' then amount else 0 end) as chargeback_amount from (select * from transactions where state='approved' union all select c.trans_id, ifnull(t.country,null) as country, 'chargedback' as state, ifnull(t.amount,0) as amount, c.trans_date from chargebacks c inner join transactions t on c.trans_id=t.id) t1 group by month, country
select left(trans_date,7) as month, country, sum(state='approved') as approved_count, sum(if(state='approved',amount,0)) as approved_amount, sum(state='chargeback') as chargeback_count, sum(if(state='chargeback',amount,0)) as chargeback_amount from ( (select * from Transactions) union all ( select t.id, t.country, 'chargeback' as state, t.amount, c.trans_date from Chargebacks c left join Transactions t on t.id= c.trans_id))a group by month,country HAVING approved_amount>0 OR chargeback_amount>0
select left(trans_date,7) month, country, ifnull(sum(state ='approved'),0) approved_count, sum(case when state ='approved' then amount else 0 end) approved_amount, ifnull(sum(state = 'chargeback'),0) chargeback_count, sum(case when state ='chargeback' then amount else 0 end) chargeback_amount from ( select trans_id id, country,'chargeback' as state, amount, b.trans_date from transactions a join chargebacks b on a.id = b.trans_id union select * from transactions where state ='approved') t group by 1,2
select left(trans_date,7)as month, country, sum(case when state='approved' then 1 else 0 end)as approved_count, sum(case when state='approved'then amount else 0 end)as approved_amount, sum(case when state='chargebacks'then 1 else 0 end)as chargeback_count, sum(case when state='chargebacks'then amount else 0 end)as chargeback_amount from (select c.trans_id, t.country, 'chargebacks'as state, t.amount, c.trans_date from chargebacks c join transactions t on c.trans_id=t.id union all select * from transactions)cte group by 1,2 having chargeback_amount>0 or approved_amount>0 order by 1
select mnth as month, country, sum(case when state = "approved" then 1 else 0 end) as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(case when state = "Chargeback" then 1 else 0 end) as chargeback_count, sum(case when state = "Chargeback" then amount else 0 end) as chargeback_amount from (select concat(year(trans_date), '-0',month(trans_date)) as mnth, country, state, amount from transactions where state = 'approved' union all select concat(year(c.trans_date), '-0',month(c.trans_date)) as mnth, country, 'Chargeback' as state, amount from chargebacks c left join transactions t on t.id = c.trans_id)a group by mnth, country
select month , country , sum(state = 'approved') as approved_count , sum(if(state = 'approved', amount, 0)) as approved_amount , sum(state = 'chargeback') as chargeback_count , sum(if(state = 'chargeback', amount, 0)) as chargeback_amount from (select left(trans_date, 7) as month , country , state , amount from transactions where state = 'approved' union all select left(c.trans_date, 7) as month , country , 'chargeback' as state , amount from chargebacks c join transactions t on t.id = c.trans_id ) temp group by 1,2
select month, country, SUM(state= 'approved') as approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) as approved_amount, SUM(state= 'back') as chargeback_count, SUM(CASE WHEN state = 'back' THEN amount ELSE 0 END) as chargeback_amount from (select LEFT(c.trans_date, 7) as month, t.country, 'back' as state, t.amount as amount from Chargebacks c JOIN Transactions t On c.trans_id = t.id UNION ALL select LEFT(trans_date, 7) as month, country, state, amount from Transactions where state = 'approved') t group by month, country
select month, country, count(case when sr = 'income' then amount else null end) approved_count, sum(case when sr = 'income' then amount else 0 end) approved_amount, count(case when sr = 'chargeback' then amount else null end) chargeback_count, sum(case when sr = 'chargeback' then amount else 0 end) chargeback_amount from( select country, amount, left(trans_date,7) month, 'income' as sr from transactions where state = 'approved' union all select t.country, t.amount, left(c.trans_date,7) month, 'chargeback' as sr from transactions t join chargebacks c on t.id = c.trans_id )final group by month, country
select month, country, ifnull(count(case when state = 'approved' then 1 end), 0) as approved_count, ifnull(sum(case when state = 'approved' then amount end), 0) as approved_amount, ifnull(count(case when state = 'back' then 1 end), 0) as chargeback_count, ifnull(sum(case when state = 'back' then amount end), 0) as chargeback_amount from (select left(c.trans_date, 7) as month, country, 'back' as state, amount from Chargebacks c join Transactions t on c.trans_id = t.id union all select left(trans_date, 7) as month, country, state, amount from Transactions where state = 'approved') as tb group by month, country
select month, country, max(case when state = 'approved' then cnt else 0 end) as approved_count, max(case when state = 'approved' then amount else 0 end) as approved_amount, max(case when state = 'chargeback' then cnt else 0 end) as chargeback_count, max(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from ((select LEFT(trans_date,7) as month, country, state, count(distinct id) as cnt, sum(amount) as amount from transactions where state = 'approved' group by 1,2) union all (select LEFT(c.trans_date,7) as month, t.country, 'chargeback' as state, count(distinct c.trans_id) as cnt, sum(t.amount) as amount from chargebacks c left join transactions t on t.id = c.trans_id and t.trans_date <= c.trans_date group by 1,2)) t group by 1,2
select month, country, sum(a.approved_count) approved_count, sum(a.approved_amount) approved_amount, sum(a.chargeback_count) chargeback_count, sum(a.chargeback_amount) chargeback_amount from ( select left(c.trans_date, 7) as month, country, 0 approved_count, 0 approved_amount, count(*) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks c left join Transactions t on t.id = c.trans_id group by month, country union all select left(trans_date, 7) as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, 0 chargeback_count, 0 chargeback_amount from Transactions group by month, country ) a where (approved_count, approved_amount, chargeback_count,chargeback_amount) <> (0, 0, 0, 0) group by a.month, a.country
select month, country, sum(approved_count) as approved_count, sum(approved_amount) as approved_amount, sum(chargeback_count) as chargeback_count, sum(chargeback_amount) as chargeback_amount from ( select date_format(trans_date, '%Y-%m') as month, country, count(id) as approved_count, sum(amount) as approved_amount, 0 as chargeback_count, 0 as chargeback_amount from transactions where state = 'approved' group by month, country union all select date_format(b.trans_date,'%Y-%m') as month, a.country, 0 as approved_count, 0 as approved_amount, count(b.trans_id) as chargeback_count, sum(a.amount) as chargeback_amount from chargebacks b inner join transactions a on b.trans_id = a.id group by month, country )sub group by month, country
select month, country, sum(approved_count) as approved_count, sum(approved_amount) as approved_amount, sum(chargeback_count) as chargeback_count, sum(chargeback_amount) as chargeback_amount from ( select left(trans_date, 7) as month, country, count(*) as approved_count, sum(amount) as approved_amount, 0 as chargeback_count, 0 as chargeback_amount from Transactions where state = 'approved' group by month, country union all select left(c.trans_date, 7) as month, t.country as country, 0 as approved_count, 0 as approved_amount, count(*) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks c inner join Transactions t on c.trans_id = t.id group by month, country ) as tab group by month, country
select month, country, sum(case when state = "approved" then 1 else 0 end) as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(case when state = "back" then 1 else 0 end) as chargeback_count, sum(case when state = "back" then amount else 0 end) as chargeback_amount from ( select left(chargebacks.trans_date, 7) as month, country, "back" as state, amount from chargebacks join transactions on chargebacks.trans_id = transactions.id union all select left(trans_date, 7) as month, country, state, amount from transactions where state = "approved" ) s group by month, country order by month, country
select month, country, sum(case when state = 'approved' then 1 else 0 end) approved_count, sum(case when state = 'approved' then amount else 0 end) approved_amount, sum(case when state = 'back' then 1 else 0 end) chargeback_count, sum(case when state = 'back' then amount else 0 end) chargeback_amount from (select left(trans_date, 7) month, country, state, amount from Transactions where state = 'approved' union all select left(c.trans_date, 7) month, country, 'back' state, amount from Transactions t join Chargebacks c on t.id = c.trans_id) t group by month, country
select month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'back' then 1 else 0 end) as chargeback_count, sum(case when state = 'back' then amount else 0 end) as chargeback_amount from (select left(c.trans_date, 7) as month, country, 'back' as state, amount from Chargebacks c join Transactions t on c.trans_id = t.id union all select left(trans_date, 7) as month, country, state, amount from Transactions where state = 'approved') as tb group by month, country
select month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'back' then 1 else 0 end) as chargeback_count, sum(case when state = 'back' then amount else 0 end) as chargeback_amount from( select left(c.trans_date,7) as month, country, amount, 'back' as state from transactions t join chargebacks c on t.id = c.trans_id union all select left(trans_date,7), country, amount, state from transactions where state = 'approved') sub group by 1, 2
select month, country, sum(case when state ='approved'then 1 else 0 end) approved_count, sum(case when state = 'approved' then amount else 0 end) approved_amount, sum(case when state ='back'then 1 else 0 end) chargeback_count, sum(case when state = 'back' then amount else 0 end) chargeback_amount from (select date_format(c.trans_date,'%Y-%m') month, country, 'back' as state, amount from chargebacks c join transactions t on c.trans_id = t.id union all select date_format(t.trans_date,'%Y-%m') month, country, state, amount from transactions t WHERE state = "approved" ) a group by month,country
select month, country, sum(case when state= 'approved' then 1 else 0 end) as approved_count, sum(case when state= 'approved' then amount else 0 end) as approved_amount, sum(case when state= 'back' then 1 else 0 end) as chargeback_count, sum(case when state= 'back' then amount else 0 end) as chargeback_amount from( select date_format(c.trans_date, '%Y-%m') as month, trans_id, country, 'back' as state, amount from Chargebacks as c left join Transactions as t on c.trans_id= t.id union select date_format(t.trans_date, '%Y-%m') as month, id as trans_id, country, state, amount from Transactions as t where state = 'approved') as tb1 group by 1,2
select month, country, sum(case when state='approved' then 1 else 0 end) approved_count, sum(case when state='approved' then amount else 0 end) approved_amount, sum(case when state='back' then 1 else 0 end) chargeback_count, sum(case when state='back' then amount else 0 end) chargeback_amount from ( select trans_id,left(chargebacks.trans_date,7) month, country,'back' as state, amount from chargebacks left join transactions on chargebacks.trans_id = transactions.id union select id, left(trans_date,7) month, country, state, amount from transactions where state='approved' ) temp group by month, country
select month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from ( select left(c.trans_date,7) as month, t.country, 'chargeback' as state, amount from chargebacks c join transactions t on c.trans_id=t.id Union all select left(trans_date,7) as month, country, state, amount from transactions where state='approved' ) cba group by month, country
select month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from (select id, left(c.trans_date,7) as month, country, 'chargeback' as state, amount from Transactions a, Chargebacks c where a.id = c.trans_id union all select id, left(trans_date,7) as month, country, state, amount from Transactions where state = 'approved') combine group by month, country
select month, country, sum(case when tag = 'approved' then 1 else 0 end) as approved_count, sum(case when tag = 'approved' then amount else 0 end) as approved_amount, sum(case when tag = 'chargeback' then 1 else 0 end) as chargeback_count , sum(case when tag = 'chargeback' then amount else 0 end) as chargeback_amount from ( select left(trans_date,7) as month, country, amount, 'approved' as tag from Transactions where state = 'approved' union all select left(c2.trans_date,7) as month,country, amount, 'chargeback' as tag from Chargebacks as c2 left join Transactions as t2 on t2.id = c2.trans_id ) as temp group by country,month
select month, country, sum(case when type='approved' then 1 else 0 end) as approved_count, sum(case when type='approved' then amount else 0 end) as approved_amount, sum(case when type='chargeback' then 1 else 0 end) as chargeback_count, sum(case when type='chargeback' then amount else 0 end) as chargeback_amount from ( ( select left(t.trans_date, 7) as month, t.country, amount,'approved' as type from Transactions as t where state='approved' ) union all ( select left(c.trans_date, 7) as month, t.country, amount,'chargeback' as type from Transactions as t join Chargebacks as c on t.id = c.trans_id ) ) as tt group by tt.month, tt.country
select month, country, sum(if(state="approved", 1,0)) as approved_count, sum(if(state="approved",amount, 0)) as approved_amount, sum(if(state="chargeback",1,0)) as chargeback_count, sum(if(state="chargeback", amount, 0)) as chargeback_amount from ((select left(t.trans_date, 7) as month, t.country, amount,'approved' as state from Transactions as t where state='approved') union all (select left(c.trans_date, 7) as month, t.country, amount,'chargeback' as state from Transactions as t join Chargebacks as c on t.id = c.trans_id)) as t2 group by t2.month, t2.country
select month,country, sum(case when type='approved' then 1 else 0 end) as approved_count, sum(case when type='approved' then amount else 0 end) as approved_amount, sum(case when type='chargeback' then 1 else 0 end) as chargeback_count, sum(case when type='chargeback' then amount else 0 end) as chargeback_amount from( (select left(trans_date,7) as month,country,amount,'approved' as type from transactions where state='approved') union all (select left(c.trans_date,7) as month,t.country, amount,'chargeback' as type from transactions t join chargebacks c on t.id=c.trans_id))tt group by tt.month, tt.country
select s1.month, s1.country, coalesce(sum(case when s2.state = 'approved' then 1 else 0 end),0) as approved_count, coalesce(sum(case when s2.state = 'approved' then amount else 0 end),0) as approved_amount, coalesce(s3.chargeback_count,0) as chargeback_count, coalesce(s3.chargeback_amount,0) as chargeback_amount from (select distinct substring(trans_date,1,7) as month, country from transactions where state='approved' union (select distinct substring(a.trans_date,1,7) as month, country from chargebacks a left join transactions b on a.trans_id = b.id))s1 left join transactions s2 on s1.month = substring(s2.trans_date,1,7) and s2.country = s1.country left join (select substring(b.trans_date,1,7) as month, a.country, count(distinct b.trans_id) as chargeback_count, sum(case when b.trans_id is not null then amount else 0 end) as chargeback_amount from transactions a left join chargebacks b on a.id = b.trans_id group by 1,2)s3 on s1.month = s3.month and s1.country = s3.country group by 1,2
select substr(trans_date, 1, 7) as "month", country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from ( select T1.* from Transactions T1 where state = 'approved' union all select C.trans_id, T2.country, 'chargeback', T2.amount, C.trans_date from Chargebacks C left join Transactions T2 on id = trans_id ) temp group by 1, 2
select substring(sub.trans_date, 1,7) as month, country, sum(case when sub.state = 'approved' then 1 else 0 end) as approved_count, sum(case when sub.state = 'approved' then sub.amount else 0 end) as approved_amount, sum(case when sub.state = 'charge_back' then 1 else 0 end) as chargeback_count, sum(case when sub.state = 'charge_back' then sub.amount else 0 end) as chargeback_amount from( select * from Transactions union all select C.trans_id as id, T.country, 'charge_back' as status, T.amount as amount, C.trans_date from Chargebacks C join Transactions T on C.trans_id = T.id)sub group by substring(sub.trans_date, 1,7), country having approved_count >0 or approved_amount >0 or chargeback_count >0 or chargeback_amount >0
select substring(trans_date, 1, 7) as month, country, sum(state ='approved') approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(state ='chargeback') chargeback_count , sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from ( select trans_id as id, country, 'chargeback' as state, amount, c.trans_date from chargebacks c left join transactions t on c.trans_id = t.id union select * from transactions) t group by 1,2 having sum(state ='approved') != 0 or sum(state ='chargeback') != 0
select substring(trans_date,1,7) as month, country, sum( CASE WHEN state = 'approved' THEN 1 ELSE 0 END ) as approved_count, sum( CASE WHEN state = 'approved' THEN amount ELSE 0 END ) as approved_amount, sum(chargeback) as chargeback_count, sum( CASE WHEN chargeback = 1 THEN amount ELSE 0 END ) as chargeback_amount from ( select *, 0 as chargeback from Transactions UNION ALL SELECT id,country,'chargeback' as state,amount,C.trans_date, 1 as chargeback from Transactions as T JOIN Chargebacks as C on C.trans_id = T.id order by trans_date ) tmp group by substring(trans_date,1,7),country having approved_count <> 0 or approved_amount <> 0 or chargeback_count <> 0 or chargeback_amount <> 0
select tr.month, tr.country, tr.count_tr approved_count, tr.total_tr approved_amount, ifnull(cb.count_cb,0) chargeback_count, ifnull(cb.total_cb,0) chargeback_amount from (select country, count(amount) count_tr, sum(amount) total_tr, left (trans_date,7) month from transactions where state = 'approved' group by country, month) tr left join (select t.country, count(t.amount) count_cb, sum(t.amount) total_cb, left (c.trans_date, 7) month from transactions t join chargebacks c on t.id = c.trans_id group by t.country, month) cb on (tr.month = cb.month and tr.country = cb.country) union select cb.month, cb.country, ifnull(tr.count_tr,0) approved_count, ifnull(tr.total_tr,0) approved_amount, cb.count_cb chargeback_count, cb.total_cb chargeback_amount from (select country, count(amount) count_tr, sum(amount) total_tr, left (trans_date,7) month from transactions where state = 'approved' group by country, month) tr right join (select t.country, count(t.amount) count_cb, sum(t.amount) total_cb, left (c.trans_date, 7) month from transactions t join chargebacks c on t.id = c.trans_id group by t.country, month) cb on (tr.month = cb.month and tr.country = cb.country)
with A as ( select left(trans_date, 7) as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount from transactions group by left(trans_date, 7), country having sum(case when state = 'approved' then 1 else 0 end) > 0 ), B as ( select left(c.trans_date, 7) as month, t.country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from transactions t join chargebacks c on t.id = c.trans_id group by left(c.trans_date, 7), t.country having count(c.trans_id) > 0 ) select coalesce(a.month, b.month) as month, coalesce(a.country, b.country) as country, ifnull(a.approved_count, 0) as approved_count, ifnull(a.approved_amount, 0) as approved_amount, ifnull(b.chargeback_count, 0) as chargeback_count, ifnull(b.chargeback_amount, 0) as chargeback_amount from a left join b on a.month = b.month and a.country = b.country union select coalesce(a.month, b.month) as month, coalesce(a.country, b.country) as country, ifnull(a.approved_count, 0) as approved_count, ifnull(a.approved_amount, 0) as approved_amount, ifnull(b.chargeback_count, 0) as chargeback_count, ifnull(b.chargeback_amount, 0) as chargeback_amount from a right join b on a.month = b.month and a.country = b.country
with A as( select if(trans_id = t.id and state = "declined", date_format(c.trans_date, "%Y-%m"), date_format(t.trans_date, "%Y-%m")) as "month", country, sum(if(state = "approved", 1, 0)) as "approved_count", sum(if(state = "approved", amount, 0)) as "approved_amount" from transactions t left join chargebacks c on c.trans_id = t.id group by 1,2 ) , B as( select date_format(c.trans_date, "%Y-%m") as "month", country, count(c.trans_date) as "chargeback_count", sum(if(trans_id = id, amount, 0)) as "chargeback_amount" from chargebacks c join Transactions t on c.trans_id = t.id group by 1,2 ) select * from( select A.month, A.country, ifnull(approved_count, 0) as "approved_count", ifnull(approved_amount, 0) as "approved_amount", ifnull(chargeback_count, 0) as "chargeback_count", ifnull(chargeback_amount,0) as "chargeback_amount" from A left join B on A.month = B.month and A.country = B.country union select B.month, B.country, ifnull(approved_count, 0) as "approved_count", ifnull(approved_amount, 0) as "approved_amount", ifnull(chargeback_count, 0) as "chargeback_count", ifnull(chargeback_amount,0) as "chargeback_amount" from A right join B on A.month = B.month and A.country = B.country) C where approved_count + chargeback_count != 0
with a as ( select c.trans_id, t.country, 'Chargebacks' as state, t.amount, c.trans_date from chargebacks c left join transactions t on c.trans_id = t.id union all select * from transactions order by 1,3) select date_format(trans_date,'%Y-%m') as month, country, sum(state='approved') as approved_count, sum(case when state='approved'then amount else 0 end) as approved_amount, sum(state='chargebacks') as chargeback_count, sum(case when state='chargebacks'then amount else 0 end) as chargeback_amount from a group by 1,2 having approved_count>0 or chargeback_count>0
with a as( select left(trans_date,7) as month, country, count(id) as approved_count, sum(amount) as approved_amount from transactions where state='approved' group by 1,2), b as( select left(c.trans_date,7) as month, t.country, count(*) as chargeback_count, sum(t.amount) as chargeback_amount from chargebacks c left join transactions t on c.trans_id=t.id group by 1,2), c as( select b.month, b.country, ifnull(a.approved_count,0) as approved_count, ifnull(a.approved_amount,0) as approved_amount, b.chargeback_count, b.chargeback_amount from b left join a on a.month=b.month and a.country=b.country order by 1), d as( select a.month, a.country, a.approved_count, a.approved_amount, ifnull(b.chargeback_count,0) as chargeback_count, ifnull(b.chargeback_amount,0) as chargeback_amount from a left join b on a.month=b.month and a.country=b.country order by 1) select * from c union select * from d
with all_info as (select date_format(t.trans_date, '%Y-%m') month, country, state, amount from transactions t where state = 'approved' union all select date_format(c.trans_date, '%Y-%m') month, t1.country, 'chargeback' as state, t1.amount from chargebacks c join transactions t1 on c.trans_id = t1.id) select month, country, sum(case when state= 'approved' then 1 else 0 end) as approved_count, sum(case when state= 'approved' then amount else 0 end) as approved_amount, sum(case when state= 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when state= 'chargeback' then amount else 0 end) as chargeback_amount from all_info group by month, country
with all_months as ( select distinct country, date_format(trans_date, "%Y-%m") "month" from transactions union select distinct t.country, date_format(c.trans_date, "%Y-%m") "month" from chargebacks c join transactions t on c.trans_id = t.id ), trans_sum as ( select id "trans_id", date_format(trans_date, "%Y-%m") "month", country, amount from transactions where state = 'approved' ), cb_sum as ( select c.trans_id, t.amount "chargeback_amount", t.country, date_format(c.trans_date, "%Y-%m") "month" from chargebacks c join transactions t on t.id = c.trans_id ) select month, country, ifnull(approved_count, 0) "approved_count", ifnull(approved_amount, 0) "approved_amount", ifnull(chargeback_count, 0) "chargeback_count", ifnull(chargeback_amount, 0) "chargeback_amount" from (select a.month, a.country, approved_count "approved_count", approved_amount "approved_amount", count(distinct c.trans_id) "chargeback_count", sum(chargeback_amount) "chargeback_amount" from (select a.month, a.country, count(distinct t.trans_id) "approved_count", sum(t.amount) "approved_amount" from all_months a left join trans_sum t on t.month = a.month and t.country = a.country group by 1, 2 ) a left join cb_sum c on c.month = a.month and c.country = a.country group by 1, 2, 3, 4 ) result_table where approved_count + chargeback_count != 0
with all_months as ( select distinct country, date_format(trans_date, "%Y-%m") "month" from transactions union select distinct t.country, date_format(c.trans_date, "%Y-%m") "month" from chargebacks c join transactions t on c.trans_id = t.id ), trans_sum as ( select id "trans_id", date_format(trans_date, "%Y-%m") "month", country, amount from transactions where state = 'approved' ), cb_sum as ( select c.trans_id, t.country, date_format(c.trans_date, "%Y-%m") "month", t.amount "chargeback_amount" from chargebacks c join transactions t on t.id = c.trans_id ) select month, country, ifnull(approved_count, 0) "approved_count", ifnull(approved_amount, 0) "approved_amount", ifnull(chargeback_count, 0) "chargeback_count", ifnull(chargeback_amount, 0) "chargeback_amount" from (select a.month, a.country, approved_count, approved_amount, count(distinct c.trans_id) "chargeback_count", sum(chargeback_amount) "chargeback_amount" from (select a.month, a.country, count(distinct t.trans_id) "approved_count", sum(t.amount) "approved_amount" from all_months a left join trans_sum t on t.month = a.month and t.country = a.country group by 1, 2 ) a left join cb_sum c on c.month = a.month and c.country = a.country group by 1, 2, 3, 4 ) result_table where approved_count + chargeback_count != 0
with alldate as ( select left(trans_date,7) trans_date, country from Transactions group by left(trans_date,7), country union all select left(a.trans_date,7) trans_date, b.country from Chargebacks a inner join Transactions b on a.trans_id =b.id group by left(a.trans_date,7), b.country ), ChargebacksTrans as ( select left(a.trans_date,7) trans_date, b.country, sum(b.amount) amount , count(left(a.trans_date,7)) countTotal from Chargebacks a inner join Transactions b on a.trans_id =b.id group by left(a.trans_date,7), b.country), NewTransactions as ( select left(trans_date,7) trans_date, country, sum(amount) amount , count(left( trans_date,7)) countTotal from Transactions where state = 'approved' group by left(trans_date,7), country) select a.trans_date month , a.country, ifnull(c.countTotal,0) approved_count , ifnull(c.amount,0) approved_amount , ifnull(b.countTotal,0) chargeback_count , ifnull(b.amount,0) chargeback_amount from alldate a left join ChargebacksTrans b on a.trans_date = b.trans_date and a.country = b.country left join NewTransactions c on a.trans_date = c.trans_date and a.country = c.country where (ifnull(c.countTotal,0) > 0 or ifnull(c.amount,0)> 0 or ifnull(b.countTotal,0)> 0 or ifnull(b.amount,0)> 0) group by a.trans_date , a.country order by 1
with alltransa as ( (SELECT * FROM Transactions WHERE state = "approved") UNION ALL (SELECT a.id, country, "chargebacks" AS state, amount, b.trans_date FROM Transactions a RIGHT JOIN Chargebacks b ON a.id = b.trans_id)) SELECT LEFT(trans_date, 7) AS month, country, sum(state = 'approved') as approved_count , sum(if(state = 'approved',amount,0)) as approved_amount , sum(state = 'chargebacks') as chargeback_count , sum(if(state = 'chargebacks',amount,0)) as chargeback_amount FROM alltransa group by 1,2
with approvals as ( select substr(trans_date,1,7) as month, country, count(id) as approved_count, sum(amount) as approved_amount from Transactions where state = 'approved' group by 1,2 ), charges as ( select substr(c.trans_date,1,7) as month, t.country, count(c.trans_id) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks c join Transactions t on t.id = c.trans_id group by 1,2 ) select a.month, a.country, coalesce(a.approved_count,0) approved_count, coalesce(a.approved_amount,0) approved_amount, coalesce(c.chargeback_count,0) chargeback_count, coalesce(c.chargeback_amount,0) chargeback_amount from approvals a left join charges c on a.month = c.month and a.country = c.country union select c.month, c.country, coalesce(a.approved_count,0) approved_count, coalesce(a.approved_amount,0) approved_amount, coalesce(c.chargeback_count,0) chargeback_count, coalesce(c.chargeback_amount,0) chargeback_amount from approvals a right join charges c on a.month = c.month and a.country = c.country
with approved as ( SELECT DATE_FORMAT(trans_date, '%Y-%m') as month, country, count(state) as approved_count, sum(amount) as approved_amount from Transactions where state = 'approved' group by DATE_FORMAT(trans_date, '%Y-%m'), country) , chargeback as(select DATE_FORMAT(b.trans_date, '%Y-%m') as month, a.country, count(a.id) as chargeback_count, sum(a.amount) as chargeback_amount from Transactions a, Chargebacks b where a.id = b.trans_id group by DATE_FORMAT(b.trans_date, '%Y-%m'), a.country) (select t2.month, t2.country, ifnull(t1.approved_count,0) as approved_count, ifnull(t1.approved_amount,0) as approved_amount,t2.chargeback_count, t2.chargeback_amount from approved t1 right join chargeback t2 on (t1.month = t2.month and t1.country = t2.country) order by t2.month, t2.country) union distinct (select t1.month, t1.country, t1.approved_count as approved_count, t1.approved_amount as approved_amount, ifnull(t2.chargeback_count,0) as chargeback_count, ifnull(t2.chargeback_amount,0) as chargeback_amount from approved t1 left join chargeback t2 on (t1.month = t2.month and t1.country = t2.country) order by t1.month, t1.country)
with approved as (SELECT id, date_format(trans_date, "%Y-%m") as month, country, count(id) as approved_count, sum(amount) as approved_amount FROM Transactions WHERE state = "approved" GROUP BY date_format(trans_date, "%Y-%m"), country ), Charged as (SELECT date_format(c.trans_date, "%Y-%m") as month, t.country as country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount FROM Chargebacks c LEFT JOIN Transactions t ON t.id=c.trans_id GROUP BY date_format(c.trans_date, "%Y-%m"), t.country ), t3 as (select a.month, country from approved a union select c.month, country from Charged c) select t3.month, t3.country, ifnull(approved_count, 0) as approved_count, ifnull(approved_amount, 0) as approved_amount, ifnull(chargeback_count, 0) as chargeback_count, ifnull(chargeback_amount, 0) as chargeback_amount from t3 left join approved a on t3.month = a.month and t3.country = a.country left join Charged c on t3.month = c.month and t3.country = c.country
with base as( SELECT country, date_format(trans_date, '%Y-%m') as month, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, 0 as chargeback_count, 0 as chargeback_amount from transactions group by 1,2 union all select country, date_format(a.trans_date, '%Y-%m') as month, 0 as approved_count, 0 as approved_amount, count(distinct a.trans_id) as chargeback_count, sum(b.amount) as chargeback_amount from Chargebacks a left join Transactions b on a.trans_id = b.id group by 1,2 ) select distinct month, country, sum(approved_count) as approved_count, sum(approved_amount) as approved_amount, sum(chargeback_count) as chargeback_count, sum(chargeback_amount) as chargeback_amount from base where approved_count <>0 or approved_amount <>0 and chargeback_count <>0 or chargeback_amount <>0 group by 1, 2
with cb as ( select trans_id as id, t.country, 'chargeback' as state, t.amount as amount, c.trans_date from Chargebacks c join Transactions t on c.trans_id = t.id ), combined as ( select * from Transactions UNION select * from cb ) select Date_format(trans_date, '%Y-%m') as month, country, sum(state = 'approved') approved_count, sum(if(state= 'approved', amount, 0)) approved_amount, sum(state = 'chargeback') chargeback_count, sum(if(state='chargeback', amount, 0)) chargeback_amount from combined group by month, country having approved_count > 0 or chargeback_count > 0
with cb as ( select trans_id as id, t.country, 'chargeback' as state, t.amount as amount, c.trans_date from Chargebacks c join Transactions t on c.trans_id = t.id ), combined as ( select * from Transactions UNION select * from cb ), cte as ( SELECT Date_format(trans_date, '%Y-%m') as month, country, state, amount, trans_date from combined ) select month, country, sum(state = 'approved') approved_count, sum(if(state= 'approved', amount, 0)) approved_amount, sum(state = 'chargeback') chargeback_count, sum(if(state='chargeback', amount, 0)) chargeback_amount from cte group by month, country having approved_count > 0 or chargeback_count > 0
with cb as (select left(c.trans_date, 7) as month,country, amount, 'chargeback' as status from Transactions t join Chargebacks c on t.id = trans_id) select month, country, sum(case when status = 'approved' then 1 else 0 end) as approved_count, sum(case when status = 'approved' then amount else 0 end) as approved_amount, sum(case when status = 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when status = 'chargeback' then amount else 0 end) as chargeback_amount from (select left(t.trans_date, 7) as month,t.country, t.amount, 'approved' as status from Transactions t where t.state = 'approved' union all select * from cb) t2 group by month, country
with chargebacks_two as (select c.trans_id, t.country, 'chargeback' as state, t.amount,c.trans_date from Chargebacks c left join Transactions t on c.trans_id = t.id) select DATE_FORMAT(sub.trans_date, '%Y-%m') as month, sub.country, sum(case when sub.state = 'approved' then 1 else 0 end) as approved_count, sum(case when sub.state='approved' then sub.amount else 0 end) as approved_amount, sum(case when sub.state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when sub.state='chargeback' then sub.amount else 0 end) as chargeback_amount from (select * from chargebacks_two union all (select * from Transactions where state='approved') ) sub group by 1, 2
with chargebackswamount as ( select date_format(c.trans_date,'%Y-%m') as month, t.country, sum(t.amount) as chargeback_amount, count(t.amount) as chargeback_count from Chargebacks c inner join Transactions t on c.trans_id = t.id group by date_format(c.trans_date,'%Y-%m'),t.country ) , transactionall as ( select date_format(t.trans_date,'%Y-%m') as month, t.country, sum(case when t.state='approved' then 1 else 0 end) as approved_count, sum(case when t.state='approved' then t.amount else 0 end) as approved_amount from Transactions t group by date_format(t.trans_date,'%Y-%m'),t.country ) select t.month, t.country, t.approved_count, t.approved_amount, ifnull(c.chargeback_amount,0) as chargeback_amount, ifnull(c.chargeback_count,0) as chargeback_count from transactionall t left join chargebackswamount c on t.month = c.month and t.country=c.country having chargeback_count > 0 or approved_count>0 union select c.month, c.country, ifnull(t.approved_count,0) as approved_count, ifnull(t.approved_amount,0) as approved_amount, c.chargeback_amount, c.chargeback_count from chargebackswamount c left join transactionall t on t.month = c.month and t.country=c.country having chargeback_count > 0 or approved_count>0
with chbk as( select c.trans_id id, t.country, 'chargeback' as state, t.amount amount, c.trans_date from Transactions t right outer join Chargebacks c on t.id = c.trans_id ) , trans as ( select * from Transactions t ) select country, left(trans_date,7) as month, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from (select id, country, state, amount, trans_date from chbk union all select id, country, state, amount, trans_date from trans) a group by country, left(trans_date,7) having approved_amount > 0 or chargeback_amount > 0
with comb_data as (Select trans_id, country, "chargeback" as state, amount, c.trans_date From Transactions t, Chargebacks c Where t.id = c.trans_id Union all Select * From Transactions) Select date_format(trans_date, "%Y-%m") as month, country, sum(case when state="approved" then 1 else 0 end) as approved_count, sum(case when state="approved" then amount else 0 end) as approved_amount, sum(case when state="chargeback" then 1 else 0 end) as chargeback_count, sum(case when state="chargeback" then amount else 0 end) as chargeback_amount From comb_data Group by month, country Having approved_amount>0 or chargeback_amount>0
with cte as ( (select t.id, country, state, amount, t.trans_date from Transactions t left join Chargebacks c on t.id = c.trans_id) union (select c.trans_id, country, "chargeback", amount, c.trans_date from Transactions t right join Chargebacks c on t.id = c.trans_id) ) select date_format(trans_date, "%Y-%m") as month, country, sum(state = "approved") as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(state = "chargeback") as chargeback_count, sum(case when state = "chargeback" then amount else 0 end) as chargeback_amount from cte group by month, country having approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( SELECT * FROM Transactions UNION ALL SELECT t.id, t.country, 'charge_back' as state, t.amount, c.trans_date FROM Transactions t JOIN Chargebacks c ON c.trans_id = t.id ) SELECT LEFT(trans_date,7) as month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) as approved_count, SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) as approved_amount, SUM(CASE WHEN state = 'charge_back' THEN 1 ELSE 0 END) as chargeback_count, SUM(CASE WHEN state = 'charge_back' THEN amount ELSE 0 END) as chargeback_amount FROM cte GROUP BY 1,2 HAVING approved_amount > 0 OR chargeback_amount > 0
with cte as ( SELECT id, country, 'bc' AS state, amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id UNION ALL SELECT id, country, state, amount, trans_date FROM Transactions) SELECT LEFT(trans_date,7) AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS 'approved_count', SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS 'approved_amount', SUM(CASE WHEN state = 'bc' THEN 1 ELSE 0 END) AS 'chargeback_count', SUM(CASE WHEN state = 'bc' THEN amount ELSE 0 END) AS 'chargeback_amount' FROM cte GROUP BY 1,2 HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( SELECT id, country, 'bc' AS state, amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id UNION ALL SELECT id, country, state, amount, trans_date FROM Transactions) SELECT LEFT(trans_date,7) AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS 'approved_count', SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS 'approved_amount', SUM(CASE WHEN state = 'bc' THEN 1 ELSE 0 END) AS 'chargeback_count', SUM(CASE WHEN state = 'bc' THEN amount ELSE 0 END) AS 'chargeback_amount' FROM cte GROUP BY 2,1 HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( SELECT id, country, 'bc' AS state, amount, c.trans_date FROM Transactions t RIGHT JOIN Chargebacks c ON t.id = c.trans_id UNION ALL SELECT id, country, state, amount, trans_date FROM Transactions) SELECT LEFT(trans_date,7) AS month, country, SUM(CASE WHEN state = 'approved' THEN 1 ELSE 0 END) AS 'approved_count', SUM(CASE WHEN state = 'approved' THEN amount ELSE 0 END) AS 'approved_amount', SUM(CASE WHEN state = 'bc' THEN 1 ELSE 0 END) AS 'chargeback_count', SUM(CASE WHEN state = 'bc' THEN amount ELSE 0 END) AS 'chargeback_amount' FROM cte GROUP BY country, month HAVING approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( select * from Transactions union select c.trans_id, country, "chargeback", amount, c.trans_date from Transactions t right join Chargebacks c on t.id = c.trans_id ) select date_format(trans_date, "%Y-%m") as month, country, sum(state = "approved") as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(state = "chargeback") as chargeback_count, sum(case when state = "chargeback" then amount else 0 end) as chargeback_amount from cte group by month, country having approved_count + chargeback_count != 0
with cte as ( select * from transactions where state = 'approved' union all select c.trans_id,t.country,'chargebacks' as state,t.amount,c.trans_date from Chargebacks c left join transactions t on t.id = c.trans_id ) select substr(trans_date,1,7) as month, country, sum(state = 'approved') as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(state = 'chargebacks') as chargeback_count, sum(case when state = 'chargebacks' then amount else 0 end) as chargeback_amount from cte group by substr(trans_date,1,7) ,country
with cte as ( select date_format(c.trans_date, '%Y-%m') as month, country, NULL as approved_count, NULL as approved_amount, count(trans_id) as Chargeback_count, sum(amount) as chargeback_amount from chargebacks c left join transactions t on t.id=c.trans_id group by 1,2 UNION ALL select date_format(t.trans_date, '%Y-%m') as month, country, sum(state = 'Approved') as approved_count, sum(if(state='approved', amount,0)) as approved_amount, NULL as chargeback_count, null as chargeback_amount from transactions t group by 1,2 ) select month, country, coalesce(sum(approved_count),0) as approved_count, coalesce(sum(approved_amount),0) as approved_amount, coalesce(sum(chargeback_count),0) as chargeback_count, coalesce(sum(chargeback_amount),0) as chargeback_amount from cte group by 1,2 having coalesce(sum(approved_count),0) + coalesce(sum(approved_amount),0) + coalesce(sum(chargeback_count),0) + coalesce(sum(chargeback_amount),0) <>0
with cte as ( select date_format(trans_date, '%Y-%m') as month, country from transactions union select date_format(a.trans_date, '%Y-%m') as month, b.country from chargebacks as a left join transactions as b on a.trans_id = b.id ) select a.*, ifnull(b.approved_count,0) as approved_count, ifnull(b.approved_amount,0) as approved_amount, ifnull(c.chargeback_count,0) as chargeback_count, ifnull(c.chargeback_amount,0) as chargeback_amount from cte as a left join( select date_format(trans_date, '%Y-%m') as month, country, count(distinct id) as approved_count, sum(amount) as approved_amount from transactions where state = 'approved' group by 1,2 ) as b on a.month = b.month and a.country = b.country left join ( select date_format(a.trans_date, '%Y-%m') as month, b.country, count(distinct a.trans_id) as chargeback_count, sum(b.amount) as chargeback_amount from chargebacks as a left join transactions as b on a.trans_id = b.id group by 1,2 ) as c on a.month = c.month and a.country = c.country where approved_count >0 or chargeback_count >0 order by 1,2
with cte as ( select id, country, state, amount, trans_date from Transactions union select c.trans_id, country, "chargeback", amount, c.trans_date from Transactions t right join Chargebacks c on t.id = c.trans_id ) select date_format(trans_date, "%Y-%m") as month, country, sum(state = "approved") as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(state = "chargeback") as chargeback_count, sum(case when state = "chargeback" then amount else 0 end) as chargeback_amount from cte group by month, country having approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( select left(trans_date,7) as 'month' , country , if(state='approved',1,0) as approved_count , if(state='approved',amount,0) as approved_amount , 0 as chargeback_count , 0 as chargeback_amount from Transactions union all select left(c.trans_date,7) as "month" ,t.country as country , 0 as approved_count, 0 as approved_amount, 1 as chargeback_count , t.amount as chargeback_amount from Chargebacks as c left join Transactions as t on t.id = c.trans_id ) select month , country , sum(approved_count) as approved_count , sum(approved_amount) as approved_amount, sum(chargeback_count) as chargeback_count ,sum(chargeback_amount) as chargeback_amount from cte group by month , country having sum(approved_count) >0 or sum(approved_amount) >0 or sum(chargeback_count) >0 or sum(chargeback_amount) >0
with cte as ( select t.id, country, state, amount, t.trans_date from Transactions t left join Chargebacks c on t.id = c.trans_id union select c.trans_id, country, "chargeback", amount, c.trans_date from Transactions t right join Chargebacks c on t.id = c.trans_id ) select date_format(trans_date, "%Y-%m") as month, country, sum(case when state = "approved" then 1 else 0 end) as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(state = "chargeback") as chargeback_count, sum(case when state = "chargeback" then amount else 0 end) as chargeback_amount from cte group by month, country having approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( select t.id, country, state, amount, t.trans_date from Transactions t left join Chargebacks c on t.id = c.trans_id union select c.trans_id, country, "chargeback", amount, c.trans_date from Transactions t right join Chargebacks c on t.id = c.trans_id ) select date_format(trans_date, "%Y-%m") as month, country, sum(state = "approved") as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(state = "chargeback") as chargeback_count, sum(case when state = "chargeback" then amount else 0 end) as chargeback_amount from cte group by month, country having approved_count + approved_amount + chargeback_count + chargeback_amount <> 0
with cte as ( select trans_id as id, t.country as country, 'Chargebacks' AS state, amount, c.trans_date as trans_date from chargebacks c left join transactions t on c.trans_id=t.id union select* from transactions where state='approved' ) select date_format(trans_date, '%Y-%m') as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='chargebacks' then 1 else 0 end) as chargeback_count, sum(case when state='chargebacks' then amount else 0 end) as chargeback_amount from cte group by month, country
with cte as (select date_format(c.trans_date,'%Y-%m') as month,t.amount,t.country,'chargeback' as state from chargebacks c left join transactions t on c.trans_id=t.id) select temp.month, temp.country, sum(case when temp.state='approved' then 1 else 0 end) as approved_count, sum(case when temp.state='approved' then amount else 0 end) as approved_amount, sum(case when temp.state='chargeback' then 1 else 0 end) as chargeback_count, sum(case when temp.state='chargeback' then amount else 0 end) as chargeback_amount from (select date_format(t.trans_date,'%Y-%m') as month, t.amount, t.country, t.state from transactions t union all select * from cte) temp group by 1,2 having sum(case when temp.state='approved' then 1 else 0 end)!=0 or sum(case when temp.state='chargeback' then 1 else 0 end) !=0 order by 1,2
with cte as (select id, country, state, amount, trans_date from Transactions union all select c.trans_id as id, t.country, 'chargebacks' as state, t.amount, c.trans_date from Chargebacks c join Transactions t on c.trans_id = t.id) select left(trans_date,7) as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'chargebacks' then 1 else 0 end) as chargeback_count, sum(case when state = 'chargebacks' then amount else 0 end) as chargeback_amount from cte group by 1,2 having approved_count + approved_amount + chargeback_count + chargeback_amount <> 0 order by 1,2
with cte as (select t.* from transactions t where state = "approved" union all select trans_id, t.country,"back" as state, t.amount,c.trans_date from chargebacks c left join transactions t on c.trans_id = t.id) select substr(trans_date,1,7) as month, country, sum(state="approved") as approved_count, sum(case when state = "approved" then amount else 0 end) as approved_amount, sum(state="back") as chargeback_count, sum(case when state = "back" then amount else 0 end) as chargeback_amount from cte group by 1,country
with cte as( select left(c.trans_date,7)as month, country, "chargebacks"as state, amount from chargebacks c join transactions t on c.trans_id = t.id union all select left(t.trans_date, 7)as month, country, state, amount from transactions t where state="approved") select month, country, sum(case when state="approved" then 1 else 0 end)as approved_count, sum(case when state="approved" then amount else 0 end) as approved_amount, sum(case when state="chargebacks" then 1 else 0 end) as chargeback_count, sum(case when state="chargebacks" then amount else 0 end)as chargeback_amount from cte group by 1,2 order by 1
with cte as(select left(trans_date, 7) as month, country, count(id) as approved_count, sum(amount) as approved_amount from Transactions where state = 'approved' group by 1,2), cte2 as(select left(c.trans_date, 7) as month, t.country, count(*) as chargeback_count, sum(t.amount) as chargeback_amount from Chargebacks c join Transactions t on t.id = c.trans_id group by 1,2) select cte.month, cte.country, approved_count, approved_amount, ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from cte left join cte2 on cte.month = cte2.month and cte.country = cte2.country union select cte2.month, cte2.country, ifnull(approved_count,0) as approved_count, ifnull(approved_amount,0) as approved_amount, chargeback_count, chargeback_amount from cte2 left join cte on cte.month = cte2.month and cte.country = cte2.country
with cte1 as ( select date_format(trans_date, '%Y-%m') as month, country, count(id) as approved_count, sum(amount) as approved_amount from transactions where state = 'approved' group by 1,2 ), cte2 as ( select date_format(c.trans_date,'%Y-%m') as month, country, count(*) as chargeback_count, sum(amount) as chargeback_amount from chargebacks c join transactions t on c.trans_id = t.id group by 1,2 ) select cte1.month, cte1.country, approved_count, approved_amount, ifnull(chargeback_count, 0) as chargeback_count, ifnull(chargeback_amount, 0) as chargeback_amount from cte1 left join cte2 on cte1.month = cte2.month and cte1.country = cte2.country union all select cte2.month, cte2.country, ifnull(approved_count, 0) as approved_count, ifnull(approved_amount,0) as approved_amount, chargeback_count, chargeback_amount from cte1 right join cte2 on cte1.month = cte2.month and cte1.country = cte2.country where cte1.month is null
with cte1 as ( select date_format(trans_date, '%Y-%m') as month, country, count(id) as approved_count, sum(amount) as approved_amount from transactions where state='approved' group by 1,2), cte2 as ( select date_format(c.trans_date, '%Y-%m') as month, t.country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from chargebacks c join transactions t on c.trans_id=t.id group by 1,2) (select c1.month, c1.country, c1.approved_count, c1.approved_amount, ifnull(c2.chargeback_count,0) as chargeback_count, ifnull(c2.chargeback_amount,0) as chargeback_amount from cte1 c1 left join cte2 c2 on c1.month=c2.month and c1.country=c2.country) union (select c2.month, c2.country, ifnull(c1.approved_count,0) as approved_count, ifnull(c1.approved_amount,0) as approved_amount, c2.chargeback_count, c2.chargeback_amount from cte2 c2 left join cte1 c1 on c1.month=c2.month and c1.country=c2.country)
with cte1 as ( select date_format(trans_date, '%Y-%m') as month, country, count(id) as approved_count, sum(amount) as approved_amount, NULL as chargeback_count, NULL as chargeback_amount from transactions where state = 'approved' group by 1,2 union all select date_format(cg.trans_date, '%Y-%m') as month, country, NULL as approved_count, NULL as approved_amount, count(cg.trans_id) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks cg left join transactions t on cg.trans_id = t.id group by 1,2) select month, country, coalesce(sum(approved_count), 0) as approved_count, coalesce(sum(approved_amount), 0) as approved_amount, coalesce(sum(chargeback_count), 0) as chargeback_count, coalesce(sum(chargeback_amount), 0) as chargeback_amount from cte1 group by month, country
with cte1 as ( select left(trans_date, 7) as month, country, count(1) as approved_count, sum(amount) as approved_amount from transactions where state = "approved" group by left(trans_date, 7), country ), cte2 as ( select count(1) as chargeback_count, sum(amount) as chargeback_amount, left(c.trans_date, 7) as month, country from chargebacks c left join transactions t on c.trans_id = t.id group by left(c.trans_date, 7), country ) select cte1.month, cte1.country, cte1.approved_count, cte1.approved_amount, ifnull(cte2.chargeback_count, 0) as chargeback_count, ifnull(cte2.chargeback_amount, 0) as chargeback_amount from cte1 left join cte2 on cte1.month = cte2.month and cte1.country = cte2.country union select cte2.month, cte2.country, ifnull(cte1.approved_count, 0), ifnull(cte1.approved_amount, 0), cte2.chargeback_count, cte2.chargeback_amount from cte1 right join cte2 on cte1.month = cte2.month and cte1.country = cte2.country
with cte1 as ( select left(trans_date,7) as month, country, count(state) as approved_count, sum(amount) as approved_amount from Transactions t where state='approved' group by left(trans_date,7), country ), cte2 as ( select left(c.trans_date,7) as month, t.country, count(c.trans_date) as chargeback_count, sum(t.amount) as chargeback_amount from Chargebacks c join Transactions t on c.trans_id=t.id group by left(c.trans_date,7), t.country ), cte3 as ( select month, country from (select month, country from cte1 union select month, country from cte2) t ), cte4 as( select month, country from cte3 group by month, country ), cte5 as ( select c4.month, c4.country, ifnull(c1.approved_count, 0) as approved_count, ifnull(c1.approved_amount,0) as approved_amount, ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from cte4 c4 left join cte1 c1 on c4.month=c1.month and c4.country=c1.country left join cte2 c2 on c4.month=c2.month and c4.country=c2.country order by month, country ) select * from cte5
with cte1 as (select date_format(trans_date, '%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount from transactions group by month, country), cte2 as (select date_format(chargebacks.trans_date, '%Y-%m') as month, transactions.country, count(transactions.id) as chargeback_count, sum(transactions.amount) as chargeback_amount from chargebacks join transactions on chargebacks.trans_id = transactions.id group by month, country) (select c2.month, c2.country, ifnull(c1.approved_count, 0) as approved_count, ifnull(c1.approved_amount, 0) as approved_amount, c2.chargeback_count, c2.chargeback_amount from cte1 as c1 right join cte2 as c2 on (c1.month = c2.month and c1.country = c2.country) order by c2.month asc, c2.country asc) union (select c1.month, c1.country, c1.approved_count, c1.approved_amount, ifnull(c2.chargeback_count, 0) as chargeback_count, ifnull(c2.chargeback_amount, 0) as chargeback_amount from cte1 as c1 left join cte2 as c2 on (c1.month = c2.month and c1.country = c2.country) where c1.approved_count <> 0 order by c2.month asc, c2.country asc)
with cte1 as (select date_format(trans_date, '%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount from transactions group by month, country), cte2 as (select date_format(chargebacks.trans_date, '%Y-%m') as month, transactions.country, count(transactions.id) as chargeback_count, sum(transactions.amount) as chargeback_amount from chargebacks join transactions on chargebacks.trans_id = transactions.id group by month, country) (select c2.month, c2.country, ifnull(c1.approved_count, 0) as approved_count, ifnull(c1.approved_amount, 0) as approved_amount, c2.chargeback_count, c2.chargeback_amount from cte1 as c1 right join cte2 as c2 on (c1.month = c2.month and c1.country = c2.country)) union (select c1.month, c1.country, c1.approved_count, c1.approved_amount, ifnull(c2.chargeback_count, 0) as chargeback_count, ifnull(c2.chargeback_amount, 0) as chargeback_amount from cte1 as c1 left join cte2 as c2 on (c1.month = c2.month and c1.country = c2.country) where c1.approved_count <> 0) order by month asc, country asc
with cte1 as (select date_format(trans_date,"%Y-%m") as month, country, count(state) as approved_count, sum(amount) as approved_amount from Transactions where state = 'approved' group by 1,2) , cte2 as (select date_format(C.trans_date,"%Y-%m") as month, country, count(trans_id) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks AS C left join Transactions AS T on C.trans_id = T.id group by 1,2) select case when cte1.month is null then cte2.month else cte1.month end as month, case when cte1.country is null then cte2.country else cte1.country end as country, case when approved_count is null then 0 else approved_count end as approved_count, case when approved_amount is null then 0 else approved_amount end as approved_amount, case when chargeback_count is null then 0 else chargeback_count end as chargeback_count, case when chargeback_amount is null then 0 else chargeback_amount end as chargeback_amount from cte2 left join cte1 on cte2.month = cte1.month and cte2.country = cte1.country union select case when cte1.month is null then cte2.month else cte1.month end as month, case when cte1.country is null then cte2.country else cte1.country end as country, case when approved_count is null then 0 else approved_count end as approved_count, case when approved_amount is null then 0 else approved_amount end as approved_amount, case when chargeback_count is null then 0 else chargeback_count end as chargeback_count, case when chargeback_amount is null then 0 else chargeback_amount end as chargeback_amount from cte2 right join cte1 on cte2.month = cte1.month and cte2.country = cte1.country order by 1,2
with cte1 as(select date_format(trans_date,'%Y-%m') as month, country, sum(if(state='approved',1,0)) as approved_count, sum(if(state='approved',amount,0)) as approved_amount from Transactions group by 1,2), cte2 as(select date_format(c.trans_date,'%Y-%m') as month, t.country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from Transactions t join Chargebacks c on t.id=c.trans_id group by 1,2) (select c2.month, c2.country, ifnull(approved_count,0) as approved_count, ifnull(approved_amount,0) as approved_amount, chargeback_count, chargeback_amount from cte2 c2 left join cte1 c1 on c2.month=c1.month and c2.country=c1.country) union (select c1.month, c1.country, approved_count, approved_amount, ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from cte1 c1 left join cte2 c2 on c2.month=c1.month and c2.country=c1.country where approved_count!=0) order by 1 asc, 2 asc
with cte_appr as( select left(trans_date,7) as month, country, count(*) as approved_count, sum(amount) as approved_amount from Transactions where state = 'approved' group by 1,2 ), cte_char as ( select left(tab1.trans_date,7) as month, tab2.country, count(*) as chargeback_count, sum(tab2.amount) as chargeback_amount from Chargebacks tab1 left join Transactions tab2 on tab1.trans_id = tab2.id group by 1,2 ) select tab1.month, tab1.country, tab1.approved_count, tab1.approved_amount, ifnull(tab2.chargeback_count,0) as chargeback_count, ifnull(tab2.chargeback_amount,0) as chargeback_amount from cte_appr tab1 left join cte_char tab2 on tab1.month = tab2.month and tab1.country = tab2.country union select tab2.month, tab2.country, ifnull(tab1.approved_count,0) as approved_count, ifnull(tab1.approved_amount,0) as approved_amount, tab2.chargeback_count, tab2.chargeback_amount from cte_appr tab1 right join cte_char tab2 on tab1.month = tab2.month and tab1.country = tab2.country where tab1.month is NULL and tab1.country is NULL
with mnth as (select distinct substr(trans_date,1,7) as month from (select trans_date from transactions union select trans_date from chargebacks) t), temp as (select substr(trans_date,1,7) as month, country as country, count(distinct id) as approved_count, sum(amount) as approved_amount from transactions where state='approved' group by substr(trans_date,1,7), country), temp2 as (select substr(c.trans_date,1,7) as month, t.country as country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from chargebacks c, transactions t where c.trans_id = t.id group by substr(c.trans_date,1,7), t.country) select t.month, t.country, t.approved_count, t.approved_amount, coalesce(t2.chargeback_count,0) as chargeback_count, coalesce(t2.chargeback_amount,0) as chargeback_amount from temp t left outer join temp2 t2 on t.month = t2.month and t.country = t2.country union select t2.month, t2.country, coalesce(t.approved_count,0) as approved_count, coalesce(t.approved_amount,0) as approved_amount, t2.chargeback_count, t2.chargeback_amount from temp2 t2 left outer join temp t on t2.month = t.month and t2.country = t.country
with mod_chargeback as (select t.country as country,t.amount,'Chargeback' as state,DATE_FORMAT(c.trans_date,"%Y-%m") as month from transactions t join Chargebacks c on c.trans_id=t.id) Select m1. month, m1.country, coalesce(sum(case when m1.state="approved" then 1 else 0 end),0) as approved_count, coalesce(sum(case when m1.state="approved" then m1.amount else 0 end),0) as approved_amount, coalesce(sum(case when m1.state="Chargeback" then 1 else 0 end),0) as chargeback_count, coalesce(sum(case when m1.state="Chargeback" then m1.amount else 0 end),0) as chargeback_amount from (select DATE_FORMAT(t.trans_date,"%Y-%m") as month,t.country,t.amount,t.state from transactions t union all select m.month,m.country,m.amount,m.state from mod_chargeback m) m1 where m1.state!='declined' group by 1,2
with recursive cte_date_range as ( select trans_date from Transactions union all select trans_date from Chargebacks ), cte_date_spine as ( select min(trans_date) as dt from cte_date_range union all select date_add(dt, interval '1' day) from cte_date_spine where dt < (select max(trans_date) from cte_date_range) ), cte_spine as ( select dt, country from cte_date_spine cross join ( select distinct country from Transactions ) as countries ), cte_chargebacks_wide as ( select cb.trans_date, t.amount, t.country from Chargebacks as cb join Transactions as t on cb.trans_id = t.id ), cte_txns_agg as ( select concat(year(s.dt),'-', lpad(month(s.dt),2,0)) as month, s.country, sum(if(t.state = 'approved', 1, 0)) as approved_count, sum(if(t.state = 'approved', t.amount, 0)) as approved_amount from cte_spine as s left join Transactions as t on s.dt = t.trans_date and s.country = t.country group by 1, 2 ), cte_cbs_agg as ( select concat(year(s.dt),'-', lpad(month(s.dt),2,0)) as month, s.country, sum(if(cb.trans_date is not null, 1, 0)) as chargeback_count, sum(if(cb.trans_date is not null, cb.amount, 0)) as chargeback_amount from cte_spine as s left join cte_chargebacks_wide as cb on s.dt = cb.trans_date and s.country = cb.country group by 1, 2 ), cte_txn_cb_join as ( select t.month, t.country, coalesce(approved_count, 0) as approved_count, coalesce(approved_amount, 0) as approved_amount, coalesce(chargeback_count, 0) as chargeback_count, coalesce(chargeback_amount, 0) as chargeback_amount from cte_txns_agg as t join cte_cbs_agg as cb on t.month = cb.month and t.country = cb.country ), cte_final as ( select * from cte_txn_cb_join where not ( approved_count + approved_amount + chargeback_count + chargeback_amount = 0 ) order by 1, 2 ) select * from cte_final
with stacked as ( select date_format(c.trans_date, '%Y-%m') as month, country, null as approved_count, null as approved_amount, count(1) as chargeback_count, sum(amount) as chargeback_amount from chargebacks c left join transactions t on c.trans_id = t.id group by 1,2 union all select date_format(trans_date, '%Y-%m') as month, country, sum(case when state='approved' then 1 end) as approved_count, sum(case when state='approved' then amount else 0 end)as approved_amount, null as chargeback_count, null as chargeback_amount from transactions group by 1,2 ) select month, country, coalesce(sum(approved_count), 0) as approved_count, coalesce(sum(approved_amount), 0) as approved_amount, coalesce(sum(chargeback_count), 0) as chargeback_count, coalesce(sum(chargeback_amount), 0) as chargeback_amount from stacked group by 1,2 having coalesce(sum(approved_count), 0) + coalesce(sum(approved_amount), 0) + coalesce(sum(chargeback_count), 0) + coalesce(sum(chargeback_amount), 0) <> 0
with stacked as ( select date_format(c.trans_date, '%Y-%m') as month, country, null as approved_count, null as approved_amount, count(1) as chargeback_count, sum(amount) as chargeback_amount from chargebacks c left join transactions t on c.trans_id = t.id group by 1,2 union all select date_format(trans_date, '%Y-%m') as month, country, sum(state='approved') as approved_count, sum(if(state='approved', amount, 0)) as approved_amount, null as chargeback_count, null as chargeback_amount from transactions group by 1,2 ) select month, country, coalesce(sum(approved_count), 0) as approved_count, coalesce(sum(approved_amount), 0) as approved_amount, coalesce(sum(chargeback_count), 0) as chargeback_count, coalesce(sum(chargeback_amount), 0) as chargeback_amount from stacked group by 1,2 having coalesce(sum(approved_count), 0) + coalesce(sum(approved_amount), 0) + coalesce(sum(chargeback_count), 0) + coalesce(sum(chargeback_amount), 0) <> 0
with sub as( select id , country , "Chargeback" as state ,amount ,c.trans_date from Transactions t right join Chargebacks c on c.trans_id = t.id union select id , country , state ,amount ,trans_date from Transactions t ) select substring(trans_date,1,7) as month, country, sum(case when state="approved" then 1 else 0 end) as approved_count, sum(case when state="approved" then amount else 0 end) as approved_amount ,sum(case when state="Chargeback" then 1 else 0 end) as chargeback_count , sum(case when state="Chargeback" then amount else 0 end) as chargeback_amount FROM sub WHERE state IN ('approved', 'chargeback') GROUP BY 1, 2
with sub as(select id , country , "Chargeback" as state, amount, c.trans_date from Transactions t right join Chargebacks c on c.trans_id = t.id union select id , country , state ,amount ,trans_date from Transactions t ) select substring(trans_date,1,7) as month, country, sum(case when state="approved" then 1 else 0 end) as approved_count, sum(case when state="approved" then amount else 0 end) as approved_amount ,sum(case when state="Chargeback" then 1 else 0 end) as chargeback_count , sum(case when state="Chargeback" then amount else 0 end) as chargeback_amount FROM sub WHERE state IN ('approved', 'chargeback') GROUP BY 1, 2
with t1 as ( SELECT id, country, state, amount, LEFT(trans_date, 7) As month FROM Transactions ), t2 as ( SELECT trans_id As id, LEFT(trans_date, 7) As month FROM Chargebacks ) SELECT t3.month, t3.country, t3.approved_count, t3.approved_amount, IFNULL(t4.chargeback_count, 0) As chargeback_count, IFNULL(t4.chargeback_amount, 0) As chargeback_amount FROM ( SELECT month, country, IFNULL(COUNT(id), 0) As 'approved_count', IFNULL(SUM(amount), 0) As 'approved_amount' FROM t1 WHERE state = 'approved' GROUP BY month, country ) t3 LEFT JOIN ( SELECT month, country, IFNULL(COUNT(id), 0) As 'chargeback_count', IFNULL(SUM(amount), 0) As 'chargeback_amount' FROM ( SELECT t2.id, t2.month, t1.country, t1.amount FROM t1 JOIN t2 ON t1.id = t2.id ) t GROUP BY month, country ) t4 ON t3.month = t4.month AND t3.country = t4.country WHERE approved_count <> 0 OR approved_amount <> 0 OR chargeback_count <> 0 OR chargeback_amount <> 0 UNION SELECT t6.month, t6.country, IFNULL(t5.approved_count, 0) As chargeback_count, IFNULL(t5.approved_amount, 0) As chargeback_amount, t6.chargeback_count, t6.chargeback_amount FROM ( SELECT month, country, IFNULL(COUNT(id), 0) As 'approved_count', IFNULL(SUM(amount), 0) As 'approved_amount' FROM t1 WHERE state = 'approved' GROUP BY month, country ) t5 RIGHT JOIN ( SELECT month, country, IFNULL(COUNT(id), 0) As 'chargeback_count', IFNULL(SUM(amount), 0) As 'chargeback_amount' FROM ( SELECT t2.id, t2.month, t1.country, t1.amount FROM t1 JOIN t2 ON t1.id = t2.id ) t0 GROUP BY month, country ) t6 ON t5.month = t6.month AND t5.country = t6.country WHERE approved_count <> 0 OR approved_amount <> 0 OR chargeback_count <> 0 OR chargeback_amount <> 0
with t1 as ( select *, left(trans_date, 7) as month from transactions where state = 'approved' ), t2 as ( select month, country, count(distinct id) as approved_count, sum(amount) as approved_amount from t1 group by month, country ), c1 as ( select c.*, left(c.trans_date, 7) as month, amount, country from chargebacks c left join transactions t on c.trans_id = t.id ), c2 as ( select month, country, count(distinct trans_id) as chargeback_count, sum(amount) as chargeback_amount from c1 group by month, country ) select month, country, ifnull(approved_count, 0) as approved_count, ifnull(approved_amount, 0) as approved_amount, ifnull(chargeback_count, 0) as chargeback_count, ifnull(chargeback_amount, 0) as chargeback_amount from c2 left join t2 using(month,country) union select month, country, ifnull(approved_count, 0) as approved_count, ifnull(approved_amount, 0) as approved_amount, ifnull(chargeback_count, 0) as chargeback_count, ifnull(chargeback_amount, 0) as chargeback_amount from c2 right join t2 using(month,country)
with t1 as ( select date_format(trans_date, '%Y-%m') month, country, "approved" as state, amount from transactions where state = 'approved' UNION ALL select date_format(c.trans_date, '%Y-%m') month, country, "back" as state, amount from chargebacks c join transactions t on c.trans_id = t.id ) select month, country, sum(if(state='approved',1,0)) as approved_count, sum(if(state='approved',amount,0)) as approved_amount, sum(if(state='back',1,0)) as chargeback_count, sum(if(state='back',amount,0)) as chargeback_amount from t1 group by 1,2
with t1 as ( select left(c.trans_date, 7) as month, sum(amount) as chargeback_amount, count(trans_id) as chargeback_count, country from chargebacks c left join transactions t on c.trans_id = t.id group by left(c.trans_date, 7),country ), t2 as ( select left(trans_date, 7) as month, sum(amount) as approved_amount, count(id) as approved_count, country from transactions where state = 'approved' group by left(trans_date, 7), country ), t3 as ( select month, country from t1 union select month, country from t2 ) select month, country, ifnull(approved_count, 0) as approved_count, ifnull(approved_amount, 0) as approved_amount, ifnull(chargeback_count, 0) as chargeback_count, ifnull(chargeback_amount, 0) as chargeback_amount from t3 left join t1 using(month, country) left join t2 using(month, country) order by month
with t1 as ( select month, country, sum(if(state='approved', 1, 0)) as approved_count, sum(amount) as approved_amount from (select id, country, state, amount, date_format(trans_date, '%Y-%m') as month from transactions where state='approved') t group by month, country), t2 as (select month, country, count(*) as chargeback_count, sum(amount) as chargeback_amount from (select date_format(c.trans_date, '%Y-%m') as month, tr.country, tr.amount from chargebacks c join transactions tr on c.trans_id = tr.id) temp group by month, country ) select ifnull(t1.month, t2.month) as month, ifnull(t1.country, t2.country) as country, ifnull(t1.approved_count, 0) as approved_count, ifnull(t1.approved_amount, 0) as approved_amount, ifnull(t2.chargeback_count, 0) as chargeback_count, ifnull(t2.chargeback_amount, 0) as chargeback_amount from t1 left join t2 using (month, country) union select ifnull(t1.month, t2.month) as month, ifnull(t1.country, t2.country) as country, ifnull(t1.approved_count, 0) as approved_count, ifnull(t1.approved_amount, 0) as approved_amount, ifnull(t2.chargeback_count, 0) as chargeback_count, ifnull(t2.chargeback_amount, 0) as chargeback_amount from t1 right join t2 using (month, country)
with t1 as (select left(trans_date, 7) as 'month', country, count(*) as cnt1, sum(amount) as sum1 from transactions where state = 'approved' group by 1, 2), t2 as (select left(a.trans_date, 7) as 'month', country, count(*) as cnt2, sum(amount) as sum2 from chargebacks a join transactions b on a.trans_id = b.id group by 1, 2), t3 as (select t1.month, country from t1 union select t2.month, country from t2) select t3.month, t3.country, ifnull(cnt1, 0) as approved_count, ifnull(sum1, 0) as approved_amount, ifnull(cnt2, 0) as chargeback_count, ifnull(sum2, 0) as chargeback_amount from t3 left join t1 on t3.month = t1.month and t3.country = t1.country left join t2 on t3.month = t2.month and t3.country = t2.country
with t1 as (select left(trans_date, 7) as 'month', country, count(*) as cnt1, sum(amount) as sum1 from transactions where state = 'approved' group by 1,2), t2 as (select left(a.trans_date, 7) as 'month', country, count(*) as cnt2, sum(amount) as sum2 from chargebacks a join transactions b on a.trans_id = b.id group by 1,2), t3 as (select t1.month, country from t1 union select t2.month, country from t2) select t3.month, t3.country, ifnull(cnt1, 0) as approved_count, ifnull(sum1, 0) as approved_amount, ifnull(cnt2, 0) as chargeback_count, ifnull(sum2, 0) as chargeback_amount from t3 left join t1 on t3.month = t1.month and t3.country = t1.country left join t2 on t3.month = t2.month and t3.country = t2.country
with tab1 as ( select date_format(trans_date, '%Y-%m') as month, country, count(state) as approved_count, sum(amount) as approved_amount from transactions where state = 'approved' group by date_format(trans_date, '%Y-%m'), country ), tab2 as ( select date_format(c.trans_date, '%Y-%m') as month, t.country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from chargebacks as c join transactions as t on c.trans_id = t.id group by date_format(c.trans_date, '%Y-%m'), t.country ) select tab1.month, tab1.country, tab1.approved_count, tab1.approved_amount, ifnull(tab2.chargeback_count,0) as chargeback_count, ifnull(tab2.chargeback_amount,0) as chargeback_amount from tab1 left join tab2 on tab1.month = tab2.month and tab1.country = tab2.country union select tab2.month, tab2.country, ifnull(tab1.approved_count, 0) as approved_count, ifnull(tab1.approved_amount, 0) as approved_amount, tab2.chargeback_count, tab2.chargeback_amount from tab1 right join tab2 on tab1.month = tab2.month and tab1.country = tab2.country
with temp as ( select id,country,'charge' as state,amount,left(Chargebacks.trans_date,7) as month from Chargebacks left join Transactions on Transactions.id=Chargebacks.trans_id union select id,country,state,amount,left(Transactions.trans_date,7) as month from Transactions where state='approved' ) select month,country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='charge' then 1 else 0 end) as chargeback_count, sum(case when state='charge'then amount else 0 end) as chargeback_amount from temp group by month,country
with temp as ( select t.id, country, 'chargebacks' state, amount, date_format(c.trans_date, '%Y-%m') month from chargebacks c left join transactions t on c.trans_id = t.id union select id, country, state, amount, date_format(trans_date, '%Y-%m') month from transactions t where state = 'approved') select month, country, count(case when state = 'approved' then id else null end) approved_count, sum(case when state = 'approved' then amount else 0 end) approved_amount, count(case when state = 'chargebacks' then id else null end) chargeback_count, sum(case when state = 'chargebacks' then amount else 0 end) chargeback_amount from temp group by month, country
with temp as (select * from Transactions union all select c.trans_id as id, t.country, 'chargeback' as state, t.amount,c.trans_date from Transactions t right join Chargebacks c on t.id = c.trans_id) select left(trans_date,7) as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when state = 'chargeback' then amount else 0 end) as chargeback_amount from temp group by month(trans_date),country having approved_count<>0 or chargeback_count<>0
with temp as (select id, country, state, amount, date_format(trans_date,"%Y-%m") as month from transactions union (select c.trans_id, country, "chargeback", amount, date_format(c.trans_date,"%Y-%m") as month from transactions t right join chargebacks c on t.id = c.trans_id) ) select * from (select distinct month, country, ifnull(count(case when state = 'approved' then 1 end) over(partition by month, country),0) as approved_count, ifnull(sum(case when state = 'approved' then amount end) over(partition by month, country),0) as approved_amount, ifnull(count(case when state = 'chargeback' then 1 end) over(partition by month, country),0) as chargeback_count, ifnull(sum(case when state = 'chargeback' then amount end) over(partition by month, country),0) as chargeback_amount from temp) temp2 where approved_count + approved_amount + chargeback_count + chargeback_amount <>0
with temp as (select substr(trans_date,1,7) as month, country as country, count(distinct id) as approved_count, sum(amount) as approved_amount from transactions where state='approved' group by substr(trans_date,1,7), country), temp2 as (select substr(c.trans_date,1,7) as month, t.country as country, count(c.trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from chargebacks c, transactions t where c.trans_id = t.id group by substr(c.trans_date,1,7), t.country) select t.month, t.country, t.approved_count, t.approved_amount, coalesce(t2.chargeback_count,0) as chargeback_count, coalesce(t2.chargeback_amount,0) as chargeback_amount from temp t left outer join temp2 t2 on t.month = t2.month and t.country = t2.country union select t2.month, t2.country, coalesce(t.approved_count,0) as approved_count, coalesce(t.approved_amount,0) as approved_amount, t2.chargeback_count, t2.chargeback_amount from temp2 t2 left outer join temp t on t2.month = t.month and t2.country = t.country
with temp as (select t.id, country, state, amount, Chargebacks.trans_date from Transactions t right join Chargebacks on t.id=Chargebacks.trans_id), chargebacks as (select date_format(temp.trans_date, '%Y-%m') as month , country, sum(amount) as chargeback_amount, count(*) as chargeback_count from temp group by date_format(temp.trans_date, '%Y-%m'), country) , approved as (select date_format(Transactions.trans_date, '%Y-%m') as month , country, sum(amount) as approved_amount, count(*) as approved_count from Transactions where state="approved" group by date_format(Transactions.trans_date, '%Y-%m'), country) select ifnull(approved.month,chargebacks.month) as month, ifnull(approved.country, chargebacks.country) as country, ifnull(approved_count,0)as approved_count, ifnull(approved_amount,0) as approved_amount , ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from approved left JOIN chargebacks on chargebacks.month=approved.month and chargebacks.country=approved.country union select ifnull(approved.month,chargebacks.month) as month, ifnull(approved.country, chargebacks.country) as country, ifnull(approved_count,0)as approved_count, ifnull(approved_amount,0) as approved_amount , ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from approved right JOIN chargebacks on chargebacks.month=approved.month and chargebacks.country=approved.country
with temp1 as ( SELECT LEFT(Transactions.trans_date, 7) month, country, COUNT(Transactions.id) AS approved_count, SUM(Transactions.amount) AS approved_amount FROM Transactions WHERE state = 'approved' GROUP BY LEFT(Transactions.trans_date, 7),country ), temp2 as ( select left(c.trans_date,7) as month, t.country, count(trans_id) chargeback_count, sum(t.amount) chargeback_amount from chargebacks c left join transactions t on c.trans_id=t.id group by 1,2 order by 1,2 ) select month, country, ifnull(approved_count, 0) approved_count, ifnull(approved_amount, 0) approved_amount, ifnull(chargeback_count,0) chargeback_count, ifnull(chargeback_amount,0) chargeback_amount from temp1 left join temp2 using(month,country) union select month, country, ifnull(approved_count, 0) approved_count, ifnull(approved_amount, 0) approved_amount, ifnull(chargeback_count,0) chargeback_count, ifnull(chargeback_amount,0) chargeback_amount from temp1 right join temp2 using(month,country)
with temp_table as ( select *, SUBSTRING_INDEX(trans_date, '-', 2) as month from transactions Union all select c.trans_id as id, t.country, 'chargeback' as state, t.amount as amount, c.trans_date as trans_date, SUBSTRING_INDEX(c.trans_date, '-', 2) as month from transactions t join chargebacks c on t.id = c.trans_id) select * from (select month, country, sum(case when state = 'approved' then 1 else 0 end ) as approved_count, sum(case when state = 'approved' then amount else 0 end ) as approved_amount, sum(case when state = 'chargeback' then 1 else 0 end ) as chargeback_count, sum(case when state = 'chargeback' then amount else 0 end ) as chargeback_amount from temp_table group by month, country order by month)a where approved_count + approved_amount + chargeback_count + chargeback_amount > 0
with temp_transaction as ( select date_format(trans_date, '%Y-%m') as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount from transactions where state = 'approved' group by date_format(trans_date, '%Y-%m'), country), temp_chargeback as ( select date_format(c.trans_date, '%Y-%m') as month, t.country, count(trans_id) as chargeback_count, sum(t.amount) as chargeback_amount from chargebacks c left join transactions t on c.trans_id = t.id group by 1, 2) select t1.month, t1.country, approved_count, approved_amount, case when chargeback_count is null then 0 else chargeback_count end as chargeback_count, case when chargeback_amount is null then 0 else chargeback_amount end as chargeback_amount from temp_transaction t1 left join temp_chargeback t2 on t1.month = t2.month and t1.country = t2.country union select t2.month, t2.country, case when approved_count is null then 0 else approved_count end as approved_count, case when approved_amount is null then 0 else approved_amount end as approved_amount, chargeback_count, chargeback_amount from temp_chargeback t2 left join temp_transaction t1 on t1.month = t2.month and t1.country = t2.country
with tmp as ( select * from transactions where state = 'approved' union all select id, country, 'back' as state, amount, c.trans_date from transactions join chargebacks c on id = trans_id ) select left(trans_date, 7) as month, country, sum(case when state = 'approved' then 1 else 0 end) as approved_count, sum(case when state = 'approved' then amount else 0 end) as approved_amount, sum(case when state = 'back' then 1 else 0 end) as chargeback_count, sum(case when state = 'back' then amount else 0 end) as chargeback_amount from tmp group by left(trans_date, 7), country
with tmp as (select left(trans_date,7) as month, country, id, state, amount from transactions where state='approved' union all select left(a.trans_date,7) as month, country, id, 'cb' as state, amount from chargebacks a inner join transactions b on a.trans_id=b.id ) select month, country, count(case when state='approved' then id else null end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, count(case when state='cb' then id else null end) as chargeback_count, sum(case when state='cb' then amount else 0 end) as chargeback_amount from tmp group by 1,2 order by 1,2
with tmp as( select a.trans_id as id, b.country, 'checkback' as state, b.amount, a.trans_date from chargebacks as a left join transactions as b on a.trans_id = b.id union all select * from transactions where state='approved' ) select left(trans_date,7) as month, country, sum(case when state='approved' then 1 else 0 end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(case when state='checkback' then 1 else 0 end) as chargeback_count, sum(case when state='checkback' then amount else 0 end) as chargeback_amount from tmp group by month, country
with tmp2 as (select left(a.trans_date,7) as month, country, count(trans_id) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks a inner join Transactions b on a.trans_id=b.id group by 1,2 ), tmp1 as (select left(trans_date,7) as month, country, count(case when state='approved' then id end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount from Transactions group by 1,2 ) select * from (select tmp1.*, ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from tmp1 left join tmp2 using (month, country) where tmp2.month is null and tmp2.country is null union select coalesce(tmp1.month, tmp2.month) as month, coalesce(tmp1.country, tmp2.country) as country, ifnull(approved_count,0) as approved_count, ifnull(approved_amount,0) as approved_amount, chargeback_count, chargeback_amount from tmp1 right join tmp2 using (month, country)) t where !(approved_count=0 and approved_amount=0 and chargeback_count=0 and chargeback_amount=0)
with tmp2 as (select left(a.trans_date,7) as month, country, count(trans_id) as chargeback_count, sum(amount) as chargeback_amount from Chargebacks a inner join Transactions b on a.trans_id=b.id group by 1,2 ), tmp1 as (select left(trans_date,7) as month, country, count(case when state='approved' then id end) as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount from Transactions group by 1,2 ) select * from (select tmp1.*, ifnull(chargeback_count,0) as chargeback_count, ifnull(chargeback_amount,0) as chargeback_amount from tmp1 left join tmp2 using (month, country) where tmp2.month is null and tmp2.country is null union select coalesce(tmp1.month, tmp2.month) as month, coalesce(tmp1.country, tmp2.country) as country, ifnull(approved_count,0) as approved_count, ifnull(approved_amount,0) as approved_amount, chargeback_count, chargeback_amount from tmp1 right join tmp2 using (month, country)) t where approved_count!=0 or approved_amount!=0 or chargeback_count!=0 or chargeback_amount!=0
with total as ( select trans_id as id, t.country, "chargeback" as state, t.amount as amount, LEFT(c.trans_date, 7) as month from Chargebacks as c join Transactions as t on c.trans_id = t.id union all select id, country, state, amount, LEFT(trans_date, 7) as month from Transactions ), total1 as ( select id, country, case when state = 'approved' then 1 else 0 end as approved, case when state = 'chargeback' then 1 else 0 end as chargeback, month, amount from total ) select month, country, sum(approved) as approved_count, sum(approved*amount) as approved_amount, sum(chargeback) as chargeback_count, sum(chargeback*amount) as chargeback_amount from total1 group by month, country having approved_count > 0 or chargeback_count > 0
with trans as (select distinct * from transactions where state='approved' union all select distinct t.id, t.country, 'chargeback' as state, t.amount, c.trans_date from transactions t join chargebacks c on t.id=c.trans_id) select date_format(trans_date, '%Y-%m') as month, country, sum(state='approved') as approved_count, sum(case when state='approved' then amount else 0 end) as approved_amount, sum(state='chargeback') as chargeback_count, sum(case when state='chargeback' then amount else 0 end) as chargeback_amount from trans group by 1,2
with trans_sum as ( select id "trans_id", date_format(trans_date, "%Y-%m") "month", country, amount from transactions where state = 'approved' ), cb_sum as ( select c.trans_id, t.country, date_format(c.trans_date, "%Y-%m") "month", t.amount "chargeback_amount" from chargebacks c join transactions t on t.id = c.trans_id ), all_months as ( select distinct country, date_format(trans_date, "%Y-%m") "month" from transactions union select distinct t.country, date_format(c.trans_date, "%Y-%m") "month" from chargebacks c join transactions t on c.trans_id = t.id ) select month, country, ifnull(approved_count, 0) "approved_count", ifnull(approved_amount, 0) "approved_amount", ifnull(chargeback_count, 0) "chargeback_count", ifnull(chargeback_amount, 0) "chargeback_amount" from (select a.month, a.country, approved_count "approved_count", approved_amount "approved_amount", count(distinct c.trans_id) "chargeback_count", sum(chargeback_amount) "chargeback_amount" from (select a.month, a.country, count(distinct t.trans_id) "approved_count", sum(t.amount) "approved_amount" from all_months a left join trans_sum t on t.month = a.month and t.country = a.country group by 1, 2 ) a left join cb_sum c on c.month = a.month and c.country = a.country group by 1, 2, 3, 4 ) result_table where approved_count + chargeback_count != 0
with txn as (select left(t.trans_date,7) as month ,country ,sum(case when state='approved' then 1 else 0 end) as approved_count ,sum(case when state='approved' then amount else 0 end) as approved_amount ,0 as chargeback_count ,0 as chargeback_amount from transactions t group by 1,2 union all select left(c.trans_date,7) as month ,country ,0 as approved_count ,0 as approved_amount ,sum(case when trans_id is not null then 1 else 0 end) as chargeback_count ,sum(case when trans_id is not null then amount else 0 end) as chargeback_amount from transactions t LEFT JOIN chargebacks c on t.id=c.trans_id group by 1,2) select month, country, sum(txn.approved_count) as approved_count, sum(txn.approved_amount) as approved_amount, sum(chargeback_count) as chargeback_count, sum(chargeback_amount) as chargeback_amount from txn group by 1,2 having approved_count+approved_amount+chargeback_count+chargeback_amount!=0
with union_cte as ( select * from Transactions union select t.id, t.country, 'chargeback' as state, t.amount, c.trans_date from Transactions t join Chargebacks c on t.id = c.trans_id ) select DATE_FORMAT(trans_date, "%Y-%m") as month, country, count(case when state = 'approved' then state end) as approved_count, IFNULL(sum(case when state = 'approved' then amount end),0) as approved_amount, count(case when state = 'chargeback' then state end) as chargeback_count, IFNULL(sum(case when state = 'chargeback' then amount end),0) as chargeback_amount from union_cte group by month, country having approved_count != 0 or approved_amount != 0 or chargeback_count != 0 or chargeback_amount != 0
with union_cte as ( select * from Transactions union select t.id, t.country, 'chargeback' as state, t.amount, c.trans_date from Transactions t join Chargebacks c on t.id = c.trans_id ), final_cte as ( select DATE_FORMAT(trans_date, "%Y-%m") as month, country, count(case when state = 'approved' then state end) as approved_count, IFNULL(sum(case when state = 'approved' then amount end),0) as approved_amount, count(case when state = 'chargeback' then state end) as chargeback_count, IFNULL(sum(case when state = 'chargeback' then amount end),0) as chargeback_amount from union_cte group by month, country ) select * from final_cte where approved_count != 0 or approved_amount != 0 or chargeback_count != 0 or chargeback_amount != 0
with union_cte as ( select * from Transactions union select t.id, t.country, case when t.state then 'chargeback' end as state, t.amount, c.trans_date from Transactions t join Chargebacks c on t.id = c.trans_id ), final_cte as ( select DATE_FORMAT(trans_date, "%Y-%m") as month, country, count(case when state = 'approved' then state end) as approved_count, IFNULL(sum(case when state = 'approved' then amount end),0) as approved_amount, count(case when state = 'chargeback' then state end) as chargeback_count, IFNULL(sum(case when state = 'chargeback' then amount end),0) as chargeback_amount from union_cte group by month, country ) select * from final_cte where approved_count != 0 or approved_amount != 0 or chargeback_count != 0 or chargeback_amount != 0
with x as ( select * from transactions where state = 'approved' union select c.trans_id as id,t.country,'chargeback' as state, t.amount,c.trans_date from chargebacks as c inner join transactions as t on t.id = c.trans_id ) select left(trans_date,7) as month, country, sum(state = 'approved') as approved_count, sum( case when state = 'approved' then amount else 0 end ) as approved_amount, sum(state = 'chargeback') as chargeback_count, sum( case when (state = 'chargeback') then amount else 0 end ) as chargeback_amount from x group by 1,2
with x as ( select * from transactions where state = 'approved' union select c.trans_id as id,t.country,'chargeback' as state, t.amount,c.trans_date from chargebacks as c left join transactions as t on t.id = c.trans_id ) select left(trans_date,7) as month, country, sum(state = 'approved') as approved_count, sum( case when state = 'approved' then amount else 0 end ) as approved_amount, sum(state = 'chargeback') as chargeback_count, sum( case when (state = 'chargeback') then amount else 0 end ) as chargeback_amount from x group by 1,2
with x as ( select t.*, c.trans_date as chargeback_date from transactions t left join chargebacks c on t.id = c.trans_id ) select * from ( select date_format(t.trans_date, '%Y-%m') as month, t.country, sum(case when t.state = 'approved' then 1 else 0 end) as approved_count, sum(case when t.state = 'approved' then t.amount else 0 end) as approved_amount, sum(case when t.state = 'chargeback' then 1 else 0 end) as chargeback_count, sum(case when t.state = 'chargeback' then t.amount else 0 end) as chargeback_amount from ( select id, country, state, amount, trans_date from x union all select id, country, 'chargeback' as state, amount, chargeback_date as trans_date from x where chargeback_date is not null) t group by 1, 2) a where approved_count!=0 or approved_amount!=0 or chargeback_count !=0 or chargeback_amount!= 0
