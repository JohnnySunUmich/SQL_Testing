SELECT a.spend_date, a.platform, IFNULL(SUM(amount), 0) AS total_amount, COUNT(user_id) AS total_users FROM (SELECT DISTINCT(spend_date), 'desktop' AS platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' AS platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' AS platform FROM Spending ) a LEFT JOIN (SELECT spend_date, user_id, IF (mobile_amount > 0, IF(desktop_amount > 0, 'both', 'mobile'), 'desktop') AS platform, (mobile_amount + desktop_amount) AS amount FROM (SELECT spend_date, user_id, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) mobile_amount, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) desktop_amount FROM Spending GROUP BY spend_date, user_id) temp ) b ON a.spend_date = b.spend_date AND a.platform = b.platform GROUP BY spend_date, platform
SELECT a.spend_date, a.platform, IFNULL(SUM(amount), 0) AS total_amount, COUNT(user_id) AS total_users FROM (SELECT DISTINCT(spend_date), 'mobile' AS platform FROM Spending UNION ALL SELECT DISTINCT(spend_date), 'desktop' AS platform FROM Spending UNION ALL SELECT DISTINCT(spend_date), 'both' AS platform FROM Spending) a LEFT JOIN (SELECT user_id, spend_date, CASE WHEN COUNT(*) = 1 THEN platform ELSE 'both' END AS platform, SUM(amount) AS amount FROM Spending GROUP BY user_id, spend_date) b ON a.spend_date = b.spend_date AND a.platform = b.platform GROUP BY a.spend_date, a.platform
SELECT d.spend_date, d.platform, (case when SUM(st.total_amount) is null then 0 else SUM(st.total_amount) end) as total_amount, (case when count(st.user_id) is null then 0 else count(st.user_id) end) as total_users FROM ( SELECT DISTINCT spend_date, 'desktop' as platform FROM Spending UNION SELECT DISTINCT spend_date , 'mobile' as platform FROM Spending UNION SELECT DISTINCT spend_date , 'both' as platform FROM Spending ) d left JOIN ( SELECT user_id, spend_date, (CASE WHEN COUNT(DISTINCT platform) = 1 THEN MIN(platform) ELSE 'both' END) as platform, SUM(amount) as total_amount FROM Spending GROUP BY user_id, spend_date ) st ON d.spend_date = st.spend_date and d.platform = st.platform group by d.spend_date, d.platform
SELECT d.spend_date, d.platform, IFNULL(sum(m.amount), 0) as total_amount, IFNULL(COUNT(DISTINCT m.user_id),0) as total_users FROM( select distinct spend_date, 'desktop' as platform from spending union all select distinct spend_date, 'mobile' as platform from spending union all select distinct spend_date, 'both' as platform from spending ) d LEFT JOIN( SELECT spend_date, IFNULL(SUM(amount),0) AS amount, user_id, CASE WHEN COUNT(DISTINCT platform)=1 THEN platform ELSE "both" END as platform FROM Spending GROUP BY spend_date, user_id )m ON d.spend_date=m.spend_date and d.platform=m.platform GROUP BY d.spend_date, d.platform
SELECT m1.spend_date ,m1.platform ,SUM(CASE WHEN m2.user_id IS NOT NULL THEN amount ELSE 0 END) AS total_amount ,SUM(CASE WHEN m2.user_id IS NOT NULL THEN 1 ELSE 0 END) AS total_users FROM ( SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'both' AS platform FROM spending ) m1 LEFT JOIN ( SELECT spend_date ,user_id ,CASE WHEN desktop_amount > 0 AND mobile_amount = 0 THEN 'desktop' WHEN desktop_amount = 0 AND mobile_amount > 0 THEN 'mobile' WHEN desktop_amount > 0 and mobile_amount > 0 THEN 'both' ELSE NULL END AS platform ,desktop_amount + mobile_amount AS amount FROM ( SELECT spend_date ,user_id ,SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop_amount ,SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile_amount FROM Spending GROUP BY spend_date, user_id ) t ) m2 ON m1.spend_date = m2.spend_date AND m1.platform = m2.platform GROUP BY m1.spend_date, m1.platform
SELECT p.spend_date, p.platform, IFNULL(SUM(amount), 0) total_amount, COUNT(user_id) total_users FROM ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) p LEFT JOIN ( SELECT spend_date, user_id, IF (mobile_amount > 0, IF(desktop_amount > 0, 'both', 'mobile'), 'desktop') platform, (mobile_amount + desktop_amount) amount FROM ( SELECT spend_date, user_id, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) mobile_amount, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) desktop_amount FROM Spending GROUP BY spend_date, user_id ) o ) t ON p.platform=t.platform AND p.spend_date=t.spend_date GROUP BY spend_date, platform
SELECT p.spend_date, p.platform, IFNULL(SUM(amount), 0) total_amount, COUNT(user_id) total_users FROM ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) p LEFT JOIN ( SELECT spend_date, user_id, IF(mobile_amount > 0, IF(desktop_amount > 0, 'both', 'mobile'), 'desktop') platform, (mobile_amount + desktop_amount) amount FROM ( SELECT spend_date, user_id, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) mobile_amount, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) desktop_amount FROM Spending GROUP BY spend_date, user_id ) o ) t ON p.platform=t.platform AND p.spend_date=t.spend_date GROUP BY spend_date, platform
SELECT p.spend_date, p.platform, IFNULL(SUM(amount), 0) total_amount, COUNT(user_id) total_users FROM (SELECT DISTINCT(spend_date) spend_date, 'both' AS platform FROM Spending UNION SELECT DISTINCT(spend_date), 'desktop' AS platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' AS platform FROM Spending) p LEFT JOIN (SELECT spend_date, user_id, IF(mobile_amount>0, IF(desktop_amount>0, 'both', 'mobile'), 'desktop') AS platform, (desktop_amount + mobile_amount) amount FROM (SELECT spend_date, user_id, SUM(CASE WHEN platform='desktop' THEN amount ELSE 0 END) desktop_amount, SUM(CASE WHEN platform='mobile' THEN amount ELSE 0 END) mobile_amount FROM Spending GROUP BY 1, 2) o )t ON t.spend_date = p.spend_date AND t.platform = p.platform GROUP BY 1, 2
SELECT p.spend_date, p.platform, ifnull(y.total_amount,0) total_amount, ifnull(y.total_users,0) as total_users FROM ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) p LEFT JOIN ( SELECT spend_date, platform, sum(amount) as total_amount, count(user_id) as total_users FROM ( SELECT spend_date, user_id, platform, amount FROM Spending GROUP BY 1,2 HAVING COUNT(*) = 1)t GROUP BY 1,2 UNION SELECT a.spend_date, 'both' as platform, SUM(a.amount + b.amount) as total_users, count(a.user_id) as total_users FROM Spending a JOIN Spending b ON a.user_id = b.user_id AND a.spend_date = b.spend_date AND a.platform < b.platform GROUP BY 1 )y ON p.platform=y.platform AND p.spend_date=y.spend_date
SELECT p.spend_date, p.platform, ifnull(y.total_amount,0) total_amount, ifnull(y.total_users,0) as total_users FROM ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) p LEFT JOIN ( SELECT spend_date, platform, sum(amount) as total_amount, count(user_id) as total_users FROM ( SELECT spend_date, user_id, platform, amount FROM Spending GROUP BY 1,2 HAVING COUNT(*) = 1)t GROUP BY 1,2 UNION SELECT a.spend_date, 'both' as platform, ifnull(SUM(a.amount + b.amount),0) as total_users, ifnull(count(b.user_id),0) as total_users FROM Spending a LEFT JOIN Spending b ON a.user_id = b.user_id AND a.spend_date = b.spend_date AND a.platform < b.platform GROUP BY 1 )y ON p.platform=y.platform AND p.spend_date=y.spend_date
SELECT t1.spend_date, t1.platform, IFNULL(SUM(amount), 0) total_amount , COUNT(user_id) total_users FROM ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending) AS t1 LEFT JOIN ( SELECT spend_date, user_id, IF(mobile_amount > 0, IF(desktop_amount > 0, 'both', 'mobile'), 'desktop') AS platform, (mobile_amount + desktop_amount) AS amount FROM ( SELECT spend_date, user_id , SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) mobile_amount , SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) desktop_amount FROM Spending GROUP BY spend_date, user_id) AS t2 ) AS t3 ON t1.platform=t3.platform AND t1.spend_date=t3.spend_date GROUP BY spend_date, platform
SELECT tmp2.spend_date, tmp2.platform, IFNULL(SUM(total_amount),0) AS total_amount, COUNT(user_id) AS total_users FROM (SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending UNION SELECT DISTINCT spend_date, 'mobile' AS platform FROm Spending UNION SELECT DISTINCT spend_date, 'both' AS platform FROM Spending) tmp2 LEFT JOIN (SELECT spend_date, user_id, (CASE WHEN ma > 0 AND da > 0 THEN 'both' WHEN ma > 0 AND da = 0 THEN 'mobile' ELSE 'desktop' END) AS platform, (da + ma) AS total_amount FROM (SELECT spend_date, user_id, SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS ma, SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS da FROM Spending GROUP BY spend_date, user_id) tmp1) tmp3 ON tmp2.platform = tmp3.platform AND tmp2.spend_date = tmp3.spend_date GROUP BY spend_date, platform
WITH BothPlatforms AS ( SELECT spend_date, 'both' AS 'platform', COUNT(platform) AS 'plt_cnt', SUM(amount) AS 'amount', user_id FROM Spending GROUP BY spend_date, user_id HAVING plt_cnt = 2 ) SELECT spend_date, platform, IFNULL(SUM(amount), 0) AS 'total_amount', IFNULL(COUNT(DISTINCT user_id), 0) AS 'total_users' FROM ( SELECT spend_date, platform, amount, user_id FROM BothPlatforms UNION SELECT spend_date, platform, amount, user_id FROM Spending WHERE (user_id, spend_date) NOT IN (SELECT user_id, spend_date FROM BothPlatforms) UNION ALL SELECT spend_date, 'mobile' AS 'platform', 0 AS amount, null AS 'user_id' FROM Spending UNION ALL SELECT spend_date, 'desktop' AS 'platform', 0 AS amount, null AS 'user_id' FROM Spending UNION ALL SELECT spend_date, 'both' AS 'platform', 0 AS amount, null AS 'user_id' FROM Spending ) AS tbl GROUP BY spend_date, platform ORDER BY spend_date
WITH CET AS (SELECT user_id, spend_date, CASE WHEN COUNT(DISTINCT platform) = 1 THEN platform ELSE 'both' END AS platform, SUM(amount) AS amount, COUNT(*) AS users FROM Spending GROUP BY user_id, spend_date) SELECT T2.spend_date, T2.platform, IFNULL(SUM(amount),0) AS total_amount, IFNULL(COUNT(users),0) AS total_users FROM (SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION ALL SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION ALL SELECT DISTINCT(spend_date), 'both' platform FROM Spending) T2 LEFT JOIN CET ON T2.platform = CET.platform AND T2.spend_date = CET.spend_date GROUP BY spend_date, T2.platform
WITH CET AS (SELECT user_id, spend_date, platform, SUM(amount) AS amount, COUNT(*) AS users FROM Spending GROUP BY user_id, spend_date HAVING COUNT(DISTINCT platform) = 1 UNION ALL (SELECT user_id, spend_date , 'both' AS platform, SUM(amount), COUNT(*) AS users FROM Spending GROUP BY user_id, spend_date HAVING COUNT(DISTINCT platform) = 2)) SELECT T2.spend_date, T2.platform, IFNULL(SUM(amount),0) AS total_amount, IFNULL(COUNT(users),0) AS total_users FROM (SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending) T2 LEFT JOIN CET ON T2.platform = CET.platform AND T2.spend_date = CET.spend_date GROUP BY spend_date, T2.platform
WITH CTE AS ( SELECT distinct spend_date, t1.platform FROM Spending s JOIN (SELECT 'desktop' AS platform UNION SELECT 'mobile' AS platform UNION SELECT 'both' AS platform) AS t1 ) SELECT CTE.spend_date, CTE.platform, IFNULL(SUM(amount),0) AS total_amount, IFNULL(COUNT(user_id),0) AS total_users FROM ( SELECT user_id, spend_date, CASE WHEN COUNT(platform) = 2 THEN 'both' ELSE platform END AS platform, SUM(amount) AS amount FROM Spending s GROUP BY user_id, spend_date) AS temp RIGHT JOIN CTE ON temp.spend_date = CTE.spend_date AND temp.platform = CTE.platform GROUP BY CTE.spend_date, CTE.platform
WITH CTE AS (SELECT user_id, spend_date, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) ma, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) da FROM Spending GROUP BY user_id, spend_date) SELECT spend_date, 'desktop' platform, SUM(CASE WHEN da > 0 AND ma = 0 THEN da ELSE 0 END) total_amount, SUM(CASE WHEN da > 0 AND ma = 0 THEN 1 ELSE 0 END) total_users FROM CTE GROUP BY spend_date UNION ALL SELECT spend_date, 'mobile' platform, SUM(CASE WHEN ma > 0 AND da = 0 THEN ma ELSE 0 END) total_amount, SUM(CASE WHEN ma > 0 AND da = 0 THEN 1 ELSE 0 END) total_users FROM CTE GROUP BY spend_date UNION ALL SELECT spend_date, 'both' platform, SUM(CASE WHEN da > 0 AND ma > 0 THEN ma + da ELSE 0 END) total_amount, SUM(CASE WHEN da > 0 AND ma > 0 THEN 1 ELSE 0 END) total_users FROM CTE GROUP BY spend_date
WITH CTE AS( SELECT spend_date, user_id, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) AS mobile_amount, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) AS desktop_amount FROM Spending GROUP BY spend_date, user_id ), CTE1 AS( SELECT spend_date, user_id, IF(mobile_amount >0, IF(desktop_amount>0, 'both', 'mobile'), 'desktop') AS 'platform', (mobile_amount + desktop_amount) AS amount FROM CTE ORDER BY spend_date ), CTE2 AS( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ORDER BY spend_date ) SELECT a.spend_date, a.platform, IFNULL(SUM(b.amount), 0) AS 'total_amount', COUNT(user_id) AS 'total_users' FROM CTE2 a LEFT JOIN CTE1 b ON a.platform = b.platform AND a.spend_date = b.spend_date GROUP BY spend_date, platform
WITH CTE1 AS ( SELECT 'desktop' AS platform UNION SELECT 'mobile' UNION SELECT 'both' ), CTE2 AS ( SELECT spend_date, platform FROM (SELECT DISTINCT spend_date FROM Spending) as d1 CROSS JOIN CTE1 as d2 ORDER BY 1,2 ), CTE3 AS ( SELECT spend_date, user_id, CASE WHEN COUNT(*) = 1 THEN platform ELSE 'both' END as platform, SUM(amount) as total_amount FROM Spending GROUP BY spend_date, user_id ) SELECT DISTINCT d1.spend_date, d1.platform, SUM(IFNULL(d2.total_amount,0)) as total_amount, COUNT(DISTINCT d2.user_id) as total_users FROM CTE2 as d1 LEFT JOIN CTE3 as d2 ON d1.spend_date = d2.spend_date AND d1.platform = d2.platform GROUP BY 1,2
WITH RECURSIVE platforms AS ( SELECT 'desktop' AS p UNION ALL SELECT 'mobile' UNION ALL SELECT 'both' ), report_template AS ( SELECT DISTINCT s.spend_date, pl.p AS platform FROM Spending s, platforms pl ), adhoc_spending AS ( SELECT spend_date, user_id, amount, CASE WHEN DENSE_RANK() OVER(PARTITION BY spend_date, user_id ORDER BY platform) + DENSE_RANK() OVER(PARTITION BY spend_date, user_id ORDER BY platform DESC) - 1 = 2 THEN 'both' ELSE platform END AS platform FROM Spending ) SELECT rt.spend_date, rt.platform, IFNULL(SUM(s.amount), 0) AS total_amount, COUNT(DISTINCT s.user_id) AS total_users FROM report_template rt LEFT JOIN adhoc_spending s ON rt.spend_date = s.spend_date AND rt.platform = s.platform GROUP BY rt.spend_date, rt.platform
WITH SpendBehavior AS ( SELECT spend_date, user_id, CASE WHEN COUNT(DISTINCT platform) = 2 THEN 'both' ELSE MAX(platform) END AS user_group FROM Spending GROUP BY spend_date, user_id ), SpendGroup AS ( SELECT 'desktop' AS platform UNION SELECT 'mobile' UNION SELECT 'both' ), SpendDates AS ( SELECT DISTINCT spend_date FROM Spending ), ResultsFramework AS ( SELECT SpendDates.spend_date, SpendGroup.platform FROM SpendDates CROSS JOIN SpendGroup ) SELECT ResultsFramework.spend_date, ResultsFramework.platform, SUM(COALESCE(Spending.amount, 0)) AS total_amount, COUNT(DISTINCT Spending.user_id) AS total_users FROM ResultsFramework LEFT JOIN SpendBehavior ON SpendBehavior.user_group = ResultsFramework.platform AND SpendBehavior.spend_date = ResultsFramework.spend_date LEFT JOIN Spending ON Spending.spend_date = SpendBehavior.spend_date AND Spending.user_id = SpendBehavior.user_id GROUP BY ResultsFramework.spend_date, ResultsFramework.platform
WITH T1 AS ( SELECT user_id, spend_date, platform, amount, COUNT(platform) OVER (PARTITION BY spend_date, user_id) AS num FROM Spending ), T2 AS ( SELECT user_id, spend_date, CASE WHEN num = 1 THEN platform ELSE 'both' END AS platform, amount FROM T1 ) SELECT A.spend_date, A.platform, SUM(IFNULL(T2.amount,0)) AS total_amount, COUNT(DISTINCT T2.user_id) AS total_users FROM (SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'both' AS platform FROM Spending ) A LEFT JOIN T2 ON A.spend_date = T2.spend_date AND A.platform = T2.platform GROUP BY 1,2
WITH T3 as ( SELECT spend_date, platform, sum(total_amount) total_amount, count(1) total_users FROM ( SELECT spend_date, user_id, CASE WHEN mobile_uses>0 and desktop_uses>0 THEN 'both' WHEN mobile_uses>0 THEN 'mobile' WHEN desktop_uses>0 THEN 'desktop' ELSE 'UNK' END platform, total_amount FROM ( SELECT spend_date, user_id, SUM(CASE WHEN platform='mobile' THEN 1 ELSE 0 END) mobile_uses, SUM(CASE WHEN platform='desktop' THEN 1 ELSE 0 END) desktop_uses, SUM(amount) total_amount FROM Spending GROUP BY spend_date, user_id ) T4 ) T5 GROUP BY spend_date, platform ), T1 as ( SELECT spend_date FROM T3 GROUP BY spend_date ), T2 as ( SELECT spend_date, 'desktop' platform FROM T1 union SELECT spend_date, 'mobile' platform FROM T1 union SELECT spend_date, 'both' platform FROM T1 ) SELECT T2.spend_date, T2.platform, COALESCE(T3.total_amount, 0) total_amount, COALESCE(T3.total_users, 0) total_users FROM T2 LEFT OUTER JOIN T3 ON T2.spend_date=T3.spend_date and T2.platform=T3.platform
WITH agg AS ( SELECT spend_date, user_id, CASE WHEN COUNT(DISTINCT platform) > 1 THEN 'both' ELSE MAX(platform) END AS platform, SUM(amount) AS amt FROM spending GROUP BY 1, 2 ), agg2 AS ( SELECT spend_date, platform, SUM(amt) AS total_amount, COUNT(DISTINCT user_id) AS total_users FROM agg GROUP BY 1, 2 ORDER BY 1, 4 ), rec AS ( SELECT DISTINCT spend_date, p.platform FROM spending AS s JOIN (SELECT 'desktop' AS platform UNION SELECT 'mobile' UNION SELECT 'both') AS p ) SELECT r.spend_date, r.platform, COALESCE(a.total_amount, 0) AS total_amount, COALESCE(a.total_users, 0) AS total_users FROM rec AS r LEFT JOIN agg2 AS a ON r.spend_date = a.spend_date AND r.platform = a.platform
WITH both_plat AS (SELECT user_id, spend_date, 'both' AS platform, SUM(amount) AS amount FROM Spending GROUP BY 1,2 HAVING COUNT(*)=2), single_plat AS (SELECT s1.user_id, s1.spend_date, s1.platform, s1.amount FROM Spending s1 WHERE s1.spend_date NOT IN (SELECT s2.spend_date FROM both_plat s2 WHERE s2.user_id=s1.user_id)), template AS (SELECT spend_date, 'desktop' AS platform FROM Spending UNION SELECT spend_date, 'mobile' AS platform FROM Spending UNION SELECT spend_Date, 'both' AS platform FROM Spending) SELECT t.spend_date, t.platform, IFNULL(ss.total_amount,0) AS total_amount, IFNULL(ss.total_users,0) AS total_users FROM template t LEFT JOIN (SELECT spend_date, platform, SUM(amount) AS total_amount, COUNT(DISTINCT user_id) AS total_users FROM (SELECT * FROM both_plat UNION ALL SELECT * FROM single_plat) sub GROUP BY 1,2) ss ON t.spend_date = ss.spend_date AND t.platform=ss.platform
WITH c1 AS (SELECT user_id ,spend_date ,platform ,SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS ma ,SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS da FROM Spending GROUP BY 1,2) SELECT spend_date ,'desktop' AS platform ,SUM(CASE WHEN da>0 AND ma=0 THEN da ELSE 0 END) AS total_amount ,SUM(CASE WHEN da>0 AND ma=0 THEN 1 ELSE 0 END) AS total_users FROM c1 GROUP BY 1,2 UNION ALL SELECT spend_date ,'mobile' AS platform ,SUM(CASE WHEN ma>0 AND da=0 THEN ma ELSE 0 END) AS total_amount ,SUM(CASE WHEN ma>0 AND da=0 THEN 1 ELSE 0 END) AS total_users FROM c1 GROUP BY 1,2 UNION ALL SELECT spend_date ,'both' AS platform ,SUM(CASE WHEN ma>0 AND da>0 THEN ma+da ELSE 0 END) AS total_amount ,SUM(CASE WHEN ma>0 AND da>0 THEN 1 ELSE 0 END) AS total_users FROM c1 GROUP BY 1,2
WITH counting AS ( SELECT user_id, spend_date, COUNT(*) ct, platform, SUM(amount) amount FROM Spending GROUP BY 1, 2 ), structure AS ( SELECT DISTINCT spend_date, 'desktop' platform FROM spending UNION SELECT DISTINCT spend_date, 'mobile' platform FROM spending UNION SELECT DISTINCT spend_date, 'both' platform FROM spending ), sorting AS ( SELECT user_id, spend_date, IF(ct = 2, 'both', platform) platform, amount FROM counting ) SELECT s.spend_date, s.platform, COALESCE(SUM(amount), 0) total_amount, COUNT(user_id) total_users FROM structure s LEFT JOIN sorting st ON st.spend_date = s.spend_date AND st.platform = s.platform GROUP BY 1, 2
WITH ct AS ( SELECT user_id, spend_date, COUNT(*) ct, platform, SUM(amount) amount FROM Spending GROUP BY 1, 2 ), structure AS ( SELECT DISTINCT spend_date, 'desktop' platform FROM spending UNION SELECT DISTINCT spend_date, 'mobile' platform FROM spending UNION SELECT DISTINCT spend_date, 'both' platform FROM spending ), sorting AS ( SELECT user_id, spend_date, IF(ct = 2, 'both', platform) platform, amount FROM ct ) SELECT s.spend_date, s.platform, COALESCE(SUM(amount), 0) total_amount, COUNT(user_id) total_users FROM structure s LEFT JOIN sorting st ON st.spend_date = s.spend_date AND st.platform = s.platform GROUP BY 1, 2
WITH cte AS ( SELECT spend_date , user_id , ( CASE WHEN count(platform) = 2 THEN 'both' WHEN max(platform) = 'mobile' THEN 'mobile' ELSE 'desktop' END ) AS platform , sum(amount) AS total_amount FROM spending GROUP BY spend_date, user_id ORDER BY spend_date ) SELECT t2.spend_date , t2.platform , sum( IFNULL (total_amount, 0)) AS total_amount , count(user_id) AS total_users FROM (select DISTINCT spend_date , t.platform FROM cte CROSS JOIN ( SELECT 'desktop' AS platform union SELECT 'mobile' union SELECT 'both' ) t ) t2 LEFT JOIN cte ON t2.spend_date = cte.spend_date AND t2.platform = cte.platform GROUP BY t2.spend_date, t2.platform
WITH cte AS ( SELECT spend_date ,user_id ,SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS desktop_amount ,SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS mobile_amount FROM Spending GROUP BY spend_date, user_id ) SELECT spend_date ,'desktop' AS platform ,SUM(CASE WHEN desktop_amount > 0 AND mobile_amount = 0 THEN desktop_amount ELSE 0 END) AS total_amount ,SUM(CASE WHEN desktop_amount > 0 AND mobile_amount = 0 THEN 1 ELSE 0 END) AS total_users FROM cte GROUP BY spend_date UNION ALL SELECT spend_date ,'mobile' AS platform ,SUM(CASE WHEN desktop_amount = 0 AND mobile_amount > 0 THEN mobile_amount ELSE 0 END) AS total_amount ,SUM(CASE WHEN desktop_amount = 0 AND mobile_amount > 0 THEN 1 ELSE 0 END) AS total_users FROM cte GROUP BY spend_date UNION ALL SELECT spend_date ,'both' AS platform ,SUM(CASE WHEN desktop_amount > 0 AND mobile_amount > 0 THEN desktop_amount + mobile_amount ELSE 0 END) AS total_amount ,SUM(CASE WHEN desktop_amount > 0 AND mobile_amount > 0 THEN 1 ELSE 0 END) AS total_users FROM cte GROUP BY spend_date
WITH cte AS (SELECT user_id ,spend_date ,SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS ma ,SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS da FROM Spending GROUP BY 1,2) SELECT spend_date ,'desktop' AS platform ,SUM(CASE WHEN da>0 AND ma=0 THEN da ELSE 0 END) AS total_amount ,SUM(CASE WHEN da>0 AND ma=0 THEN 1 ELSE 0 END) AS total_users FROM cte GROUP BY 1,2 UNION ALL SELECT spend_date ,'mobile' AS platform ,SUM(CASE WHEN da=0 AND ma>0 THEN ma ELSE 0 END) AS total_amount ,SUM(CASE WHEN da=0 AND ma>0 THEN 1 ELSE 0 END) AS total_users FROM cte GROUP BY 1,2 UNION ALL SELECT spend_date ,'both' AS platform ,SUM(CASE WHEN da>0 AND ma>0 THEN ma+da ELSE 0 END) AS total_amount ,SUM(CASE WHEN da>0 AND ma>0 THEN 1 ELSE 0 END) AS total_users FROM cte GROUP BY 1,2 ORDER BY 1
WITH cte AS (SELECT user_id, spend_date, SUM(amount) AS amount, CASE WHEN SUM(platform = "desktop") = 0 THEN 1 ELSE 0 END AS mobile, CASE WHEN SUM(platform = "mobile") = 0 THEN 1 ELSE 0 END AS desktop, CASE WHEN SUM(platform = "desktop") = 0 or SUM(platform = "mobile") = 0 THEN 0 ELSE 1 END AS `both` FROM Spending GROUP BY 1, 2 ) SELECT spend_date, "mobile" AS platform, SUM(amount * mobile) AS total_amount, SUM(mobile) AS total_users FROM cte GROUP BY 1 UNION ALL SELECT spend_date, "desktop" AS platform, SUM(amount * desktop) AS total_amount, SUM(desktop) AS total_users FROM cte GROUP BY 1 UNION ALL SELECT spend_date, "both" AS platform, SUM(amount * `both`) AS total_amount, SUM(`both`) AS total_users FROM cte GROUP BY 1
WITH cte as ( SELECT spend_date, user_id, SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) as mobile_spent, SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) as desktop_spent FROM Spending GROUP BY 1, 2), cte_2 as ( SELECT spend_date, user_id, IF(mobile_spent > 0 AND desktop_spent > 0, mobile_spent + desktop_spent, 0) as both_spent, IF(mobile_spent > 0 AND desktop_spent = 0, mobile_spent, 0) as mobile_spent, IF(mobile_spent = 0 AND desktop_spent > 0, desktop_spent, 0) as desktop_spent FROM cte ) SELECT spend_date, 'both' as platform, SUM(both_spent) as total_amount, SUM(CASE WHEN both_spent > 0 THEN 1 ELSE 0 END) as total_users FROM cte_2 GROUP BY 1,2 UNION SELECT spend_date, 'mobile' as platform, SUM(mobile_spent) as total_amount, SUM(CASE WHEN mobile_spent > 0 THEN 1 ELSE 0 END) as total_users FROM cte_2 GROUP BY 1,2 UNION SELECT spend_date, 'desktop' as platform, SUM(desktop_spent) as total_amount, SUM(CASE WHEN desktop_spent > 0 THEN 1 ELSE 0 END) as total_users FROM cte_2 GROUP BY 1,2
WITH cte1 AS ( SELECT DISTINCT spend_date, 'desktop' platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'mobile' platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'both' platform FROM Spending ), cte2 AS ( SELECT spend_date,user_id, CASE WHEN COUNT(DISTINCT platform)=1 THEN platform ELSE 'both' END AS platform, SUM(amount) AS total_amount FROM Spending GROUP BY spend_date,user_id ), cte3 AS ( SELECT spend_date, platform, SUM(total_amount) total_amount, COUNT(DISTINCT user_id) user_cnt FROM cte2 GROUP BY spend_date, platform ) SELECT a.spend_date, a.platform, COALESCE(total_amount,0) total_amount, COALESCE(user_cnt,0) total_users FROM cte1 a LEFT JOIN cte3 b ON a.spend_date=b.spend_date AND a.platform=b.platform
WITH cte1 AS ( SELECT user_id, spend_date, 'both' as platform, total_price FROM ( SELECT user_id, spend_date, COUNT(platform) AS cnt, SUM(amount) as total_price FROM Spending GROUP BY user_id, spend_date ) a WHERE cnt > 1 ) , cte2 AS ( SELECT user_id, spend_date, platform, amount as total_price FROM Spending WHERE CONCAT(CAST(user_id AS CHAR(20)),'-',CAST(spend_date AS CHAR(20))) NOT IN (SELECT CONCAT(CAST(user_id AS CHAR(20)),'-',CAST(spend_date AS CHAR(20))) FROM cte1) ) , cte3 AS (SELECT spend_date, 'desktop' AS platform FROM Spending UNION SELECT spend_date, 'mobile' AS platform FROM Spending UNION SELECT spend_Date, 'both' AS platform FROM Spending ) SELECT c.spend_date, c.platform, IFNULL(total_amount,0) as total_amount , IFNULL(total_users,0) as total_users FROM cte3 c LEFT JOIN ( SELECT spend_date, platform, SUM(total_price) AS total_amount, COUNT(user_id) AS total_users FROM ( (SELECT * FROM cte1 a) UNION (SELECT * FROM cte2 b) ) t GROUP BY spend_date, platform ) v ON c.spend_date = v.spend_date AND c.platform = v.platform
WITH cte1 AS ( SELECT user_id, spend_date, 'both' as platform, total_price FROM ( SELECT user_id, spend_date, COUNT(platform) AS cnt, SUM(amount) as total_price FROM Spending GROUP BY user_id, spend_date ) a WHERE cnt > 1 ) , cte2 AS ( SELECT user_id, spend_date, platform, amount as total_price FROM Spending WHERE CONCAT(CAST(user_id AS CHAR(20)),CAST(spend_date AS CHAR(20))) NOT IN (SELECT CONCAT(CAST(user_id AS CHAR(20)),CAST(spend_date AS CHAR(20))) FROM cte1) ) , cte3 AS (SELECT spend_date, 'desktop' AS platform FROM Spending UNION SELECT spend_date, 'mobile' AS platform FROM Spending UNION SELECT spend_Date, 'both' AS platform FROM Spending ) SELECT c.spend_date, c.platform, IFNULL(total_amount,0) as total_amount , IFNULL(total_users,0) as total_users FROM cte3 c LEFT JOIN ( SELECT spend_date, platform, SUM(total_price) AS total_amount, COUNT(user_id) AS total_users FROM ( (SELECT * FROM cte1 a) UNION (SELECT * FROM cte2 b) ) t GROUP BY spend_date, platform ORDER BY spend_date ASC ) v ON c.spend_date = v.spend_date AND c.platform = v.platform
WITH info_lookup AS ( SELECT spend_date, 'desktop' AS platform FROM spending GROUP BY 1, 2 UNION ALL SELECT spend_date, 'mobile' AS platform FROM spending GROUP BY 1, 2 UNION ALL SELECT spend_date, 'both' AS platform FROM spending GROUP BY 1, 2 ) , sales_summary AS ( SELECT spend_date, user_id, CASE WHEN COUNT(DISTINCT platform) > 1 THEN 'both' ELSE MAX(platform) END AS platform, SUM(amount) AS amount FROM spending GROUP BY 1, 2 ) SELECT i.spend_date, i.platform, COALESCE(SUM(s.amount), 0) AS total_amount, COALESCE(COUNT(s.user_id), 0) AS total_users FROM info_lookup i LEFT JOIN sales_summary s ON i.platform = s.platform AND i.spend_date = s.spend_date GROUP BY 1, 2
WITH is_multiple_platforms AS ( SELECT spend_date, user_id, COUNT(DISTINCT platform) AS platform_cnt, SUM(amount) AS amount FROM spending GROUP BY 1, 2 ) , summary AS ( SELECT s.spend_date, s.platform, SUM(s.amount) AS total_amount, COUNT(DISTINCT s.user_id) AS total_users FROM spending s JOIN (SELECT * FROM is_multiple_platforms WHERE platform_cnt = 1) m ON s.user_id = m.user_id AND s.spend_date = m.spend_date GROUP BY 1, 2 UNION ALL SELECT s.spend_date, 'both' AS platform, SUM(s.amount) AS total_amount, COUNT(DISTINCT s.user_id) AS total_users FROM spending s JOIN (SELECT * FROM is_multiple_platforms WHERE platform_cnt > 1) m ON s.user_id = m.user_id AND s.spend_date = m.spend_date GROUP BY 1, 2 ) , platform_lookup AS ( SELECT platform FROM spending GROUP BY 1 UNION ALL SELECT 'both' AS platform FROM spending ) , date_lookup AS ( SELECT spend_date FROM spending GROUP BY 1 ) , lookup AS ( SELECT * FROM date_lookup, platform_lookup GROUP BY 1, 2 ) SELECT l.spend_date, l.platform, COALESCE(s.total_amount, 0 ) AS total_amount, COALESCE(s.total_users, 0) AS total_users FROM lookup l LEFT JOIN summary s ON l.spend_date = s.spend_date AND l.platform = s.platform ORDER BY 1, 2
WITH mobile AS ( SELECT * FROM Spending WHERE platform = 'mobile' ), desktop AS ( SELECT * FROM Spending WHERE platform = 'desktop' ), p as ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) , totals as ( SELECT CASE WHEN t.m_spend_date IS NULL THEN t.d_spend_date ELSE t.m_spend_date END AS spend_date, CASE WHEN t.d_platform IS NOT NULL AND t.m_platform IS NULL then t.d_platform WHEN t.d_platform IS NULL AND t.m_platform IS NOT NULL then t.m_platform ELSE 'both' END AS platform, SUM(COALESCE(d_amount,0)+COALESCE(m_amount,0)) as total_amount, SUM( CASE WHEN t.m_user_id IS NOT NULL AND t.d_user_id IS NOT NULL THEN 1 WHEN t.m_user_id IS NOT NULL AND t.d_user_id IS NULL THEN 1 WHEN t.m_user_id IS NULL AND t.d_user_id IS NOT NULL THEN 1 END) as total_users FROM ( SELECT m.user_id as m_user_id, m.spend_date as m_spend_date, m.platform as m_platform, m.amount as m_amount, d.user_id as d_user_id, d.spend_date as d_spend_date, d.platform as d_platform, d.amount as d_amount FROM mobile AS m LEFT JOIN desktop AS d ON m.user_id = d.user_id AND m.spend_date = d.spend_date UNION SELECT m.user_id as m_user_id, m.spend_date as m_spend_date, m.platform as m_platform, m.amount as m_amount, d.user_id as d_user_id, d.spend_date as d_spend_date, d.platform as d_platform, d.amount as d_amount FROM mobile AS m RIGHT JOIN desktop AS d ON m.user_id = d.user_id AND m.spend_date = d.spend_date ) t GROUP BY 1,2 ORDER BY 1 ) SELECT p.*, COALESCE(totals.total_amount,0) as total_amount, COALESCE(totals.total_users,0) as total_users FROM p left join totals ON p.spend_date = totals.spend_date and p.platform = totals.platform
WITH mobile_only AS ( SELECT spend_date, SUM(amount) AS total_amount, COUNT(*) AS total_users FROM ( SELECT user_id, spend_date, SUM(amount) AS amount FROM Spending GROUP BY user_id, spend_date HAVING SUM(CASE WHEN platform = 'mobile' THEN 1 ELSE 0 END) > 0 AND SUM(CASE WHEN platform = 'desktop' THEN 1 ELSE 0 END) = 0) X1 GROUP BY spend_date ), desktop_only AS ( SELECT spend_date, SUM(amount) AS total_amount, COUNT(*) AS total_users FROM ( SELECT user_id, spend_date, SUM(amount) AS amount FROM Spending GROUP BY user_id, spend_date HAVING SUM(CASE WHEN platform = 'mobile' THEN 1 ELSE 0 END) = 0 AND SUM(CASE WHEN platform = 'desktop' THEN 1 ELSE 0 END) > 0) X2 GROUP BY spend_date ), both_des_mo AS ( SELECT spend_date, SUM(amount) AS total_amount, COUNT(*) AS total_users FROM ( SELECT user_id, spend_date, SUM(amount) AS amount FROM Spending GROUP BY user_id, spend_date HAVING SUM(CASE WHEN platform = 'mobile' THEN 1 ELSE 0 END) > 0 AND SUM(CASE WHEN platform = 'desktop' THEN 1 ELSE 0 END) > 0) X3 GROUP BY spend_date ) (SELECT f1.spend_date, f1.platform, IFNULL(total_amount,0) AS total_amount, IFNULL(total_users,0) AS total_users FROM mobile_only d RIGHT JOIN (SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending) f1 ON d.spend_date = f1.spend_date) UNION (SELECT f2.spend_date, f2.platform, IFNULL(total_amount,0) AS total_amount, IFNULL(total_users,0) AS total_users FROM desktop_only d RIGHT JOIN (SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending) f2 ON d.spend_date = f2.spend_date) UNION (SELECT f3.spend_date, f3.platform, IFNULL(total_amount,0) AS total_amount, IFNULL(total_users,0) AS total_users FROM both_des_mo d RIGHT JOIN (SELECT DISTINCT spend_date, 'both' AS platform FROM Spending) f3 ON d.spend_date = f3.spend_date)
WITH platform AS (SELECT DISTINCT(spend_date) spend_date, 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date) spend_date, 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date) spend_date, 'both' platform FROM Spending) SELECT P1.spend_date, P1.platform, IFNULL(SUM(total_amount),0) total_amount, COUNT(user_id) total_users FROM platform P1 LEFT JOIN (SELECT user_id, spend_date, SUM(amount) total_amount, (CASE WHEN SUM(platform = 'mobile')+SUM(platform = 'desktop') = 2 THEN 'BOTH' WHEN SUM(platform = 'mobile')+SUM(platform = 'desktop') = 1 THEN platform END) platform FROM Spending GROUP BY user_id, spend_date) T1 ON P1.spend_date = T1.spend_date AND P1.platform = T1.platform GROUP BY P1.spend_date, P1.platform
WITH platform AS( SELECT DISTINCT spend_date, "both" as platform FROM Spending UNION ALL SELECT DISTINCT spend_date, "desktop" as platform FROM spending UNION ALL SELECT DISTINCT spend_date, "mobile" as platform FROM spending ) SELECT p.spend_date, p.platform, IFNULL(SUM(s.amount),0) AS total_amount, IFNULL(COUNT(distinct s.user_id),0) as total_users FROM platform as p LEFT JOIN( SELECT user_id, spend_date, SUM(amount) as amount, CASE WHEN count(distinct platform)=2 THEN "both" ELSE platform end AS platform FROM Spending GROUP BY user_id, spend_date )s ON p.spend_date=s.spend_Date and p.platform=s.platform GROUP BY p.spend_date, p.platform
WITH platform_id as ( SELECT user_id, spend_date, CASE WHEN (COUNT(platform) OVER (PARTITION BY user_id, spend_date)) = 2 THEN 'both' ELSE platform END as platform, amount FROM spending ), platform_spend as ( SELECT spend_date, platform, sum(amount) as total_amount, COUNT(DISTINCT user_id) as total_users FROM platform_id GROUP BY spend_date, platform ), all_platform(platform) as ( VALUES ROW('mobile'), ROW('desktop'), ROW('both') ), data_platform_combo as ( SELECT DISTINCT a.spend_date, b.platform FROM platform_id a, all_platform b ) SELECT d.spend_date, d.platform, IFNULL(total_amount,0) as total_amount, IFNULL(total_users,0) as total_users FROM data_platform_combo d LEFT JOIN platform_spend p USING (spend_date, platform) ORDER BY spend_date
WITH platform_table AS ( SELECT a.user_id, a.spend_date, CASE WHEN b.platform IS NOT NULL THEN 'both' ELSE a.platform END AS platform, a.amount FROM Spending a LEFT JOIN Spending b ON a.user_id = b.user_id AND a.spend_date = b.spend_date AND a.platform != b.platform ), date_platform AS ( SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending UNION SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending UNION SELECT DISTINCT spend_date, 'both' AS platform FROM Spending ) SELECT a.spend_date, a.platform, COALESCE(SUM(b.amount), 0) AS total_amount, COUNT(DISTINCT b.user_id) AS total_users FROM date_platform a LEFT JOIN platform_table b ON a.spend_date = b.spend_date AND a.platform = b.platform GROUP BY 1, 2
WITH recursive CET as (select distinct spend_date, 'desktop' platform from spending union all select distinct spend_date, 'mobile' platform from spending union all select distinct spend_date, 'both' platform from spending ), CET2 as ((SELECT user_id, spend_date, platform, sum(amount) as amount from Spending group by user_id, spend_date having count(distinct platform)=1) UNION ALL (SELECT user_id, spend_date, 'both' as platform, sum(amount) as amount from Spending group by user_id, spend_date having count(distinct platform)=2)) SELECT CET.spend_date, CET.platform, sum(ifnull(total_amount,0)) as total_amount, sum(ifnull(total_users,0)) as total_users from (SELECT spend_date, platform, sum(amount) as total_amount, count(distinct user_id) as total_users from CET2 group by spend_date, platform)p1 right join CET on CET.spend_date=p1.spend_date and CET.platform=p1.platform group by CET.spend_date, CET.platform ORDER BY spend_date, platform
WITH summary AS ( SELECT user_id, spend_date, platform, SUM(amount) AS total_amount, COUNT(*) AS total_users FROM Spending GROUP BY user_id, spend_date ), date_platform AS ( SELECT DISTINCT spend_date AS spend_date, 'desktop' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date AS spend_date, 'mobile' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date AS spend_date, 'both' AS platform FROM Spending ), shaped AS ( SELECT user_id, spend_date, CASE WHEN total_users = 2 THEN 'both' ELSE platform END AS platform, total_amount FROM summary ) SELECT d.spend_date, d.platform, IFNULL(SUM(s.total_amount), 0) AS total_amount, COUNT(s.user_id) AS total_users FROM date_platform AS d LEFT JOIN shaped AS s ON d.spend_date = s.spend_date AND d.platform = s.platform GROUP BY d.spend_date, d.platform
WITH t AS( SELECT *, COUNT(platform)OVER(PARTITION BY spend_date, user_id) AS type FROM Spending) SELECT spend_date, 'both' as platform, SUM(case when type =2 THEN amount else 0 end) AS total_amount, COUNT(DISTINCT (case when type =2 THEN user_id else null end)) AS total_users FROM t GROUP BY spend_date UNION SELECT spend_date, 'mobile' as platform, SUM(case when type =1 AND platform = 'mobile' THEN amount else 0 end) AS total_amount, COUNT(DISTINCT (case when type =1 AND platform = 'mobile' THEN user_id else null end)) AS total_users FROM t GROUP BY spend_date UNION SELECT spend_date, 'desktop' as platform, SUM(case when type =1 AND platform = 'desktop' THEN amount else 0 end) AS total_amount, COUNT(DISTINCT (case when type =1 AND platform = 'desktop' THEN user_id else null end)) AS total_users FROM t GROUP BY spend_date
WITH t1 AS ( SELECT spend_date, platform, SUM(amount) AS total_amount, COUNT(user_id) AS total_users FROM Spending WHERE (user_id, spend_date) IN (SELECT user_id, spend_date FROM Spending GROUP BY user_id, spend_date HAVING COUNT(platform) = 1) GROUP BY spend_date, platform ), t2 AS ( SELECT t.spend_date, t.platform, COALESCE(t1.total_amount, 0) AS total_amount, COALESCE(t1.total_users, 0) AS total_users FROM ( SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending UNION ALL SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending ) t LEFT JOIN t1 ON t.spend_date = t1.spend_date AND t.platform = t1.platform ), t3 AS ( SELECT spend_date, 'both' AS platform, SUM(amount) AS total_amount, COUNT(DISTINCT user_id) AS total_users FROM Spending WHERE (user_id, spend_date) IN (SELECT user_id, spend_date FROM Spending GROUP BY user_id, spend_date HAVING COUNT(platform) = 2) GROUP BY spend_date ), t4 AS ( SELECT t.spend_date, COALESCE(t3.platform, 'both') AS platform, COALESCE(t3.total_amount, 0) AS total_amount, COALESCE(t3.total_users, 0) AS total_users FROM ( SELECT DISTINCT spend_date FROM Spending ) t LEFT JOIN t3 ON t.spend_date = t3.spend_date ) SELECT * FROM t2 UNION ALL SELECT * FROM t4
WITH t1 AS ( SELECT user_id, spend_date, SUM(CASE WHEN platform = 'desktop' THEN amount ELSE 0 END) AS 'desktop', SUM(CASE WHEN platform = 'mobile' THEN amount ELSE 0 END) AS 'mobile' FROM Spending GROUP BY user_id, spend_date), t2 AS ( SELECT spend_date, user_id, IF(mobile>0, IF(desktop>0, 'both','mobile'),'desktop') AS platform, SUM(mobile+desktop) AS total_amount, COUNT(user_id) AS total_users FROM t1 GROUP BY spend_date, platform), t3 AS ( SELECT DISTINCT spend_date, 'mobile' AS platform FROM Spending UNION SELECT DISTINCT spend_date, 'desktop' AS platform FROM Spending UNION SELECT DISTINCT spend_date, 'both' AS platform FROM Spending) SELECT t3.spend_date, t3.platform, IFNULL(t2.total_amount,0) AS total_amount, IFNULL(total_users,0) AS total_users FROM t3 LEFT JOIN t2 ON t3.spend_date = t2.spend_date AND t3.platform = t2.platform
WITH t1 AS ( SELECT user_id, spend_date, SUM(amount) AS total_amount, CASE WHEN SUM(platform = 'desktop') = 0 THEN 1 ELSE 0 END AS 'mobile', CASE WHEN SUM(platform = 'mobile') = 0 THEN 1 ELSE 0 END AS 'desktop', CASE WHEN SUM(platform = 'desktop') = 0 OR SUM(platform = 'mobile') = 0 THEN 0 ELSE 1 END AS 'both' FROM Spending GROUP BY 1, 2) SELECT spend_date, 'mobile' AS platform, SUM(total_amount*`mobile`) AS total_amount, SUM(mobile) AS total_users FROM t1 GROUP BY 1 UNION ALL SELECT spend_date, 'desktop' AS platform, SUM(total_amount*`desktop`) AS total_amount, SUM(desktop) AS total_users FROM t1 GROUP BY 1 UNION ALL SELECT spend_date, 'both' AS platform, SUM(total_amount*`both`) AS total_amount, SUM(`both`) AS total_users FROM t1 GROUP BY 1
WITH t1 AS( SELECT spend_date, user_id, CASE WHEN COUNT(DISTINCT platform) = 2 THEN 'both' ELSE platform END AS platform, SUM(amount) AS amount FROM Spending GROUP BY 1, 2 ), t2 AS( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) SELECT t2.*, IFNULL(SUM(amount), 0) AS total_amount, COUNT(DISTINCT user_id) AS total_users FROM t2 LEFT JOIN t1 ON t2.spend_date = t1.spend_date AND t2.platform = t1.platform GROUP BY 1, 2
WITH t1 AS( SELECT spend_date, user_id, CASE WHEN COUNT(DISTINCT platform) = 2 THEN 'both' ELSE platform END AS platform, SUM(amount) AS amount FROM Spending GROUP BY spend_date, user_id ), t2 AS( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) SELECT t2.*, IFNULL(SUM(amount), 0) AS total_amount, COUNT(DISTINCT user_id) AS total_users FROM t2 LEFT JOIN t1 ON t2.spend_date = t1.spend_date AND t2.platform = t1.platform GROUP BY 1, 2
WITH t1 AS( SELECT spend_date, user_id, CASE WHEN COUNT(platform) = 2 THEN 'both' ELSE platform END AS platform, SUM(amount) AS amount FROM Spending GROUP BY 1, 2 ), t2 AS( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) SELECT t2.*, IFNULL(SUM(amount), 0) AS total_amount, COUNT(user_id) AS total_users FROM t2 LEFT JOIN t1 ON t2.spend_date = t1.spend_date AND t2.platform = t1.platform GROUP BY 1, 2
WITH table1 AS( SELECT user_id, spend_date, SUM(CASE WHEN platform='mobile' THEN 1 ELSE 0 END) AS m_user, SUM(CASE WHEN platform='desktop' THEN 1 ELSE 0 END) AS d_user, SUM(CASE WHEN platform='mobile' THEN amount ELSE 0 END) AS m_amount, SUM(CASE WHEN platform='desktop' THEN amount ELSE 0 END) AS d_amount FROM Spending GROUP BY user_id, spend_date ), table2 AS( SELECT user_id, spend_date, CASE WHEN m_user>0 AND d_user>0 THEN 'both' WHEN m_user>0 AND d_user=0 THEN 'mobile' WHEN m_user=0 AND d_user>0 THEN 'desktop' ELSE NULL END AS platform, COALESCE(m_amount,0) + COALESCE(d_amount,0) AS amount FROM table1 GROUP BY user_id, spend_date ), table3 AS( SELECT spend_date, platform, SUM(amount) AS total_amount, COUNT(user_id) AS total_users FROM table2 GROUP BY spend_date, platform ORDER BY spend_date ASC ), all_platform(platform) as ( VALUES ROW('mobile'), ROW('desktop'), ROW('both') ), table4 AS( SELECT DISTINCT a.spend_date, b.platform FROM table2 a, all_platform b ORDER BY spend_date ASC ) SELECT DISTINCT t4.spend_date, t4.platform, COALESCE(t3.total_amount,0) AS total_amount, COALESCE(t3.total_users,0) AS total_users FROM table4 t4 LEFT JOIN table3 t3 USING(spend_date, platform)
WITH temp AS ( SELECT spend_date, user_id, SUM(amount) AS amount, CASE WHEN SUM(IF(platform = 'mobile', 1, 0)) = 0 THEN 1 ELSE 0 END AS 'desktop', CASE WHEN SUM(IF(platform = 'desktop', 1, 0)) = 0 THEN 1 ELSE 0 END AS 'mobile', CASE WHEN SUM(IF(platform = 'desktop', 1, 0)) + SUM(IF(platform = 'mobile', 1, 0)) = 2 THEN 1 ELSE 0 END AS 'b' FROM Spending GROUP BY spend_date, user_id ) SELECT spend_date, 'desktop' AS platform, SUM(desktop * amount) AS total_amount, SUM(desktop) AS total_users FROM temp GROUP BY spend_date UNION ALL SELECT spend_date, 'mobile' AS platform, SUM(mobile * amount) AS total_amount, SUM(mobile) AS total_users FROM temp GROUP BY spend_date UNION ALL SELECT spend_date, 'both' AS platform, SUM(b * amount) AS total_amount, SUM(b) AS total_users FROM temp GROUP BY spend_date
WITH temp AS ( SELECT spend_date, user_id, SUM(amount) AS amount, CASE WHEN SUM(IF(platform = 'mobile', 1, 0)) = 0 THEN 1 ELSE 0 END AS 'desktop', CASE WHEN SUM(IF(platform = 'desktop', 1, 0)) = 0 THEN 1 ELSE 0 END AS 'mobile', CASE WHEN SUM(platform = 'desktop') + SUM(platform = 'mobile') = 2 THEN 1 ELSE 0 END AS 'b' FROM Spending GROUP BY spend_date, user_id ) SELECT spend_date, 'desktop' AS platform, SUM(desktop * amount) AS total_amount, SUM(desktop) AS total_users FROM temp GROUP BY spend_date UNION ALL SELECT spend_date, 'mobile' AS platform, SUM(mobile * amount) AS total_amount, SUM(mobile) AS total_users FROM temp GROUP BY spend_date UNION ALL SELECT spend_date, 'both' AS platform, SUM(b * amount) AS total_amount, SUM(b) AS total_users FROM temp GROUP BY spend_date
With platform_count as ( select spend_date ,user_id ,count(distinct platform) as plat_cnt ,sum(amount) as total_amount from Spending group by 1,2), platform_summ as ( select distinct a.user_id,a.total_amount,a.spend_date , case when a.plat_cnt = 2 then "both" else b.platform end as platform_summ from platform_count a left join Spending b on a.spend_date =b.spend_date and a.user_id = b.user_id), platform_summ_2 as ( select spend_date ,platform_summ as platform ,sum(total_amount) as total_amount ,count(distinct user_id) as total_users from platform_summ group by 1,2) select a.spend_date ,a.platform ,coalesce(total_amount,0) as total_amount ,coalesce(total_users,0) as total_users from (select distinct spend_date, "desktop" as platform from Spending union all select distinct spend_date, "mobile" as platform from Spending union all select distinct spend_date, "both" as platform from Spending ) a left join platform_summ_2 b on a.spend_date =b.spend_date and a.platform = b.platform
With temp_table As ( SELECT user_id, spend_date, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) ma, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) da FROM Spending GROUP BY user_id, spend_date ) SELECT spend_date, 'desktop' AS platform, SUM(CASE WHEN da > 0 AND ma = 0 THEN da ELSE 0 END) as total_amount, SUM(CASE WHEN da > 0 AND ma = 0 THEN 1 ELSE 0 END) as total_users FROM temp_table GROUP BY spend_date Union ALL SELECT spend_date, 'mobile' AS platform, SUM(CASE WHEN ma > 0 AND da = 0 THEN ma ELSE 0 END) as total_amount, SUM(CASE WHEN ma > 0 AND da = 0 THEN 1 ELSE 0 END) as total_users FROM temp_table GROUP BY spend_date Union ALL SELECT spend_date, 'both' AS platform, SUM(CASE WHEN da > 0 AND ma > 0 THEN ma + da ELSE 0 END) as total_amount, SUM(CASE WHEN da > 0 AND ma > 0 THEN 1 ELSE 0 END) as total_users FROM temp_table GROUP BY spend_date
With user_behavior As (Select user_id, spend_date, (Case When Count(*) > 1 Then "Both" Else platform End) as platform, Sum(amount) as amount From Spending Group By user_id, spend_date), spend_date As (Select Distinct spend_date From Spending), platform As ((Select "both" as platform) Union (Select "mobile" as platform) Union (Select "desktop" as platform)) Select a.spend_date, b.platform, ifnull(Sum(c.amount),0) As total_amount, Count(Distinct c.user_id) As total_users From spend_date as a Cross Join platform as b On 1=1 Left Join user_behavior as c On a.spend_date = c.spend_date And b.platform = c.platform Group By a.spend_date, b.platform
With user_platform As (Select user_id, spend_date, (Case When Count(*) = 2 Then "both" Else platform End) As platform, sum(amount) As amount From Spending Group By user_id, spend_date), platform As ((Select "both" As platform) Union (Select "mobile" As platform) Union (Select "desktop" As platform)), spend_date As (Select Distinct spend_date From Spending) Select a.spend_date, b.platform, ifnull(sum(c.amount),0) as total_amount, Count(Distinct c.user_id) as total_users From spend_date As a Cross Join platform as b On 1=1 Left Join user_platform as c On a.spend_date = c.spend_date And b.platform = c.platform Group By a.spend_date, b.platform
select C.spend_date, C.platform, ifnull(D.total_amount,0) as total_amount, ifnull(D.total_users, 0) as total_users from (select spend_date, platform from (select distinct spend_date from Spending) as A cross join ( select 'desktop' as platform union all select 'mobile' as platform union all select 'both' as platform ) as B) as C left join ( select spend_date , platform , sum(amount_1) as total_amount, count(distinct user_id) as total_users from (select *, case when platform_1 = 'mobile' and platform_2 = 'desktop' then 'both' when platform_2 = 'mobile' and platform_1 = 'desktop' then 'both' when platform_1 = 'mobile' and platform_2 is null then 'mobile' else 'desktop' end as platform from (select a.user_id , a.spend_date , a.platform as platform_1, a.amount as amount_1, b.platform as platform_2, b.amount as amount_2 from Spending as a left join Spending as b on a.user_id = b.user_id and a.spend_date = b.spend_date and a.platform <> b.platform ) as c) as d group by spend_date , platform ) as D on C.spend_date = D.spend_date and C.platform = D.platform
select a.spend_date,a.platform, ifnull(sum(total_amount),0) 'total_amount', count(user_id) 'total_users' from ( select distinct spend_date, 'desktop' platform from spending union select distinct spend_date, 'mobile' platform from spending union select distinct spend_date, 'both' platform from spending ) a left join (select spend_date, user_id, (mobile_amount+desktop_amount) 'total_amount', if(mobile_amount>0,if(desktop_amount>0,'both','mobile'),'desktop') platform from (select user_id, spend_date, sum(case platform when 'mobile' then amount else 0 end) 'mobile_amount', sum(case platform when 'desktop' then amount else 0 end) 'desktop_amount' from spending group by spend_date, user_id) b) c on a.spend_date=c.spend_date and a.platform=c.platform group by a.spend_date,a.platform
select c.spend_date , c.platform , sum(coalesce(amount,0)) total_amount , sum(case when amount is null then 0 else 1 end) total_users from (select distinct spend_date, 'desktop' platform from spending union all select distinct spend_date, 'mobile' platform from spending union all select distinct spend_date, 'both' platform from spending) c left join (select user_id , spend_date , case when count(*)=1 then platform else 'both' end platform , sum(amount) amount from spending group by user_id, spend_date ) v on c.spend_date=v.spend_date and c.platform=v.platform group by spend_date, platform
select c.spend_date, c.platform, sum(IFNULL(amount,0)) total_amount, sum(case when amount is null then 0 else 1 end) total_users from (select distinct spend_date, 'desktop' platform from spending union all select distinct spend_date, 'mobile' platform from spending union all select distinct spend_date, 'both' platform from spending) c left join (select user_id, spend_date, case when count(*)=1 then platform else 'both' end platform, sum(amount) amount from spending group by user_id, spend_date) v on c.spend_date=v.spend_date and c.platform=v.platform group by spend_date, platform
select c.spend_date, c.platform, sum(coalesce(amount,0)) total_amount, sum(case when amount is null then 0 else 1 end) total_users from (select distinct spend_date, 'desktop' platform from spending union all select distinct spend_date, 'mobile' platform from spending union all select distinct spend_date, 'both' platform from spending) c left join (select user_id, spend_date, case when count(*)=1 then platform else 'both' end platform, sum(amount) amount from spending group by user_id, spend_date) v on c.spend_date=v.spend_date and c.platform=v.platform group by spend_date, platform
select distinct t1.spend_date, t1.platform, ifnull(total_amount,0) total_amount, ifnull(total_users,0) total_users from (select spend_date, 'desktop' platform from spending union select spend_date, 'mobile' platform from spending union select spend_date, 'both' platform from spending) t1 left join (select spend_date, case when cnt = 2 then 'both' else platform end platform, count(distinct user_id) total_users, sum(amount) total_amount from (select user_id, spend_date, platform, sum(amount) amount, count(platform) cnt from spending group by user_id, spend_date) t group by 1, 2) t2 on t1.spend_date=t2.spend_date and t1.platform=t2.platform
select h.spend_date, h.platform, ifnull(sum(amount),0) total_amount, count(user_id) as total_users from ( select distinct(spend_date), 'desktop' platform from Spending union all select distinct(spend_date), 'mobile' platform from Spending union all select distinct(spend_date), 'both' platform from Spending ) h left join ( select spend_date, user_id, case when count(*) = 1 then platform else 'both' end as platform, sum(amount) as amount from Spending s group by spend_date, user_id ) a on h.spend_date = a.spend_date and h.platform = a.platform group by h.spend_date, h.platform
select spend_date,platform,ifnull(sum(sa),0) as total_amount ,count(user_id) as total_users from (select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'desktop' as platform from Spending union select distinct spend_date,'both' as platform from Spending) a left join (select spend_date,user_id,(case when count(platform)=1 then platform else 'both' end)as platform,sum(amount) as sa from Spending group by spend_date,user_id)b using(spend_date,platform) group by spend_date,platform
select spend_date,platform,ifnull(sum(sa),0) as total_amount ,count(user_id) as total_users from (select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'desktop' as platform from Spending union select distinct spend_date,'both' as platform from Spending)a left join (select spend_date,user_id,(case when count(platform)!=2 then platform else 'both' end)as platform,sum(amount) as sa from Spending group by spend_date,user_id)b using(spend_date,platform) group by spend_date,platform
select sub.spend_date, 'desktop' as platform, sum(case when sub.pboth =0 and sub.platform = 'desktop' then sub.amounts else 0 end) total_amount, sum(case when sub.platform = 'desktop' and sub.pboth =0 then 1 else 0 end) total_users from (select S1.user_id, S1.spend_date, S1.platform, S2.platform plat, case when S2.platform is null then 0 else 1 end pboth, case when S2.platform is not null then S1.amount + S2.amount else S1.amount end amounts from Spending S1 left join Spending S2 on S1.user_id = S2.user_id and S1.spend_date = S2.spend_date and S1.platform != S2.platform where (S2.platform is null) or (S1.platform = 'mobile' and S2.platform = 'desktop'))sub group by spend_date union all select sub.spend_date,'mobile' as platform, sum(case when sub.pboth =0 and sub.platform = 'mobile' then sub.amounts else 0 end) total_amount, sum(case when sub.platform = 'mobile' and sub.pboth =0 then 1 else 0 end) total_users from (select S1.user_id, S1.spend_date, S1.platform, S2.platform plat, case when S2.platform is null then 0 else 1 end pboth, case when S2.platform is not null then S1.amount + S2.amount else S1.amount end amounts from Spending S1 left join Spending S2 on S1.user_id = S2.user_id and S1.spend_date = S2.spend_date and S1.platform != S2.platform where (S2.platform is null) or (S1.platform = 'mobile' and S2.platform = 'desktop'))sub group by spend_date union all select sub.spend_date, 'both' as platform, sum(case when sub.pboth >0 then sub.amounts else 0 end) total_amount, sum(sub.pboth) total_users from (select S1.user_id, S1.spend_date, S1.platform, S2.platform plat, case when S2.platform is null then 0 else 1 end pboth, case when S2.platform is not null then S1.amount + S2.amount else S1.amount end amounts from Spending S1 left join Spending S2 on S1.user_id = S2.user_id and S1.spend_date = S2.spend_date and S1.platform != S2.platform where (S2.platform is null) or (S1.platform = 'mobile' and S2.platform = 'desktop'))sub group by spend_date
select t.spend_date, t.platform, ifnull(sum(t2.amount),0) as total_amount, count(t2.user_id) as total_users from (select distinct spend_date, 'desktop' as platform from Spending union select distinct spend_date, 'mobile' as platform from Spending union select distinct spend_date, 'both' as platform from Spending) as t left join (select spend_date, user_id, if(mobile_amount > 0, if(desktop_amount>0, 'both', 'mobile') ,'desktop') as platform, mobile_amount + desktop_amount as amount from (select user_id, spend_date, sum(case when platform = 'mobile' then amount else 0 end) as mobile_amount, sum(case when platform = 'desktop' then amount else 0 end) as desktop_amount from Spending group by spend_date, user_id) as t1) as t2 on t.spend_date=t2.spend_date and t.platform=t2.platform group by t.spend_date, t.platform
select t1.spend_date, t1.platform, sum(coalesce(t2.total_amount,0)) as total_amount, sum(coalesce(t2.total_users,0)) as total_users from ( SELECT DISTINCT(spend_date), 'desktop' as platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' as platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' as platform FROM Spending order by spend_date ) t1 left join ( select spend_date, case when count(platform)=1 then platform else 'both' end as platform, sum(amount) as total_amount, count(distinct user_id) as total_users from spending group by spend_date, user_id ) t2 on t1.spend_date=t2.spend_date and t1.platform=t2.platform group by spend_date, platform
select temp.spend_date,temp.platform, case when result.total_amount is null then 0 else total_amount end as 'total_amount', case when result.total_users is null then 0 else total_users end as 'total_users' from ( select distinct spend_date, 'mobile' as platform from spending union all select distinct spend_date, 'desktop' as platform from spending union all select distinct spend_date, 'both' as platform from spending) as temp left join ( select spend_date, case when num = 1 then platform when num = 2 then 'both' end as 'platform', sum(amount) as 'total_amount', count(distinct user_id) as 'total_users' from ( select *, count(platform) over(partition by user_id, spend_date) as 'num' from spending) as A group by spend_date, case when num = 1 then platform when num = 2 then 'both' end ) as result on temp.spend_date = result.spend_date and temp.platform = result.platform
select tmp1.spend_date, tmp1.platform, ifnull(sum(tmp3.amount), 0) total_amount, count(tmp3.user_id) total_users from (select distinct spend_date, 'mobile' platform from Spending union all select distinct spend_date, 'desktop' platform from Spending union all select distinct spend_date, 'both' platform from Spending) tmp1 left join (select user_id, spend_date, if (mobile_amount > 0, if(desktop_amount > 0, 'both', 'mobile'), 'desktop') platform, (mobile_amount + desktop_amount) amount from (select user_id, spend_date, sum(if(platform = 'mobile', amount, 0)) mobile_amount, sum(if(platform = 'desktop', amount, 0)) desktop_amount from Spending group by user_id, spend_date) tmp2 ) tmp3 on tmp1.spend_date = tmp3.spend_date and tmp1.platform = tmp3.platform group by spend_date, platform
with Spend_platforms as ( select user_id, spend_date, ( case when count(if(platform = 'mobile', 1, null)) = 0 then 1 else 0 end ) as 'desktop', ( case when count(if(platform = 'desktop', 1, null)) = 0 then 1 else 0 end ) as 'mobile', ( case when count(if(platform = 'mobile', 1, null)) = 0 or count(if(platform = 'desktop', 1, null)) = 0 then 0 else 1 end ) as 'boths', sum(amount) as 'amount' from Spending group by 1, 2 ) select spend_date, 'desktop' as 'platform', sum(if(desktop = 1, amount, 0)) as 'total_amount', count(if(desktop = 1, 1, null)) as 'total_users' from Spend_platforms group by 1 union all select spend_date, 'mobile' as 'platform', sum(if(mobile = 1, amount, 0)) as 'total_amount', count(if(mobile = 1, 1, null)) as 'total_users' from Spend_platforms group by 1 union all select spend_date, 'both' as 'platform', sum(if(boths = 1, amount, 0)) as 'total_amount', count(if(boths = 1, 1, null)) as 'total_users' from Spend_platforms group by 1
with a as( select user_id,spend_date, (if(count(platform)=2,'both',platform)) platform, sum(amount) amount, 1 isboth from spending group by user_id,spend_date), aa as( select * from a union all select user_id, spend_date, 'desktop' platform, 0 amount, 0 isboth from a union all select user_id, spend_date, 'mobile' platform, 0 amount, 0 isboth from a union all select user_id, spend_date, 'both' platform, 0 amount, 0 isboth from a) select spend_date, platform, sum(amount) as total_amount, sum(isboth) as total_users from aa group by spend_date,platform order by FIELD(platform,'desktop','mobile','both'),spend_date
with all_date as ( select spend_date from spending), all_platform as ( select 'desktop' as platform union select 'mobile' union select 'both'), cte1 as ( select spend_date, platform from all_date d join all_platform p), cte2 as ( select user_id, spend_date, group_concat(platform) as platform from spending group by 1,2), cte3 as ( select c.spend_date, (case when c.platform='desktop' then 'desktop' when c.platform='mobile' then 'mobile' else 'both' end) as platform, sum(s.amount) as total_amount, count(distinct s.user_id) as total_users from cte2 c join spending s on c.user_id=s.user_id and c.spend_date=s.spend_date group by 1,2) select c1.spend_date, c1.platform, ifnull(c3.total_amount,0) as total_amount, ifnull(c3.total_users,0) as total_users from cte1 c1 left join cte3 c3 on c1.spend_date=c3.spend_date and c1.platform=c3.platform group by 1,2,3,4
with both_platforms as ( select user_id, spend_date, case when count(distinct platform) = 2 then "both" else platform end "platform", sum(amount) "total_amount" from spending group by 1, 2 ), base_table as ( select distinct spend_date, "mobile" as "platform" from spending union select distinct spend_date, "desktop" as "platform" from spending union select distinct spend_date, "both" as "platform" from spending ) select ba.spend_date, ba.platform, ifnull(sum(bo.total_amount), 0) "total_amount", ifnull(count(distinct bo.user_id), 0) "total_users" from base_table ba left join both_platforms bo on ba.platform = bo.platform and ba.spend_date = bo.spend_date group by 1, 2 order by 1
with c as (select distinct s.spend_date,p.platform from Spending s, (select 'desktop' as platform union all select 'mobile' union all select 'both') p) select c.spend_date, c.platform, ifnull(t2.total_amount,0) as total_amount, ifnull(t2.total_users,0) as total_users from c left join (select spend_date, platform, sum(amount) as total_amount,count(distinct user_id) as total_users from (select s.user_id, s.amount, s.spend_date, case when t.cnt=2 then 'both'else s.platform end as platform from Spending s join (select user_id, spend_date,count(distinct platform) as cnt from Spending group by 1,2) t on s.user_id=t.user_id and s.spend_date=t.spend_date) t1 group by 1,2) t2 on c.spend_date=t2.spend_date and c.platform=t2.platform
with c as( select distinct spend_date, 'desktop' as platform from Spending union select distinct spend_date, 'mobile' as platform from Spending union select distinct spend_date, 'both' as platform from Spending) ,t as( select spend_date, user_id, case when count(*) >1 then 'both' else max(platform) end as platform, sum(amount) as amount from Spending group by spend_date, user_id ) select c.spend_date, c.platform, ifnull(sum(amount),0) as total_amount, ifnull(count(distinct user_id),0) as total_users from c left join t on c.spend_date = t.spend_date and c.platform = t.platform group by c.spend_date, c.platform
with cnt as ( select spend_date, user_id, sum(case when platform='mobile' then amount else 0 end) mobile_amount, sum(case when platform='desktop' then amount else 0 end) desktop_amount from Spending s group by spend_date, user_id ) , header as ( select distinct(spend_date), 'desktop' platform from Spending union all select distinct(spend_date), 'mobile' platform from Spending union all select distinct(spend_date), 'both' platform from Spending ) select h.spend_date, h.platform, ifnull(sum(amount),0) total_amount, count(user_id) as total_users from header h left join ( select spend_date, user_id, if(mobile_amount >0, if(desktop_amount>0, 'both', 'mobile'), 'desktop') as platform, (mobile_amount + desktop_amount) as amount from cnt ) a on h.spend_date = a.spend_date and h.platform = a.platform group by h.spend_date, h.platform
with cnt as ( select spend_date, user_id, sum(case when platform='mobile' then amount else 0 end) mobile_amount, sum(case when platform='desktop' then amount else 0 end) desktop_amount from Spending s group by spend_date, user_id ) , header as ( select distinct(spend_date), 'desktop' platform from Spending union select distinct(spend_date), 'mobile' platform from Spending union select distinct(spend_date), 'both' platform from Spending ) select h.spend_date, h.platform, ifnull(sum(amount),0) total_amount, count(user_id) as total_users from header h left join ( select spend_date, user_id, if(mobile_amount >0, if(desktop_amount>0, 'both', 'mobile'), 'desktop') as platform, (mobile_amount + desktop_amount) as amount from cnt ) a on h.spend_date = a.spend_date and h.platform = a.platform group by h.spend_date, h.platform
with cte as ( (select user_id, spend_date, platform, sum(amount) as amount from Spending group by 1, 2 having count(distinct platform) = 1) UNION ALL (select user_id, spend_date, "both" as platform , sum(amount) as amount from Spending group by user_id, spend_date having count(distinct platform) = 2) ), cte1 as ( select distinct spend_date, "desktop" as platform from Spending UNION (select distinct spend_date, "mobile" as platform from Spending) UNION (select distinct spend_date, "both" as platform from Spending) ) select cte1.spend_date, cte1.platform, ifnull(sum(cte.amount),0) as total_amount, count(distinct cte.user_id) as total_users from cte1 left join cte on cte1.spend_date = cte.spend_date and cte1.platform = cte.platform group by cte1.spend_date, cte1.platform
with cte as ( SELECT spend_date,user_id,max(platform) platform, count(distinct platform) cnt ,sum(amount) amount from Spending group by spend_date,user_id order by 1,2 ) select d.spend_date,p.platform,ifnull(sum(cte2.amount),0) total_amount ,ifnull(count(distinct cte2.user_id),0) total_users from (select distinct spend_date from Spending) d cross join (select 'desktop' platform union all select 'mobile' union all select 'both') p on 1=1 left join (select spend_date,user_id,amount,case when cnt > 1 then 'both' else platform end as platform from cte) cte2 on d.spend_date = cte2.spend_date and cte2.platform = p.platform group by d.spend_date,p.platform order by 1
with cte as ( SELECT spend_date,user_id,max(platform) platform, count(distinct platform) cnt ,sum(amount) amount from Spending group by spend_date,user_id order by 1,2 ) select p.spend_date,p.platform,ifnull(sum(cte2.amount),0) total_amount ,ifnull(count(distinct cte2.user_id),0) total_users from ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) p left join (select spend_date,user_id,amount,case when cnt > 1 then 'both' else platform end as platform from cte) cte2 on p.spend_date = cte2.spend_date and cte2.platform = p.platform group by p.spend_date,p.platform order by 1
with cte as ( SELECT spend_date,user_id,max(platform) platform, count(distinct platform) cnt ,sum(amount) amount from Spending group by spend_date,user_id order by 1,2 ), d as ( select * from (select distinct spend_date from Spending) a, (select 'desktop' platform union all select 'mobile' union all select 'both') p) select d.spend_date,d.platform,ifnull(sum(cte2.amount),0) total_amount ,ifnull(count(distinct cte2.user_id),0) total_users from d left join (select spend_date,user_id,amount,case when cnt > 1 then 'both' else platform end as platform from cte) cte2 on d.spend_date = cte2.spend_date and cte2.platform = d.platform group by d.spend_date,d.platform order by 1
with cte as ( Select distinct spend_date, 'desktop' platform from spending union all Select distinct spend_date, 'mobile' platform from spending union all Select distinct spend_date, 'both' platform from spending ), cte1 as ( Select user_id, spend_Date, case when count(distinct platform) = 1 then min(platform) else 'both' end platform, sum(amount) amount from spending group by 1,2 ) Select distinct c.spend_date, c.platform, coalesce(sum(amount),0) total_amount, sum(case when amount is null then 0 else 1 end) total_users from cte c left join cte1 c1 on c.spend_date = c1.spend_Date and c.platform = c1.platform group by 1,2 order by 1
with cte as ( select * from ( select 'desktop' as platform union all select 'mobile' as platform union all select 'both' as platform )t cross join ( select distinct spend_date from Spending )t1 ), cte1 as ( select user_id, spend_date, case when desktop > 0 and mobile = 0 then 'desktop' when desktop = 0 and mobile > 0 then 'mobile' else 'both' end as platform, desktop + mobile as amount from ( select user_id, spend_date, sum(desktop) as desktop, sum(mobile) as mobile from ( select user_id, spend_date, if(platform = 'desktop', amount, 0) as desktop, if(platform = 'mobile', amount, 0) as mobile from Spending )t2 group by user_id, spend_date )t3 ) select cte.spend_date, cte.platform, coalesce(sum(cte1.amount), 0) as total_amount, coalesce(count(cte1.user_id), 0) as total_users from cte left join cte1 on cte.spend_date = cte1.spend_date and cte.platform = cte1.platform group by cte.spend_date, cte.platform
with cte as ( select distinct spend_date as spend_date ,f.platform as platform from Spending cross join (select distinct platform from Spending )f union select distinct spend_date, "both" from Spending), cte2 as ( select user_id, spend_date ,case when count(*) =2 then "both" else platform end as medium_, sum(amount) as total from Spending group by user_id , spend_date ) select c.spend_date, c.platform,coalesce(total_amount,0) as total_amount, coalesce(total_users,0) as total_users from ( select spend_date,medium_ as platform, sum(total) as total_amount , count(distinct user_id) as total_users from cte2 group by spend_date,medium_)g right join cte c on g.spend_date = c.spend_date and g.platform =c.platform
with cte as ( select s1.user_id, s1.spend_date, s1.amount, case when s2.platform is not null then 'both' else s1.platform end as platform from spending s1 left join spending s2 on s1.user_id = s2.user_id and s1.spend_date = s2.spend_date and s1.platform != s2.platform ) , cte2 as ( select distinct spend_date, 'mobile' as platform from spending union all select distinct spend_date, 'desktop' as platform from spending union all select distinct spend_date, 'both' as platform from spending ) select cte2.spend_date, cte2.platform, ifnull(sum(amount),0) as total_amount, ifnull(count(distinct user_id),0) as total_users from cte2 left join cte on cte2.spend_date = cte.spend_date and cte2.platform = cte.platform group by 1, 2 order by cte2.platform
with cte as ( select spend_date , user_id , count(distinct platform) as num_of_platform from Spending group by 1,2 ), cte2 as ( select c.spend_date , c.user_id , case when num_of_platform=1 then s.platform else 'both' end as platform , sum(amount) as total_amount from cte c inner join Spending s on c.user_id=s.user_id and c.spend_date=s.spend_date group by 1,2,3 ), date_platform as ( select distinct spend_date, 'mobile' as platform from cte union all select distinct spend_date,'desktop' as platform from cte union all select distinct spend_date,'both' as platform from cte ) select p.spend_date , p.platform , coalesce(sum(c2.total_amount),0) as total_amount , coalesce(count(distinct c2.user_id),0) as total_users from date_platform p left join cte2 c2 on p.spend_date=c2.spend_date and p.platform=c2.platform group by 1,2 order by 1,2
with cte as ( select spend_date, (case when plat_cnt = 1 and platform = 'mobile' then amount else 0 end) as mobile_amount, (case when plat_cnt = 1 and platform = 'desktop' then amount else 0 end) as desktop_amount, (case when plat_cnt >1 then amount else 0 end) as both_amount, (case when plat_cnt = 1 and platform = 'mobile' then user_id else null end) as mobile_user, (case when plat_cnt = 1 and platform = 'desktop' then user_id else null end) as desktop_user, (case when plat_cnt >1 then user_id else null end) as both_user from ( select user_id, spend_date, platform, amount, count(platform) over(partition by spend_date, user_id) as plat_cnt from spending) as t) select spend_date, 'desktop' as platform, sum(desktop_amount) as total_amount, count(distinct desktop_user) as total_users from cte group by spend_date union all select spend_date, 'mobile' as platform, sum(mobile_amount), count(distinct mobile_user) from cte group by spend_date union all select spend_date, 'both' as platform, sum(both_amount), count(distinct both_user) from cte group by spend_date
with cte as ( select spend_date, user_id , if(mobile_amt > 0, if(desktop_amt > 0, 'both', 'mobile'), 'desktop') as platform , mobile_amt + desktop_amt as amount from ( select spend_date, user_id , sum(case platform when 'mobile' then amount else 0 end) as mobile_amt , sum(case platform when 'desktop' then amount else 0 end) as desktop_amt from spending group by 1,2 ) tmp ) , cart_prod as ( select distinct spend_date, 'desktop' as platform from spending union select distinct spend_date, 'mobile' as platform from spending union select distinct spend_date, 'both' as platform from spending ) select cart_prod.spend_date, cart_prod.platform , sum(ifnull(amount, 0)) as total_amount , count(user_id) as total_users from cart_prod left join cte on cte.spend_date=cart_prod.spend_date and cte.platform=cart_prod.platform group by 1,2
with cte as ( select spending.user_id, spending.spend_Date, amount, cnt, platform from spending left join( select user_id, spend_date, count(distinct platform) as cnt from spending group by user_id, spend_Date) as t on spending.user_id = t.user_id and spending.spend_date = t.spend_date) select spend_date, 'desktop' as platform, sum(case when platform ='desktop' and cnt= 1 then amount else 0 end) as total_amount, count(distinct case when platform ='desktop' and cnt= 1 then user_id else null end) as total_users from cte group by spend_date union select spend_date, 'mobile' as platform, sum(case when platform ='mobile' and cnt= 1 then amount else 0 end) as total_amount, count(distinct case when platform ='mobile' and cnt= 1 then user_id else null end) as total_users from cte group by spend_date union select spend_date, 'both' as platform, sum(case when cnt= 2 then amount else 0 end) as total_amount,count(distinct case when cnt= 2 then user_id else null end) as total_users from cte group by spend_date
with cte as ( select user_id, spend_date, case when platform != 'mobile' and platform != 'desktop' then 'both' else platform end platform, amount from ( select user_id, spend_date, group_concat(platform) platform, sum(amount) amount from spending group by 1, 2) f ), cte1 as ( select distinct(spend_date), 'mobile' as platform from spending union select distinct(spend_date), 'desktop' as platform from spending union select distinct(spend_date), 'both' as platform from spending ), cte2 as ( select spend_date, platform, sum(amount) amount, count(distinct user_id) total_users from cte group by 1, 2 ) select cte1.spend_date, cte1.platform, ifnull(cte2.amount, 0) total_amount, ifnull(cte2.total_users, 0) total_users from cte1 left join cte2 on cte1.spend_date = cte2.spend_date and cte1.platform = cte2.platform
with cte as ( select user_id, spend_date, if(count(*)=1, platform, 'both') platform, sum(amount) total_amount from spending group by user_id, spend_date ), date_plat as ( select distinct spend_date, 'mobile' platform from spending union all select distinct spend_date, 'desktop' platform from spending union all select distinct spend_date, 'both' platform from spending ) select d.spend_date, d.platform, sum(coalesce(total_amount,0)) as total_amount, sum(case when total_amount is null then 0 else 1 end) total_users from date_plat d left join cte c on d.spend_date = c.spend_date and d.platform = c.platform group by 1, 2
with cte as ( select user_id, spend_date, sum( distinct case when platform = 'desktop' then 1 else 2 end ) as type, sum(amount) as amount from Spending group by spend_date, user_id ) select sub1.spend_date, sub1.platform, coalesce(sub2.total_amount, 0) as total_amount, coalesce(sub2.total_users, 0) as total_users from ( select distinct cte.spend_date, p.platform from cte cross join ( select 'desktop' as platform union select 'mobile' union select 'both' ) as p ) as sub1 left join ( select spend_date, case when type = 1 then 'desktop' when type = 2 then 'mobile' else 'both' end as platform, sum(amount) as total_amount, count(user_id) as total_users from cte group by spend_date, type ) as sub2 on sub1.spend_date = sub2.spend_date and sub1.platform = sub2.platform
with cte as ( select user_id, spend_date, sum( distinct case when platform = 'desktop' then 1 else 2 end ) as type, sum(amount) as amount from Spending group by spend_date, user_id ) select sub1.spend_date, sub1.platform, coalesce(sub2.total_amount, 0) as total_amount, coalesce(sub2.total_users, 0) as total_users from ( select distinct spend_date, 'desktop' as platform from spending union select distinct spend_date, 'mobile'as platform from spending union select distinct spend_date, 'both' as platform from spending ) as sub1 left join ( select spend_date, case when type = 1 then 'desktop' when type = 2 then 'mobile' else 'both' end as platform, sum(amount) as total_amount, count(user_id) as total_users from cte group by spend_date, type ) as sub2 on sub1.spend_date = sub2.spend_date and sub1.platform = sub2.platform
with cte as (SELECT s.*, CASE WHEN cnt = 2 THEN 'both' ELSE s.platform END as new_platform FROM ( SELECT s.*, COUNT( platform) over(PARTITION BY user_id, spend_date ) as cnt FROM Spending s) s), cte2 as (select distinct spend_date, 'mobile' as platform from Spending UNION ALL select distinct spend_date, 'desktop' as platform from Spending UNION ALL select distinct spend_date, 'both' as platform from Spending) SELECT cte2.spend_date, cte2.platform, IFNULL(sum(amount), 0) as total_amount, count(distinct user_id) as total_users from cte2 LEFT JOIN cte ON cte2.spend_date = cte.spend_date AND cte2.platform = new_platform GROUP BY cte2.spend_date, cte2.platform
with cte as (Select user_id,spend_date,sum(case when platform='mobile' then amount else 0 end) as mobile_amount,sum(case when platform='desktop' then amount else 0 end ) as desktop_amount from Spending group by user_id,spend_date), dte as (select user_id,spend_date,case when ((mobile_amount<>0) and (desktop_amount<>0)) then 'both' when mobile_amount>0 then 'mobile' else 'desktop' end as Platform,(mobile_amount+desktop_amount) as amount from cte), ete as (Select spend_date,platform,sum(amount) as total_amount,count(distinct user_id) as total_users from dte group by 1,2), fte as (Select distinct spend_date,'desktop' as platform from Spending union Select distinct spend_date,'mobile' as platform from Spending union Select distinct spend_date,'both' as platform from Spending) Select fte.spend_date,fte.platform,ifnull(total_amount,0) as total_amount,ifnull(total_users,0) as total_users from fte left join ete on fte.spend_date=ete.spend_date and fte.platform=ete.platform
with cte as (select distinct spend_Date,'both' as platform from Spending union select distinct spend_Date,'desktop' as platform from Spending union select distinct spend_Date,'mobile' as platform from Spending) select c.spend_date,c.platform, sum(case when a.platform is null then 0 else amount end) as total_amount, sum(case when a.platform is null then 0 else 1 end) as total_users from cte c left outer join ( select user_id,spend_Date,sum(amount) as amount, count(distinct platform) as cnt, case when count(distinct platform)=2 then 'both' else platform end as platform from Spending s group by user_id,spend_date)a on c.spend_date=a.spend_date and c.platform=a.platform group by c.spend_date,c.platform
with cte as (select distinct spend_date, 'both' as platform from spending union select distinct spend_date, 'desktop' as platform from spending union select distinct spend_date, 'mobile' as platform from spending ) select a.spend_date, a.platform, sum(case when b.platform is null then 0 else b.tot end) as total_amount, sum(case when b.platform is null then 0 else 1 end) as total_users from cte a left join ( select user_id,spend_date, count(distinct platform) as cnt, (case when count(distinct platform) = 2 then 'both' else platform end) as platform, sum(amount) as tot from Spending group by user_id, spend_date) as b on a.spend_date = b.spend_date and a.platform = b.platform group by a.spend_date, a.platform
with cte as (select distinct spend_date,'both' as platform from spending union all select distinct spend_date,'mobile' as platform from spending union all select distinct spend_date,'desktop' as platform from spending) select c.spend_date,c.platform,sum(case when a.platform is null then 0 else amount end) as total_amount,sum(case when a.platform is null then 0 else 1 end) as total_users from cte c left outer join (select user_id,spend_date,sum(amount) as amount,count(distinct platform) as cnt,case when count(distinct platform )=2 then 'both' else platform end as platform from spending group by 1,2)a on a.spend_date=c.spend_date and a.platform=c.platform group by 1,2
with cte as (select distinct spend_date,'both' as platform from spending union select distinct spend_date,'mobile' as platform from spending union select distinct spend_date,'desktop' as platform from spending) select c.spend_date,c.platform,sum(case when a.platform is null then 0 else amount end)as total_amount,sum(case when a.platform is null then 0 else 1 end) as total_users from cte c left outer join (select user_id,spend_date,sum(amount) as amount,count(distinct platform)as cnt,case when count(distinct platform)=2 then 'both' else platform end as platform from spending group by 1,2)as a on a.spend_date=c.spend_date and a.platform=c.platform group by 1,2
with cte as (select s1.user_id, s1.spend_date, s1.amount, case when s2.platform is NULL then s1.platform else 'both' end as platform from spending s1 left join spending s2 on s1.user_id=s2.user_id and s1.spend_date=s2.spend_date and s1.platform <> s2.platform), cte2 as ( select distinct spend_date, 'mobile' as platform from spending union select distinct spend_date, 'desktop' as platform from spending union select distinct spend_date, 'both' as platform from spending ) select cte2.spend_date, cte2.platform, sum(ifnull(amount,0)) as total_amount, count(distinct user_id) as total_users from cte2 left join cte on cte2.spend_date = cte.spend_date and cte2.platform = cte.platform group by cte2.spend_date, cte2.platform
with cte as (select spend_date, user_id, case when count(distinct platform) = 2 then 'both' else platform end as platform, case when count(distinct platform) = 2 then sum(amount) else amount end as amount from spending group by spend_date,user_id), bo as (SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending) select spend_date, platform, ifnull(sum(amount),0) as total_amount, count(distinct user_id) as total_users from bo left join cte using(spend_date,platform) group by spend_date,platform
with cte as (select spend_date, user_id, sum(case when platform='mobile' then amount end) as Mobile, sum(case when platform='desktop' then amount end) as Desktop from Spending group by spend_date, user_id) ,cte2 as ((select distinct spend_date, 'mobile' as platform from spending) union (select distinct spend_date, 'desktop' as platform from spending) union (select distinct spend_date, 'both' as platform from spending)) select C1.spend_date,C1.platform,coalesce(total_amount,0) as total_amount,coalesce(total_users,0) total_users from cte2 C1 left join (select spend_date, (case when Mobile is null then 'desktop' when Desktop is null then 'mobile' else 'both' end) as platform, sum(coalesce(Mobile,0)+coalesce(Desktop,0)) as total_amount , count(distinct user_id) as total_users from cte C group by spend_date, platform) t1 on C1.spend_date=t1.spend_date and C1.platform=t1.platform
with cte as (select user_id, spend_date, sum(amount) as amount, case when sum(platform = "desktop") = 0 then 1 else 0 end as mobile, case when sum(platform = "mobile") = 0 then 1 else 0 end as desktop, case when sum(platform = "desktop") = 0 or sum(platform = "mobile") = 0 then 0 else 1 end as `both` from Spending group by 1, 2 ) select spend_date, "mobile" as platform, sum(amount * mobile) as total_amount, sum(mobile) as total_users from cte group by 1 union all select spend_date, "desktop" as platform, sum(amount * desktop) as total_amount, sum(desktop) as total_users from cte group by 1 union all select spend_date, "both" as platform, sum(amount * `both`) as total_amount, sum(`both`) as total_users from cte group by 1
with cte as (select user_id, spend_date, sum(case when platform='mobile' then amount else 0 end) as ma, sum(case when platform='desktop' then amount else 0 end) as da from spending group by user_id, spend_date) select spend_date, 'desktop' as platform, sum(case when cte.da>0 and cte.ma=0 then da else 0 end) as total_amount, sum(case when cte.da>0 and cte.ma=0 then 1 else 0 end) as total_users from cte group by spend_date union all select spend_date, 'mobile' as platform, sum(case when cte.da=0 and cte.ma>0 then ma else 0 end) as total_amount, sum(case when cte.da=0 and cte.ma>0 then 1 else 0 end) as total_users from cte group by spend_date union all select spend_date, 'both' as platform, sum(case when cte.da>0 and cte.ma>0 then da+ma else 0 end) as total_amount, sum(case when cte.da>0 and cte.ma>0 then 1 else 0 end) as total_users from cte group by spend_date
with cte as( select distinct spend_date, 'mobile' as platform from Spending union all select distinct spend_date, 'desktop' as platform from Spending union all select distinct spend_date, 'both' as platform from Spending ), cte2 as( select a.spend_date, case when b.platform is not null then 'both' else a.platform end platform, sum(a.amount) as total_amount, count(distinct a.user_id) as total_users from Spending a left join Spending b on a.user_id = b.user_id and a.spend_date = b.spend_date and a.platform != b.platform group by a.spend_date, platform ) select cte.spend_date, cte.platform, coalesce(cte2.total_amount,0) as total_amount, coalesce(cte2.total_users,0) as total_users from cte2 right join cte on cte2.spend_date = cte.spend_date and cte2.platform = cte.platform
with cte as( select distinct spend_date, 'mobile' as platform from Spending union select distinct spend_date, 'desktop' as platform from Spending union select distinct spend_date, 'both' as platform from Spending ), tmp as( select spend_date, user_id, sum(case when platform = 'mobile' then amount else 0 end) as mobile_amount, sum(case when platform = 'desktop' then amount else 0 end) as desktop_amount from Spending group by 1, 2 ), tmp2 as( select spend_date, user_id, if(mobile_amount > 0, if(desktop_amount > 0, 'both', 'mobile'), 'desktop') as platform, (mobile_amount + desktop_amount) as amount from tmp ) select cte.spend_date, cte.platform, ifnull(sum(amount),0) as total_amount, count(user_id) as total_users from cte left join tmp2 on cte.spend_date = tmp2.spend_date and cte.platform = tmp2.platform group by 1,2
with cte as( select distinct spend_date, user_id, count(platform) over (partition by user_id, spend_date) n_platform, platform, amount from Spending), cte2 as ( select spend_date, 'mobile' as platform from Spending union select spend_date, 'desktop' as platform from Spending union select spend_date, 'both' as platform from Spending), cte3 as( select spend_date, 'both' as platform, sum(amount) as total_amount, count(distinct user_id) as total_users from cte where n_platform=2 group by spend_date union all select spend_date, 'mobile' as platform, sum(amount) as total_amount, count(distinct user_id) as total_users from cte where n_platform=1 and platform='mobile' group by spend_date union all select spend_date, 'desktop' as platform, sum(amount) as total_amount, count(distinct user_id) as total_users from cte where n_platform=1 and platform='desktop' group by spend_date) select cte2.spend_date, cte2.platform, ifnull(total_amount,0) as total_amount, ifnull(total_users, 0) as total_users from cte2 left join cte3 on cte2.spend_date=cte3.spend_date and cte2.platform=cte3.platform
with cte as( select user_id, spend_date, sum(amount) as total_amount, case when count(distinct platform) = 2 then "both" else platform end platform_all from spending group by user_id, spend_date ), grps as( select s1.spend_date, s2.platform from (select distinct spend_date from cte order by 1) s1 cross join (select 'mobile' as platform union all select 'desktop' as platform union all select 'both' as platform ) s2 ), interm as( select spend_date, platform_all as platform, sum(total_amount) as total_amount, count(user_id) as total_users from cte c group by 1,2 ) select g.spend_date, g.platform, ifnull(total_amount, 0) as total_amount, ifnull(total_users,0) as total_users from grps g left join interm i on g.spend_date = i.spend_date and g.platform = i.platform
with cte as( select user_id,spend_date,sum(amount) as amount, case when sum(platform_n)=3 then 'both' else platform end as new_platform from (select user_id,spend_date,platform,amount, case when platform='mobile' then 2 else 1 end as platform_n from Spending) A group by user_id,spend_date ) select distinct A.spend_date,platform,ifnull(sum(B.amount),0) as total_amount,ifnull(count(distinct B.user_id),0) as total_users from ( select distinct(spend_date),'desktop' platform from Spending union all select distinct(spend_date),'mobile' platform from Spending union all select distinct(spend_date),'both' platform from Spending ) A left join cte B on A.spend_date=B.spend_date and A.platform=B.new_platform group by A.spend_date,A.platform
with cte1 as ( select spend_date, user_id from spending group by spend_date, user_id having count(*)=1 ), cte2 as ( select c.spend_date, 'desktop' platform, sum(amount) total_amount, count(c.user_id) total_users from cte1 c join spending s on c.spend_date=s.spend_date and c.user_id=s.user_id where platform='desktop' group by c.spend_date union all select c.spend_date, 'mobile' platform, sum(amount) total_amount, count(c.user_id) total_users from cte1 c join spending s on c.spend_date=s.spend_date and c.user_id=s.user_id where platform='mobile' group by c.spend_date union all select spend_date, 'both' plat, sum(sub) total_amount, count(user_id) total_users from (select spend_date, user_id, sum(amount) sub from spending group by spend_date, user_id having count(*) = 2) r1 group by spend_date ), cte3 as ( select distinct spend_date, 'desktop' platform from spending union all select distinct spend_date, 'mobile' platform from spending union all select distinct spend_date, 'both' platform from spending ) select c3.spend_date, c3.platform, ifnull(c2.total_amount, 0) total_amount, ifnull(c2.total_users, 0) total_users from cte3 c3 left join cte2 c2 on c3.spend_date=c2.spend_date and c3.platform=c2.platform
with cte1 as ( select spend_date, user_id, amount, 'mobile' as platform from Spending s where Exists (select spend_date, user_id, platform from Spending where platform = 'mobile' and s.user_id = user_id and s.spend_date = spend_date) and not Exists (select spend_date, user_id, platform from Spending where platform = 'desktop' and s.user_id = user_id and s.spend_date = spend_date) ), cte2 as ( select spend_date, user_id, amount, 'desktop' as platform from Spending s where not Exists (select spend_date, user_id, platform from Spending where platform = 'mobile' and s.user_id = user_id and s.spend_date = spend_date) and Exists (select spend_date, user_id, platform from Spending where platform = 'desktop' and s.user_id = user_id and s.spend_date = spend_date) ), cte3 as ( select spend_date, user_id, amount, 'both' as platform from Spending s where Exists (select spend_date, user_id, platform from Spending where platform = 'mobile' and s.user_id = user_id and s.spend_date = spend_date) and Exists (select spend_date, user_id, platform from Spending where platform = 'desktop' and s.user_id = user_id and s.spend_date = spend_date) ) select spend_date, platform, sum(amount) total_amount, count(distinct user_id) total_users from ( select * from cte1 UNION ALL select * from cte2 UNION ALL select * from cte3 UNION ALL select spend_date, null, 0, 'mobile' from Spending UNION ALL select spend_date, null, 0, 'desktop' from Spending UNION ALL select spend_date, null, 0, 'both' from Spending ) temp group by 1, 2 order by platform, spend_date
with cte1 as ( select user_id, spend_date from Spending group by spend_date, user_id having count(distinct platform) = 2), cte2 as( select user_id, spend_date, 'both' as 'platform', amount from Spending where (user_id, spend_date) in (select * from cte1) union all select * from Spending where (user_id, spend_date) not in (select * from cte1)), cte3 as ( select distinct spend_date from Spending), cte4 as ( select 'desktop' as 'platform' union all select 'mobile' as 'platform' union all select 'both' as 'platform') select spend_date, platform, coalesce(sum(amount),0) as 'total_amount', coalesce(count(distinct user_id),0) as 'total_users' from cte3 cross join cte4 left join cte2 using (spend_date, platform) group by spend_date, platform
with cte1 as( select user_id, spend_date, count(*) as cnt, platform, sum(amount) as amount from Spending group by 1,2), cte2 as( select user_id, spend_date, if(cnt=2,'both',platform) as platform, amount from cte1), cte as( select distinct spend_date, 'desktop' as platform from Spending union select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'both' as platform from Spending) select a.spend_date, a.platform, COALESCE(sum(amount),0) as total_amount, count(user_id) as total_users from cte a left join cte2 b on a.spend_date = b.spend_date and a.platform = b.platform group by 1,2
with cte1 as( select user_id, spend_date, count(*) as cnt, platform, sum(amount) as amount from Spending group by 1,2), cte2 as( select user_id, spend_date, if(cnt=2,'both',platform) as platform, amount from cte1), cte as( select distinct spend_date, 'desktop' as platform from Spending union select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'both' as platform from Spending) select a.spend_date, a.platform, ifnull(sum(amount),0) as total_amount, count(user_id) as total_users from cte a left join cte2 b on a.spend_date = b.spend_date and a.platform = b.platform group by 1,2
with date_platform as ( select distinct spend_date, 'mobile' as 'platform' from Spending union select distinct spend_date, 'desktop' as 'platform' from Spending union select distinct spend_date, 'both' as 'platform' from Spending ), spending_platform as ( select user_id, spend_date, sum(amount) as amount, case when count(platform) = 1 then platform else 'both' end as 'platform' from Spending group by user_id, spend_date ) select spend_date, date_platform.platform, sum(ifnull(amount, 0)) as 'total_amount', count(user_id) as 'total_users' from date_platform left join spending_platform using(spend_date, platform) group by spend_date, platform
with date_platform as ( select s.spend_date, p.platform from ( select distinct spend_date from Spending ) s, ( select distinct platform from Spending union select 'both' as platform ) p ), tmp1 as ( select distinct t1.user_id, t1.spend_date, case when t1.n_platform = 1 then s.platform else 'both' end as platform, t1.total_a from ( select user_id, spend_date, count(distinct platform) as n_platform, sum(amount) as total_a from Spending group by user_id, spend_date ) t1 left join Spending s on s.user_id = t1.user_id and s.spend_date = t1.spend_date ), tmp2 as ( select spend_date, platform, count(user_id) as total_users, sum(total_a) as total_amount from tmp1 group by spend_date, platform ) select dp.spend_date, dp.platform, coalesce(tmp2.total_amount, 0) as total_amount, coalesce(tmp2.total_users, 0) as total_users from date_platform dp left join tmp2 on tmp2.spend_date = dp.spend_date and tmp2.platform = dp.platform
with dates as ( select distinct spend_date from spending ), platforms as ( select 'mobile' as platform union select 'desktop' as platform union select 'both' as platform ), date_platform as ( select spend_date, platform from dates join platforms on 1=1 ), user_daily as ( SELECT spend_date , user_id , sum(case when platform = 'mobile' then amount else 0 end) as mobile_spend , sum(case when platform = 'desktop' then amount else 0 end) as desktop_spend FROM spending group by 1,2 ), daily_data as ( select spend_date , user_id , mobile_spend + desktop_spend amount , case when mobile_spend > 0 and desktop_spend > 0 then 'both' when mobile_spend > 0 and desktop_spend = 0 then 'mobile' when mobile_spend = 0 and desktop_spend > 0 then 'desktop' end as platform from user_daily ) select dp.spend_date , dp.platform , sum(coalesce(amount,0)) total_amount , count(distinct user_id) total_users from date_platform dp left join daily_data dd on dp.spend_date = dd.spend_date and dp.platform = dd.platform group by 1,2 order by 1
with dates as ( select distinct spend_date, 'desktop' as platform from spending union all select distinct spend_date, 'mobile' as platform from spending union all select distinct spend_date, 'both' as platform from spending ), users as ( select user_id, spend_date, min(platform) as platform, sum(amount) as total_amount from spending group by user_id, spend_date having count(distinct platform) = 1 union all select user_id, spend_date, 'both' as platform, sum(amount) as total_amount from spending group by user_id, spend_date having count(distinct platform) = 2 ) select a.spend_date, a.platform, coalesce(sum(b.total_amount), 0) as total_amount, count(distinct b.user_id) as total_users from dates a left outer join users b on a.spend_date = b.spend_date and a.platform = b.platform group by a.spend_date, a.platform order by spend_date
with dates as ( select spend_date, "mobile" as platform from spending union select spend_date, "desktop" as platform from spending union select spend_date, "both" as platform from spending ) select dates.spend_date, dates.platform, ifnull(sum(amount),0) as total_amount, count(user_id) as total_users from dates left join ( select user_id, spend_date, if(mobile > 0, if(desktop > 0, "both", "mobile"), "desktop") as platform, (mobile + desktop) amount from ( select user_id, spend_date, sum(case when platform = "mobile" then amount else 0 end) as mobile, sum(case when platform = "desktop" then amount else 0 end) as desktop from Spending group by spend_date, user_id ) as a ) as b on dates.spend_date = b.spend_date and dates.platform = b.platform group by spend_date, platform
with dates_platform as (select distinct spend_date, 'desktop' as platform from Spending union all select distinct spend_date, 'mobile' as platform from Spending union all select distinct spend_date, 'both' as platform from Spending ), spending_count as ( select user_id, spend_date, if(cnt=2, 'both',platform) as platform, sum(amount) as total_amount from (select user_id, spend_date, platform, amount, count(1) over(partition by user_id, spend_date) as cnt from Spending) t group by user_id, spend_date, if(cnt=2, 'both',platform) ) select t1.spend_date, t1.platform, sum(ifnull(total_amount,0)) as total_amount, count(distinct user_id) as total_users from dates_platform t1 left join spending_count t2 on t1.spend_date = t2.spend_date and t1.platform = t2.platform group by t1.spend_date, t1.platform
with full_tb as ( select distinct spend_date, "mobile" as platform from Spending union all select distinct spend_date, "desktop" as platform from Spending union all select distinct spend_date, "both" as platform from Spending ), full_tb2 as ( select spend_date, user_id, (case when count(distinct platform) > 1 then "both" else platform end) as platform, sum(amount) as total_amount_user from Spending group by spend_date, user_id ) select b.spend_date, b.platform, ifnull(sum(total_amount_user),0) as total_amount, count(distinct user_id) as total_users from full_tb2 a right join full_tb b on a.spend_date=b.spend_date and a.platform=b.platform group by spend_date, platform order by spend_date
with header as ( select distinct(spend_date), 'desktop' platform from Spending union all select distinct(spend_date), 'mobile' platform from Spending union all select distinct(spend_date), 'both' platform from Spending ) select h.spend_date, h.platform, ifnull(sum(amount),0) total_amount, count(user_id) as total_users from header h left join ( select spend_date, user_id, case when count(*) = 1 then platform else 'both' end as platform, sum(amount) as amount from Spending s group by spend_date, user_id ) a on h.spend_date = a.spend_date and h.platform = a.platform group by h.spend_date, h.platform
with joined as ( select t1.user_id, t1.spend_date, case when t2.platform is not null then "both" else t1.platform end as plat_form, t1.amount from Spending t1 left join Spending t2 on t1.user_id = t2.user_id and t1.spend_date = t2.spend_date and t1.platform != t2.platform ), date_plat as ( select distinct spend_date, "mobile" as platform from Spending union all select distinct spend_date, "desktop" as platform from Spending union all select distinct spend_date, "both" as platform from Spending ) select t2.spend_date,t2.platform as platform, ifnull(sum(amount),0) as total_amount, ifnull(count(distinct user_id),0) as total_users from joined T1 right join date_plat t2 on t1.spend_date = t2.spend_date and t1.plat_form = t2.platform group by 1,2
with o as ( SELECT spend_date, user_id, SUM(CASE platform WHEN 'mobile' THEN amount ELSE 0 END) mobile_amount, SUM(CASE platform WHEN 'desktop' THEN amount ELSE 0 END) desktop_amount FROM Spending GROUP BY spend_date, user_id ), p as ( SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending ) SELECT p.spend_date, p.platform, IFNULL(SUM(amount), 0) total_amount, COUNT(user_id) total_users FROM p LEFT JOIN ( SELECT spend_date, user_id, IF(mobile_amount > 0, IF(desktop_amount > 0, 'both', 'mobile'), 'desktop') platform, (mobile_amount + desktop_amount) amount FROM o ) t ON p.platform=t.platform AND p.spend_date=t.spend_date GROUP BY spend_date, platform
with pf as ( select 'desktop' as platform union all select 'mobile' union all select 'both' ) , datedim as ( select d.spend_date, pf.platform from ( select distinct spend_date from spending )d cross join pf ) ,prep as ( select user_id ,spend_date ,platform ,amount , count(platform)over(partition by user_id, spend_date)num from spending ) , uniplatform as ( select spend_date ,platform ,sum(amount)total_amount ,count(distinct user_id) total_users from prep where num=1 group by spend_date, platform ) , dualplatform as ( select spend_date ,'both' platform ,sum(amount)total_amount ,count(distinct user_id) total_users from prep where num>1 group by spend_date ) select datedim.spend_date ,datedim.platform , coalesce(u.total_amount, 0) total_amount , coalesce(u.total_users,0) total_users from datedim left outer join ( select spend_date , platform ,total_amount ,total_users from uniplatform union all select spend_date , platform ,total_amount ,total_users from dualplatform ) u on u.spend_date=datedim.spend_date and u.platform=datedim.platform order by 2, 1
with platforms (platform) as ( select * from (values Row('desktop'), Row('mobile'), Row('both')) p ) , platform_count as (select user_id, spend_date, count(distinct platform) as count from Spending group by spend_date, user_id ) , entries (spend_date, platform) as ( select distinct spend_date, platforms.platform from Spending cross join platforms ) , results as (select spend_date, platform, sum(amount) as total_amount, count(user_id) as total_users from platform_count natural join Spending where count = 1 group by spend_date, platform union all select spend_date, 'both' as platform, sum(amount) as total_amount, count(distinct user_id) as total_users from platform_count natural join Spending where count = 2 group by spend_date ) select spend_date, platform, ifnull(total_amount, 0) as total_amount, ifnull(total_users, 0) as total_users from entries natural left join results order by spend_date
with platformsTable as( select distinct platform as platform from Spending union select 'both' as platform), datesTable as( select distinct spend_date from Spending), formattedTable as(select * from datesTable,platformsTable), summaryTable as(select s1.user_id,s1.spend_date,s1.platform,count(*) as counts,SUM(s1.amount) as amount from Spending s1,Spending s2 where s1.user_id=s2.user_id and s1.spend_date=s2.spend_date group by 1,2), summaryTable2 as(select spend_date,case when counts=1 then platform else "both" end as platform2,case when counts=1 then amount else amount/2 end as amount2 from summaryTable) select f1.spend_date,f1.platform,sum(coalesce(amount2,0)) as total_amount,count(s1.spend_date) as total_users from formattedTable f1 left join summaryTable2 s1 on f1.spend_date=s1.spend_date and f1.platform=s1.platform2 group by 1,2
with platforms_per_user as ( select user_id, spend_date, count(1) as total_platforms from spending group by 1,2 ), all_combos as ( select spend_date, platform from ( select 'mobile' as platform union all select 'desktop' as platform union all select 'both' as platform ) f cross join ( select distinct spend_date from spending ) g ) select a.spend_date, a.platform, coalesce(total_amount, 0) as total_amount, coalesce(total_users, 0) as total_users from all_combos a left join ( select s.spend_date, if(total_platforms = 2, 'both', platform) as platform, sum(amount) as total_amount, count(distinct s.user_id) as total_users from spending s join platforms_per_user p on p.user_id = s.user_id and p.spend_date = s.spend_date group by 1, 2 ) g on a.spend_date = g.spend_date and a.platform = g.platform
with res as (select user_id, spend_date, case when count(platform) > 1 then 'both' else platform end as platform, sum(amount) as amount from Spending group by user_id,spend_date), comb as( select distinct(spend_date), 'desktop' as platform from Spending union select distinct(spend_date), 'mobile' as platform from Spending union select distinct(spend_date), 'both' as platform from Spending ) select comb.spend_date,comb.platform, ifnull(sum(amount),0) as total_amount, count(user_id) as total_users from comb left join res on comb.spend_date = res.spend_date and comb.platform = res.platform group by 1,2
with t as ( select *, count(platform) over(partition by spend_date, user_id) as type from spending ) select spend_date, 'both' as platform, sum(case when type=2 then amount else 0 end) as total_amount, count(distinct(case when type=2 then user_id else null end)) as total_users from t group by spend_date union select spend_date, 'mobile' as platform, sum(case when type=1 and platform='mobile' then amount else 0 end) as total_amount, count(case when type=1 and platform='mobile'then user_id else null end) as total_users from t group by spend_date union select spend_date, 'desktop' as platform, sum(case when type=1 and platform='desktop' then amount else 0 end) as total_amount, count(case when type=1 and platform='desktop'then user_id else null end) as total_users from t group by spend_date
with t as ( select user_id,spend_date,amount, case when platform = 'mobile' then 1 else 0 end as mobile, case when platform = 'desktop' then 1 else 0 end as desktop from spending ), t1 as ( select user_id, spend_date, SUM(amount) as amount, case when sum(mobile) >= 1 and sum(desktop) >= 1 then 'both' when sum(mobile) >= 1 and sum(desktop) < 1 then 'mobile' when sum(mobile) < 1 and sum(desktop) >= 1 then 'desktop' end as platform from t group by 1,2 ), p as ( select distinct spend_date,'mobile' as platform from t1 union all select distinct spend_date,'both' as platform from t1 union all select distinct spend_date,'desktop' as platform from t1 ) select sds.spend_date, sds.platform, coalesce(sum(amount),0) as total_amount, count(user_id) as total_users from t1 right join p sds on t1.spend_date = sds.spend_date and sds.platform = t1.platform group by 1,2 order by 1,2
with t as (select distinct(spend_date),"desktop" as platform from spending union select distinct(spend_date),"mobile" as platform from spending union select distinct(spend_date),"both" as platform from spending) select t.spend_date,t.platform, ifnull(sum(total_amount),0) as total_amount, ifnull(count(distinct user_id),0) as total_users from t left join ( select user_id,spend_date, if(mobile>0,if(desktop>0,"both","mobile"),"desktop") as platform, (mobile+desktop) as total_amount from ( select user_id, spend_date, sum(case when platform = "mobile" then amount else 0 end) as mobile, sum(case when platform = "desktop" then amount else 0 end) as desktop from spending group by 1,2) t1)t3 on t.platform = t3.platform and t.spend_date = t3.spend_date group by t.spend_date,t.platform
with t as (select user_id , spend_date, sum(case when platform = 'mobile' then amount else 0 end )as 'mobile', sum(case when platform = 'desktop' then amount else 0 end) as 'desktop' from Spending group by user_id, spend_date), sp as ( select distinct spend_date ,'mobile' as platform from spending union all select distinct spend_date, 'desktop' as platform from spending union all select distinct spend_date, 'both' as platform from spending), t2 as (select user_id, spend_date, if(mobile >0, if(desktop >0, 'both','mobile'),'desktop') as 'platform', mobile + desktop as amount from t) select sp.spend_date, sp.platform, ifnull(sum(amount),0) as total_amount, count(distinct user_id) as total_users from sp left join t2 on sp.spend_date = t2.spend_date and sp.platform = t2.platform group by sp.spend_date, sp.platform
with t1 as ( SELECT spend_date, platform, COUNT(DISTINCT user_id) As total_users, SUM(amount) As total_amount FROM ( SELECT user_id, spend_date, SUM(amount) As amount, CASE WHEN COUNT(DISTINCT platform) = 1 THEN platform ELSE 'both' END AS platform FROM Spending GROUP BY user_id, spend_date) As t0 GROUP BY spend_date, platform), t2 as ( SELECT DISTINCT(spend_date), 'desktop' As platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' As platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' As platform FROM Spending) SELECT t2.*, IFNULL(t1.total_amount,0) AS total_amount, IFNULL(t1.total_users,0) AS total_users FROM t2 LEFT JOIN t1 ON t2.platform = t1.platform AND t2.spend_date = t1.spend_date
with t1 as ( select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'desktop' as platform from Spending union select distinct spend_date,'both' as platform from Spending ), t2 as( SELECT user_id,spend_date, if(count(distinct platform) = 2,'both',platform) AS platform, sum(amount) AS amount FROM Spending GROUP BY spend_date, user_id) select t1.*,ifnull(sum(amount),0) as total_amount, count(distinct user_id) as total_users from t1 left join t2 using(spend_date,platform) group by 1,2
with t1 as ( select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'desktop' as platform from Spending union select distinct spend_date,'both' as platform from Spending ), t2 as( SELECT user_id,spend_date, if(count(distinct platform) = 2,'both',platform) AS platform, sum(amount) AS amount FROM Spending GROUP BY spend_date, user_id) select t1.*,ifnull(sum(amount),0) as total_amount, count(user_id) as total_users from t1 left join t2 using(spend_date,platform) group by 1,2
with t1 as ( select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'desktop' as platform from Spending union select distinct spend_date,'both' as platform from Spending ), t2 as( SELECT user_id,spend_date, if(count(distinct platform) = 2,'both',platform) AS platform, sum(amount) AS amount FROM Spending GROUP BY spend_date, user_id) select t1.*,ifnull(sum(t2.amount),0) as total_amount, count(user_id) as total_users from t1 left join t2 using(spend_date,platform) group by 1,2
with t1 as ( select distinct spend_date,'mobile' as platform from Spending union select distinct spend_date,'desktop' as platform from Spending union select distinct spend_date,'both' as platform from Spending ), t2 as( SELECT user_id,spend_date, if(count(distinct platform) = 2,'both',platform) AS platform, sum(amount) AS amount FROM Spending GROUP BY spend_date, user_id) select t1.*,ifnull(sum(t2.amount),0) as total_amount, count(user_id) as total_users from t1 left join t2 using(spend_date,platform) group by 1,2 order by spend_date
with t1 as (select user_id, spend_date, (case when count(distinct platform) > 1 then "both" else platform end) as platform, sum(amount) as total_amount_user from spending group by 1,2), t3 as ( select distinct spend_date, "mobile" as platform from Spending union all select distinct spend_date, "desktop" as platform from Spending union all select distinct spend_date, "both" as platform from Spending ) select t3.spend_date, t3.platform, ifnull(sum(total_amount_user),0) as total_amount, count(distinct user_id) as total_users from t1 right join t3 on t1.spend_date=t3.spend_date and t1.platform=t3.platform group by 1,2 order by 2
with t1 as (select user_id, spend_date, (case when count(distinct platform) > 1 then 'both' else platform end) as platform, sum(amount) as total_amount from spending group by 1,2), t2 as (select distinct spend_date, 'desktop' as platform from spending union all select distinct spend_date, 'mobile' as platform from spending union all select distinct spend_date, 'both' as platform from spending) select t2.*, sum(ifnull(total_amount,0)) as total_amount, count(distinct user_id) as total_users from t2 left join t1 on t2.spend_date = t1.spend_date and t1.platform = t2.platform group by 1,2 order by 1,2
with t1 as( select null as user_id, spend_date, platform, 0 as amount from (select distinct spend_date from Spending)t1 join (select * from( select 'mobile' as platform union select 'desktop' as platform union select 'both' as platform)t2)t3), t2 as( select *, count(platform) over (partition by spend_date, user_id) as cnt from Spending), t3 as( select user_id, spend_date, platform, amount from t2 where cnt=1 and platform = 'mobile' union select user_id, spend_date, platform, amount from t2 where cnt=1 and platform = 'desktop' union select user_id, spend_date, 'both' as platform, sum(amount) from t2 where cnt=2 group by user_id, spend_date union select * from t1 ) select spend_date, platform, sum(amount) as total_amount, count(user_id) as total_users from t3 group by spend_date, platform
with tab1 as (select user_id, spend_date, 'both' as platform, sum(amount) as amount from spending group by 1,2 having count(*) >1 union select user_id, spend_date, platform, sum(amount) as amount from spending group by 1,2 having count(*) =1) , table_date as (SELECT DISTINCT(spend_date), 'desktop' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'mobile' platform FROM Spending UNION SELECT DISTINCT(spend_date), 'both' platform FROM Spending) , table_usedate as ( select spend_date,platform, sum(amount) as total_amount, count(*) as total_users from tab1 group by 1,2 ) select t.spend_date,t.platform, ifnull(tu.total_amount,0) as total_amount, ifnull(tu.total_users,0) as total_users from table_date t left join table_usedate as tu on t.spend_date=tu.spend_date and t.platform=tu.platform order by spend_date
with tab_user_day_platform as ( select user_id, spend_date, platform from spending group by user_id, spend_date having count(distinct platform) = 1 union select user_id, spend_date, 'both' from spending group by user_id, spend_date having count(distinct platform) > 1 ), template_tab as ( select * from (select distinct spend_date from spending ) as a join ( select 'mobile' as platform union select 'desktop' as platform union select 'both' as platform) as b ), tab_prep as (select t.spend_date, t.platform, sum(amount) as total_amount, count(distinct t.user_id) as total_users from tab_user_day_platform as t join spending on t.user_id = spending.user_id and t.spend_date = spending.spend_date group by t.spend_date, t.platform) select template_tab.spend_date, template_tab.platform, ifnull(tab_prep.total_amount, 0) as total_amount, ifnull(tab_prep.total_users, 0) as total_users from template_tab left join tab_prep on template_tab.spend_date = tab_prep.spend_date and template_tab.platform = tab_prep.platform
with tbAll as ( select user_id, spend_date, sum(amount) as amount, case when sum(platform = "mobile")=0 then 1 else 0 end as desktop, case when sum(platform = "desktop")=0 then 1 else 0 end as mobile, case when sum(platform = "mobile")=0 or sum(platform = "desktop")=0 then 0 else 1 end as "both" from spending group by user_id, spend_date ) select spend_date, "mobile" as platform, sum(amount * mobile) as total_amount, sum(mobile) as total_users from tbAll group by 1 union all select spend_date, "desktop" as platform, sum(amount * desktop) as total_amount, sum(desktop) as total_users from tbAll group by 1 union all select spend_date, "both" as platform, sum(amount * `both`) as total_amount, sum(`both`) as total_users from tbAll group by 1
with tem as ( select user_id, spend_date, sum(case when platform = 'desktop' then amount else 0 end) as da, sum(case when platform = 'mobile' then amount else 0 end) as ma from spending group by user_id, spend_date ) select spend_date, 'desktop' as platform, sum(case when da > 0 and ma = 0 then da else 0 end) as total_amount, sum(case when da > 0 and ma = 0 then 1 else 0 end) as total_users from tem group by spend_date union all select spend_date, 'mobile' as platform, sum(case when ma > 0 and da = 0 then ma else 0 end) as total_amount, sum(case when ma > 0 and da = 0 then 1 else 0 end) as total_users from tem group by spend_date union all select spend_date, 'both' as platform, sum(case when ma > 0 and da > 0 then ma+da else 0 end) as total_amount, sum(case when ma > 0 and da > 0 then 1 else 0 end) as total_users from tem group by spend_date
with temp as ( select s1.spend_date , s1.user_id , s2.amount , case when num_p=2 then "both" when num_p=1 then s2.platform end as platform from( (select *, count(distinct platform) as num_p from spending group by spend_date, user_id) as s1 right join spending as s2 on s1.spend_date=s2.spend_date and s1.user_id=s2.user_id)) select t2.spend_date , t2.platform , if(t1.total_amount is null, 0, t1.total_amount) as total_amount , if(t1.total_users is null, 0, t1.total_users) as total_users from ( select spend_date , platform , sum(amount) as total_amount , count(distinct user_id) as total_users from temp group by spend_date, platform order by platform, spend_date) as t1 right join ( select distinct(spend_date), 'desktop' platform from Spending union select distinct(spend_date), 'mobile' platform from Spending union select distinct(spend_date), 'both' platform from Spending) as t2 on t1.spend_date = t2.spend_date and t1.platform = t2.platform
with temp as (select *, count(user_id) over(partition by spend_date, user_id) as type from spending ) select spend_date, "both" as platform, sum(case when type = 2 then amount else 0 end) as total_amount, count(distinct case when type = 2 then user_id else null end) as total_users from temp group by spend_date union (select spend_date, "desktop" as platform, sum(case when type = 1 and platform = "desktop" then amount else 0 end) as total_amount, count(distinct case when type = 1 and platform = "desktop" then user_id else null end) as total_users from temp group by spend_date) union (select spend_date, "mobile" as platform, sum(case when type = 1 and platform = "mobile" then amount else 0 end) as total_amount, count(distinct case when type = 1 and platform = "mobile" then user_id else null end) as total_users from temp group by spend_date)
with temp1 as( select user_id, spend_date, platform, sum(amount) as amount from spending group by 1,2,3), a as( select spend_date, count(distinct user_id)as total_users, sum(amount) as total_amount from( select spend_date, user_id, sum(amount) as amount from temp1 group by 1, 2 having count(platform)>=2) as temp1 group by spend_date), b as( select distinct spend_date from spending order by spend_date), sale_both as( select b.spend_date, 'both' as platform, ifnull(a.total_amount,0) as total_amount, ifnull(a.total_users,0) as total_users from b left join a on b.spend_date=a.spend_date), temp2 as( select spend_date, platform, sum(amount) as total_amount, count(distinct user_id) as total_users from( select user_id, spend_date, platform, sum(amount) as amount from temp1 group by 1, 2 having count(platform)=1) as temp2 where platform='mobile' group by 1,2), sale_mobile as( select b.spend_date, 'mobile' as platform, ifnull(temp2.total_amount,0) as total_amount, ifnull(temp2.total_users,0) as total_users from b left join temp2 on b.spend_date=temp2.spend_date), temp3 as( select spend_date, platform, sum(amount) as total_amount, count(distinct user_id) as total_users from( select user_id, spend_date, platform, sum(amount) as amount from temp1 group by 1, 2 having count(platform)=1) as temp2 where platform='desktop' group by 1,2), sale_desktop as( select b.spend_date, 'desktop' as platform, ifnull(temp3.total_amount,0) as total_amount, ifnull(temp3.total_users,0) as total_users from b left join temp3 on b.spend_date=temp3.spend_date) select * from sale_both union all select * from sale_mobile union all select * from sale_desktop order by 1
with temp_table as ( SELECT spend_date FROM Spending GROUP BY spend_date ) SELECT t3.spend_date, t3.platform, COALESCE(total_amount, 0) total_amount, COALESCE(total_users, 0) total_users FROM ( SELECT spend_date, 'mobile' platform FROM temp_table union SELECT spend_date, 'desktop' platform FROM temp_table union SELECT spend_date, 'both' platform FROM temp_table ) t3 left outer join ( SELECT spend_date, CASE WHEN use_mobile=1 and use_desktop=1 THEN 'both' WHEN use_mobile=1 THEN 'mobile' ELSE 'desktop' END platform, sum(amount) total_amount, count(distinct USER_id) total_users FROM ( SELECT spend_date, USER_id, sum(Case when platform='mobile' THEN 1 else 0 end) use_mobile, sum(case when platform='desktop' THEN 1 else 0 end) use_desktop, sum(amount) amount FROM Spending group by spend_date, USER_id ) t1 group by spend_date, CASE WHEN use_mobile=1 and use_desktop=1 THEN 'both' WHEN use_mobile=1 THEN 'mobile' ELSE 'desktop' END ) t2 on t3.spend_date=t2.spend_date and t3.platform = t2.platform ORDER BY total_amount, platform
with tmp as ( select spend_date, platform from (select distinct spend_date from Spending) t1 cross join (select distinct platform from Spending union all select "both" as platform) t2 ) select tmp.spend_date, tmp.platform, sum(ifnull(amount, 0)) as total_amount, ifnull(count(distinct user_id), 0) as total_users from (select spend_date, user_id, case when count(platform) = 1 then platform when count(platform) = 2 then "both" end as platform, sum(amount) as amount from Spending group by spend_date, user_id) t right join tmp on tmp.spend_date = t.spend_date and tmp.platform = t.platform group by spend_date, platform
with tmp as ( select user_id, spend_date, amount, sum(if(platform='mobile',1,0)) over(partition by user_id, spend_date) as mobile, sum(if(platform='desktop',1,0)) over(partition by user_id, spend_date) as desktop from spending ), tmp2 as ( select *, case when mobile = 1 and desktop = 1 then 'both' when mobile = 1 and desktop = 0 then 'mobile' else 'desktop' end as platform from tmp ),spine as ( select distinct tmp2.spend_date, tmp3.platform from tmp2, ( select 'desktop' as platform union select 'mobile' union select 'both' ) as tmp3 ) select spine.spend_date, spine.platform, ifnull(sum(amount),0) as total_amount, count(distinct user_id) as total_users from spine left join tmp2 on spine.spend_date = tmp2.spend_date and spine.platform = tmp2.platform group by spine.spend_date, spine.platform
with tmp as (select spend_date, user_id, min(platform) as platform, count(platform) as cnt, sum(amount) as amount from spending group by spend_date, user_id), dates as (select distinct spend_date from spending) select dates.spend_date, 'both' as platform, sum(ifnull(amount, 0)) as total_amount, count(user_id) as total_users from dates left join tmp on dates.spend_date = tmp.spend_date and cnt = 2 group by dates.spend_date union select dates.spend_date, 'desktop' as platform, sum(ifnull(amount, 0)) as total_amount, count(user_id) as total_users from dates left join tmp on dates.spend_date = tmp.spend_date and platform = 'desktop' and cnt = 1 group by dates.spend_date union select dates.spend_date, 'mobile' as platform, sum(ifnull(amount, 0)) as total_amount, count(user_id) as total_users from dates left join tmp on dates.spend_date = tmp.spend_date and platform = 'mobile' and cnt = 1 group by dates.spend_date
with tmp as( select user_id, spend_date, sum(amount) as amount from spending group by user_id, spend_date having count(*) > 1 ), tmp2 as( select spend_date, platform, sum(amount) as total_amount, count(user_id) as total_users from spending where (user_id, spend_date) not in (select user_id, spend_date from tmp) group by spend_date, platform union select spend_date, 'both' as platform, sum(amount) as total_amount, count(user_id) as total_users from tmp group by spend_date ), tmp3 as ( select * from (select distinct spend_date from spending) a, (select distinct platform from spending union select 'both' as platform) b ) select spend_date, platform, ifnull(total_amount, 0) as total_amount, ifnull(total_users, 0) as total_users from tmp3 natural left join tmp2
with user_platform as ( select user_id, spend_date, case when count(distinct platform) = 2 then 'both' else platform end as platform_new, sum(amount) as amount from Spending group by 1,2 ), report_platform as ( select distinct spend_date, 'desktop' as platform from Spending union select distinct spend_date, 'mobile' as platform from Spending union select distinct spend_date, 'both' as platform from Spending ) select report_platform.spend_date as spend_date, report_platform.platform as platform, coalesce(sum(amount),0) as total_amount, coalesce(count(distinct user_id),0) as total_users from report_platform left join user_platform on report_platform.platform = user_platform.platform_new and report_platform.spend_date = user_platform.spend_date group by 1,2
with wrapper as ( select distinct spend_date, "mobile" as platform from spending union select distinct spend_date, 'desktop' as platform from spending union select distinct spend_date, 'both' as platform from spending order by 1 ), user_counts as ( select distinct *, count(*) over (partition by spend_date, user_id)n_users from spending ), platform_both_ as ( select spend_date, 'both' as platform, sum(amount)total_amount ,count(distinct user_id) as total_users from user_counts where n_users = 2 group by 1 ), platform_singles as ( select spend_date, platform, sum(amount)total_amount, count(distinct user_id) as total_users from user_counts where n_users = 1 group by 1,2 ) select w.spend_date, w.platform, ifnull(u.total_amount,0)total_amount, ifnull(u.total_users,0) total_users from wrapper w left join (select * from platform_both_ union select * from platform_singles)u on w.spend_date = u.spend_date and w.platform = u.platform;
with x as ( select user_id, spend_date, sum(case when platform = 'mobile' then amount else 0 end) as mobile_amount, sum(case when platform = 'desktop' then amount else 0 end) as desktop_amount from spending group by user_id, spend_date ) select * from ( select spend_date, 'mobile' as platform, sum(case when mobile_amount > 0 and desktop_amount = 0 then mobile_amount else 0 end) as total_amount, sum(case when mobile_amount > 0 and desktop_amount = 0 then 1 else 0 end) as total_users from x group by spend_date union select spend_date, 'desktop' as platform, sum(case when mobile_amount = 0 and desktop_amount > 0 then desktop_amount else 0 end) as total_amount, sum(case when mobile_amount = 0 and desktop_amount > 0 then 1 else 0 end) as total_users from x group by spend_date union select spend_date, 'both' as platform, sum(case when mobile_amount > 0 and desktop_amount > 0 then mobile_amount+desktop_amount else 0 end) as total_amount, sum(case when mobile_amount > 0 and desktop_amount > 0 then 1 else 0 end) as total_users from x group by spend_date ) a
with x as ( select user_id, spend_date, sum(case when platform = 'mobile' then amount else 0 end) as mobile_amount, sum(case when platform = 'desktop' then amount else 0 end) as desktop_amount from spending group by user_id, spend_date ) select * from ( select spend_date, 'mobile' as platform, sum(case when mobile_amount > 0 and desktop_amount = 0 then mobile_amount else 0 end) as total_amount, sum(case when mobile_amount > 0 and desktop_amount = 0 then 1 else 0 end) as total_users from x group by spend_date union select spend_date, 'desktop' as platform, sum(case when mobile_amount = 0 and desktop_amount > 0 then desktop_amount else 0 end) as total_amount, sum(case when mobile_amount = 0 and desktop_amount > 0 then 1 else 0 end) as total_users from x group by spend_date union select spend_date, 'both' as platform, sum(case when mobile_amount > 0 and desktop_amount > 0 then mobile_amount+desktop_amount else 0 end) as total_amount, sum(case when mobile_amount > 0 and desktop_amount > 0 then 1 else 0 end) as total_users from x group by spend_date ) a order by spend_date, case when platform = 'desktop' then 1 when platform = 'mobile' then 2 else 3 end
